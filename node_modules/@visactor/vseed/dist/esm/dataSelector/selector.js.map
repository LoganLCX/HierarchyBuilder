{"version":3,"file":"dataSelector/selector.js","sources":["../../../src/dataSelector/selector.ts"],"sourcesContent":["import type { Datum } from 'src/types'\nimport type {\n  DimensionSelector,\n  MeasureSelector,\n  PartialDatumSelector,\n  Selector,\n  Selectors,\n  ValueSelector,\n} from '../types/dataSelector'\nimport { omit } from 'remeda'\n\n/**\n * 判断两个数字是否“近似相等”\n */\nfunction nearlyEqual(a: number, b: number, epsilon = 1e-8) {\n  // NaN 直接不相等\n  if (Number.isNaN(a) || Number.isNaN(b)) return false\n  // 引用同一个数 或 完全相等\n  if (a === b) return true\n  const diff = Math.abs(a - b)\n  return diff <= epsilon\n}\n\nexport const selector = (\n  vchartDatum: Datum,\n  selector: Selector | Selectors | undefined | null,\n  selectorMode: 'And' | 'Or' = 'And',\n) => {\n  // 无有效选择器, 则认为全部匹配成功\n  if (!selector) {\n    return true\n  }\n\n  // 过滤掉 vchart 相关字段\n  const vchartKeys = Object.keys(vchartDatum).filter((k) => k.toLocaleLowerCase().startsWith('__vchart'))\n  const datum = omit(vchartDatum, vchartKeys) as Datum\n\n  // 统一处理选择器为数组\n  const selectors = (Array.isArray(selector) ? selector : [selector]) as Selectors\n\n  return selectors[selectorMode === 'And' ? 'every' : 'some']((selector) => {\n    // 1. 字符串或数字\n    if (isValueSelector(selector)) {\n      return selectByValue(selector, datum)\n    }\n\n    // 2. 指标选择器\n    else if (isMeasureSelector(selector)) {\n      return selectByMeasure(selector, datum)\n    }\n    // 3. 维度选择器\n    else if (isDimensionSelector(selector)) {\n      return selectByDmension(selector, datum)\n    }\n    // 4. 部分数据对象选择器\n    else if (isPartialDatumSelector(selector)) {\n      return selectByPartial(selector, datum)\n    }\n\n    return false\n  })\n}\n\nexport const selectorDatum = (datum: Datum, selector: Selector | Selectors | undefined | null): Datum[] => {\n  // 无有效选择器, 则认为全部匹配成功\n  if (!selector) {\n    return []\n  }\n\n  // 统一处理选择器为数组\n  const selectors = (Array.isArray(selector) ? selector : [selector]) as Selectors\n  let finalResult: Datum[] = []\n\n  for (const selector of selectors) {\n    const results: Datum[] = []\n    // 1. 字符串或数字\n    if (isValueSelector(selector)) {\n      Object.entries(datum).forEach(([key, value]) => {\n        if (value === selector) {\n          results.push({ [key]: value } as Datum)\n        }\n      })\n    } else if (isMeasureSelector(selector) && selectByMeasure(selector, datum)) {\n      results.push({ [selector.field]: datum[selector.field] } as Datum)\n    } else if (isDimensionSelector(selector) && selectByDmension(selector, datum)) {\n      results.push({ [selector.field]: datum[selector.field] } as Datum)\n    } else if (isPartialDatumSelector(selector) && selectByPartial(selector, datum)) {\n      results.push(selector)\n    }\n\n    if (results.length) {\n      if (finalResult.length) {\n        finalResult = finalResult.flatMap((prev) => {\n          return results.map((r) => {\n            return {\n              ...prev,\n              ...r,\n            }\n          })\n        })\n      } else {\n        finalResult = results\n      }\n    } else {\n      finalResult = []\n      break\n    }\n  }\n\n  return finalResult\n}\n\nexport const isValueSelector = (selector: Selector): selector is ValueSelector => {\n  return typeof selector === 'string' || typeof selector === 'number'\n}\n\nexport const isPartialDatumSelector = (selector: Selector): selector is PartialDatumSelector => {\n  return typeof selector === 'object' && selector !== null\n}\n\nexport const isMeasureSelector = (selector: Selector): selector is MeasureSelector => {\n  return (\n    typeof selector === 'object' &&\n    selector !== null &&\n    'field' in selector &&\n    ('operator' in selector || 'op' in selector) &&\n    'value' in selector &&\n    (['=', '==', '!=', '>', '<', '>=', '<=', 'between'].includes(selector.operator as string) ||\n      ['=', '==', '!=', '>', '<', '>=', '<=', 'between'].includes(selector.op as string))\n  )\n}\n\nexport const isDimensionSelector = (selector: Selector): selector is DimensionSelector => {\n  return (\n    typeof selector === 'object' &&\n    selector !== null &&\n    'field' in selector &&\n    ('operator' in selector || 'op' in selector) &&\n    'value' in selector &&\n    (['in', 'not in'].includes(selector.operator as string) || ['in', 'not in'].includes(selector.op as string))\n  )\n}\n\nexport const selectByMeasure = (selector: MeasureSelector, datum: Datum) => {\n  const op = selector.operator || selector.op\n  const selectorValueArr = Array.isArray(selector.value) ? selector.value : [selector.value]\n\n  switch (op) {\n    case '=':\n      if (\n        String(datum[selector.field]) === String(selectorValueArr[0]) ||\n        nearlyEqual(Number(datum[selector.field]), Number(selectorValueArr[0]))\n      ) {\n        return true\n      }\n      break\n    case '==':\n      if (datum[selector.field] === selectorValueArr[0]) {\n        return true\n      }\n      break\n    case '!=':\n      if (datum[selector.field] !== selectorValueArr[0]) {\n        return true\n      }\n      break\n    case '>':\n      if (\n        datum[selector.field] > selectorValueArr[0] &&\n        !nearlyEqual(Number(datum[selector.field]), Number(selectorValueArr[0]))\n      ) {\n        return true\n      }\n      break\n    case '<':\n      if (\n        datum[selector.field] < selectorValueArr[0] &&\n        !nearlyEqual(Number(datum[selector.field]), Number(selectorValueArr[0]))\n      ) {\n        return true\n      }\n      break\n    case '>=':\n      if (\n        datum[selector.field] >= selectorValueArr[0] ||\n        nearlyEqual(Number(datum[selector.field]), Number(selectorValueArr[0]))\n      ) {\n        return true\n      }\n      break\n    case '<=':\n      if (\n        datum[selector.field] <= selectorValueArr[0] ||\n        nearlyEqual(Number(datum[selector.field]), Number(selectorValueArr[0]))\n      ) {\n        return true\n      }\n      break\n    case 'between':\n      if (\n        Array.isArray(selector.value) &&\n        (datum[selector.field] >= selectorValueArr[0] ||\n          nearlyEqual(Number(datum[selector.field]), Number(selectorValueArr[0]))) &&\n        (datum[selector.field] <= selectorValueArr[1] ||\n          nearlyEqual(Number(datum[selector.field]), Number(selectorValueArr[1])))\n      ) {\n        return true\n      }\n      break\n  }\n  return false\n}\n\nexport const selectByDmension = (selector: DimensionSelector, datum: Datum) => {\n  const op = selector.operator || selector.op\n  const selectorValueArr = Array.isArray(selector.value) ? selector.value : [selector.value]\n  switch (op) {\n    case 'in':\n      if (selectorValueArr.includes(datum[selector.field] as string | number)) {\n        return true\n      }\n      break\n    case 'not in':\n      if (!selectorValueArr.includes(datum[selector.field] as string | number)) {\n        return true\n      }\n      break\n  }\n\n  return false\n}\n\nexport const selectByPartial = (selector: PartialDatumSelector, datum: Datum) => {\n  return Object.keys(selector).every((key) => datum[key] === selector[key])\n}\n\nexport const selectByValue = (selector: ValueSelector, datum: Datum) => {\n  return Object.values(datum).some((v) => v === selector)\n}\n"],"names":["nearlyEqual","a","b","epsilon","Number","diff","Math","selector","vchartDatum","selectorMode","vchartKeys","Object","k","datum","omit","selectors","Array","isValueSelector","selectByValue","isMeasureSelector","selectByMeasure","isDimensionSelector","selectByDmension","isPartialDatumSelector","selectByPartial","selectorDatum","finalResult","results","key","value","prev","r","op","selectorValueArr","String","v"],"mappings":"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"}