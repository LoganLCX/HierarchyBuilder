{"version":3,"file":"pipeline/spec/chart/pipes/regressionLine/kdeRegressionLine.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/regressionLine/kdeRegressionLine.ts"],"sourcesContent":["import type { ICartesianSeries, IChart, IHistogramChartSpec, IVChart } from '@visactor/vchart'\nimport type { KDEOptions } from '@visactor/vutils'\nimport { isNullish, uniqueBy } from 'remeda'\nimport { kde, array } from '@visactor/vutils'\nimport { BinEndMeasureId, BinStartMeasureId } from 'src/dataReshape'\nimport type { Datum, Dimension, VChartSpecPipe, Encoding, RegressionLineConfig, KdeRegressionLine } from 'src/types'\nimport { defaultRegressionLineColor, defaultRegressionLineLabelX, defaultRegressionLineLabelY } from './common'\n\nexport const kdeRegressionLine: VChartSpecPipe = (spec, context) => {\n  const result = { ...spec } as IHistogramChartSpec\n  const { advancedVSeed, vseed } = context\n  const { chartType, encoding = {} as Encoding, dimensions, regressionLine } = advancedVSeed\n  const { dataset } = vseed\n  const lineTheme = advancedVSeed.config[chartType as 'histogram']?.regressionLine as RegressionLineConfig\n  const binValueType = advancedVSeed.config[chartType as 'histogram']?.binValueType\n\n  if (!regressionLine || !regressionLine.kdeRegressionLine) {\n    return result\n  }\n\n  const rowColumnFields = uniqueBy(\n    dimensions.filter((dim: Dimension) => dim.encoding === 'row' || dim.encoding === 'column'),\n    (item: Dimension) => item.id,\n  )\n\n  const lineList = array(regressionLine.kdeRegressionLine).filter((kdeLine) => kdeLine.enable !== false)\n\n  if (!result.extensionMark) {\n    result.extensionMark = []\n  }\n\n  lineList.forEach((line, lineIndex) => {\n    if (line.enable === false) {\n      return\n    }\n    const theme = (lineTheme.kdeRegressionLine ?? {}) as KdeRegressionLine\n    const { color, lineWidth, lineDash, text, textColor, textFontSize, textFontWeight } = line as KdeRegressionLine\n\n    const childrenMarks: any[] = []\n\n    ;(result.extensionMark as any[]).push({\n      type: 'group',\n      interactive: false,\n      zIndex: 500,\n      name: `kdeRegressionLine-${lineIndex}`,\n      dataId: (spec.data as any)?.id,\n      style: {\n        data: (datum: any, ctx: any) => {\n          const vchart = ctx.vchart as IVChart\n          const chart = vchart.getChart() as IChart\n          const series = chart.getAllSeries().filter((s: any) => s.type === 'bar')\n\n          // 直方图使用的是bar系列\n          if (series && series.length) {\n            const s = series[0] as ICartesianSeries\n\n            const fieldX = s.fieldX?.[0]\n            const scaleY = s.getYAxisHelper().getScale?.(0)\n            const viewData = s.getViewData()?.latestData\n\n            if (!dataset || !dataset.length || !viewData || !viewData.length || !scaleY) {\n              return null\n            }\n            const simpleData = dataset\n              .filter((entry: Datum) => {\n                return rowColumnFields.length\n                  ? rowColumnFields.every((dim: Dimension) => {\n                      return entry[dim.id] === viewData[0][dim.id]\n                    })\n                  : true\n              })\n              .map((d: Datum) => +(d as any)[encoding.value?.[0] as string])\n            const res = kde(simpleData, {\n              bandwidth: Math.abs(viewData[0][BinEndMeasureId] - viewData[0][BinStartMeasureId]),\n            } as KDEOptions)\n            const N = Math.max(3, Math.floor(simpleData.length / 4))\n            const lineData = res.evaluateGrid(N)\n\n            // 根据 binValueType 决定如何转换 KDE 密度值\n            // - 频次模式 (count): 频次 = 密度 × 样本数 × 带宽\n            // - 百分比模式 (percentage): 百分比 = 密度 × 带宽\n            const scaleR = (k: number) => {\n              if (binValueType === 'percentage') {\n                // 百分比模式：y轴是0-1的百分比，KDE密度值乘以带宽即可\n                return scaleY.scale(k * res.bandwidth)\n              } else {\n                // 频次模式：y轴是实际计数，需要乘以样本数量\n                return scaleY.scale(k * simpleData.length * res.bandwidth)\n              }\n            }\n\n            const linePoints = lineData.map((ld: Datum) => {\n              const d = { [fieldX]: ld.x }\n              return {\n                x: s.dataToPositionX(d)!,\n                y: scaleR(ld.y as number),\n              }\n            })\n\n            return {\n              linePoints,\n              color: color ?? s.getOption().globalScale.getScale('color')?.scale(s.getSeriesKeys()[0]),\n            }\n          }\n          return null\n        },\n      },\n      children: childrenMarks,\n    })\n\n    childrenMarks.push({\n      type: 'line',\n      interactive: false,\n      zIndex: 500,\n      dataId: (spec.data as any)?.id,\n      style: {\n        lineWidth: lineWidth ?? theme.lineWidth,\n        lineDash: lineDash ?? theme.lineDash,\n        stroke: color ?? defaultRegressionLineColor,\n        points: (datum: any, ctx: any, opt: any) => {\n          const parentNode = opt.mark?._product?.parent\n\n          if (parentNode?.attribute?.data) {\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n            return parentNode.attribute.data.linePoints\n          }\n\n          return []\n        },\n      },\n    })\n\n    if (!isNullish(text)) {\n      childrenMarks.push({\n        type: 'text',\n        interactive: false,\n        zIndex: 500,\n        dataId: (spec.data as any)?.id,\n        dataKey: () => {\n          return `kdeRegressionLine-label-${lineIndex}`\n        },\n        style: {\n          textAlign: 'end',\n          fill: textColor ?? theme.textColor,\n          fontSize: textFontSize ?? theme.textFontSize,\n          fontWeight: textFontWeight ?? theme.textFontWeight,\n          text: text,\n          x: defaultRegressionLineLabelX,\n          y: defaultRegressionLineLabelY,\n        },\n      })\n    }\n  })\n\n  return result\n}\n"],"names":["kdeRegressionLine","spec","context","result","advancedVSeed","vseed","chartType","encoding","dimensions","regressionLine","dataset","lineTheme","binValueType","rowColumnFields","uniqueBy","dim","item","lineList","array","kdeLine","line","lineIndex","theme","color","lineWidth","lineDash","text","textColor","textFontSize","textFontWeight","childrenMarks","datum","ctx","vchart","chart","series","s","fieldX","scaleY","viewData","simpleData","entry","d","res","kde","Math","BinEndMeasureId","BinStartMeasureId","N","lineData","scaleR","k","linePoints","ld","defaultRegressionLineColor","opt","parentNode","isNullish","defaultRegressionLineLabelX","defaultRegressionLineLabelY"],"mappings":"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"}