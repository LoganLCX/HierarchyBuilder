{"version":3,"file":"pipeline/spec/chart/pipes/annotation/annotationVerticalLine.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/annotation/annotationVerticalLine.ts"],"sourcesContent":["import type { ILineChartSpec, IMarkLineSpec } from '@visactor/vchart'\nimport { selector } from '../../../../../dataSelector'\nimport type { VChartSpecPipe } from 'src/types'\nimport { isArray, isNumber, isString } from 'remeda'\nimport { ANNOTATION_Z_INDEX } from '../../../../utils/constant'\n\nexport const annotationVerticalLine: VChartSpecPipe = (spec, context) => {\n  const { advancedVSeed, vseed } = context\n  const { annotation, datasetReshapeInfo, config } = advancedVSeed\n\n  const { unfoldInfo, foldInfo } = datasetReshapeInfo[0]\n\n  if (!annotation || !annotation.annotationVerticalLine) {\n    return spec\n  }\n\n  const theme = config?.[vseed.chartType as 'column']?.annotation?.annotationVerticalLine\n  const { annotationVerticalLine } = annotation\n  const annotationVerticalLineList = Array.isArray(annotationVerticalLine)\n    ? annotationVerticalLine\n    : [annotationVerticalLine]\n\n  const positionMap = {\n    outsideStart: 'start',\n    outsideEnd: 'end',\n    outsideMiddle: 'middle',\n    insideStart: 'insideStartTop',\n    insideMiddle: 'insideMiddleTop',\n    insideEnd: 'insideEndTop',\n  }\n  const markLine = annotationVerticalLineList.flatMap((annotationVerticalLine) => {\n    const {\n      selector: selectorPoint,\n      xValue,\n      text = '',\n      textPosition = 'insideEnd',\n      textColor = theme?.textColor ?? '#ffffff',\n      textFontSize = theme?.textFontSize ?? 12,\n      textFontWeight = theme?.textFontWeight ?? 400,\n      textAlign = 'center',\n      textBaseline = 'top',\n\n      lineColor = theme?.lineColor ?? '#212121',\n      lineStyle = theme?.lineStyle ?? 'dashed',\n      lineVisible = theme?.lineStyle ?? true,\n      lineWidth = theme?.lineWidth ?? 1,\n\n      textBackgroundVisible = theme?.textBackgroundVisible ?? true,\n      textBackgroundColor = theme?.textBackgroundColor ?? '#212121',\n      textBackgroundBorderColor = theme?.textBackgroundBorderColor ?? '#212121',\n      textBackgroundBorderRadius = theme?.textBackgroundBorderRadius ?? 4,\n      textBackgroundBorderWidth = theme?.textBackgroundBorderWidth ?? 1,\n      textBackgroundPadding = theme?.textBackgroundPadding ?? 2,\n    } = annotationVerticalLine\n\n    const dataset = advancedVSeed.dataset.flat()\n\n    const generateOneMarkLine = (x: number | string) => ({\n      x,\n      autoRange: true,\n      zIndex: ANNOTATION_Z_INDEX,\n      line: {\n        style: {\n          visible: lineVisible,\n          stroke: lineColor,\n          lineStyle: lineStyle,\n          lineWidth: lineWidth,\n          lineDash: lineStyle === 'dashed' ? [5, 2] : lineStyle === 'dotted' ? [2, 5] : [0],\n        },\n      },\n      label: {\n        confine: true,\n        text: text,\n        position: (positionMap as any)[textPosition || 'insideEnd'],\n        style: {\n          opacity: 0.95,\n          dx: 5,\n          visible: true,\n          stroke: textBackgroundColor,\n          lineWidth: 1,\n          textAlign: textAlign,\n          textBaseline: textBaseline,\n          fill: textColor,\n          fontSize: textFontSize,\n          fontWeight: textFontWeight,\n        },\n        labelBackground: {\n          visible: textBackgroundVisible,\n          padding: textBackgroundPadding,\n          style: {\n            opacity: 0.95,\n            dx: 5,\n            cornerRadius: textBackgroundBorderRadius,\n            fill: textBackgroundColor,\n            fillOpacity: 1,\n            stroke: textBackgroundBorderColor,\n            lineWidth: textBackgroundBorderWidth,\n          },\n        },\n      },\n      startSymbol: {\n        visible: theme?.startSymbolVisible ?? true,\n        symbolType: theme?.startSymbolType ?? 'triangleDown',\n        size: 5 + (lineWidth || 1),\n        style: {\n          dy: -3,\n          fill: lineColor,\n        },\n      },\n      endSymbol: {\n        visible: theme?.endSymbolVisible ?? false,\n        symbolType: theme?.endSymbolType ?? 'arrow',\n        size: 10 + (lineWidth || 1),\n        style: {\n          dy: 4,\n          fill: lineColor,\n        },\n      },\n    })\n\n    if ((!selectorPoint && isArray(xValue)) || isString(xValue) || isNumber(xValue)) {\n      const xValueArr = Array.isArray(xValue) ? xValue : [xValue]\n      return xValueArr.map(generateOneMarkLine)\n    }\n\n    const selectedData = selectorPoint ? dataset.filter((datum) => selector(datum, selectorPoint)) : []\n\n    return selectedData.map((datum) => {\n      if (datum[unfoldInfo.encodingX]) {\n        return generateOneMarkLine(datum[unfoldInfo.encodingX] as string)\n      }\n      if (datum[foldInfo.measureValue]) {\n        return generateOneMarkLine(datum[foldInfo.measureValue] as string)\n      }\n      return {}\n    })\n  }) as IMarkLineSpec[]\n\n  const specMarkLine = ((spec as ILineChartSpec).markLine as IMarkLineSpec[]) || []\n  const newMarkLine = [...specMarkLine, ...(markLine || [])]\n\n  return {\n    ...spec,\n    markLine: newMarkLine,\n  }\n}\n"],"names":["annotationVerticalLine","spec","context","advancedVSeed","vseed","annotation","datasetReshapeInfo","config","unfoldInfo","foldInfo","theme","annotationVerticalLineList","Array","positionMap","markLine","selectorPoint","xValue","text","textPosition","textColor","textFontSize","textFontWeight","textAlign","textBaseline","lineColor","lineStyle","lineVisible","lineWidth","textBackgroundVisible","textBackgroundColor","textBackgroundBorderColor","textBackgroundBorderRadius","textBackgroundBorderWidth","textBackgroundPadding","dataset","generateOneMarkLine","x","ANNOTATION_Z_INDEX","isArray","isString","isNumber","xValueArr","selectedData","datum","selector","specMarkLine","newMarkLine"],"mappings":";;;AAMO,MAAMA,gDAAyC,CAACC,MAAMC;IAC3D,MAAM,EAAEC,aAAa,EAAEC,KAAK,EAAE,GAAGF;IACjC,MAAM,EAAEG,UAAU,EAAEC,kBAAkB,EAAEC,MAAM,EAAE,GAAGJ;IAEnD,MAAM,EAAEK,UAAU,EAAEC,QAAQ,EAAE,GAAGH,kBAAkB,CAAC,EAAE;IAEtD,IAAI,CAACD,cAAc,CAACA,WAAW,sBAAsB,EACnD,OAAOJ;IAGT,MAAMS,QAAQH,QAAQ,CAACH,MAAM,SAAS,CAAa,EAAE,YAAY;IACjE,MAAM,EAAEJ,sBAAsB,EAAE,GAAGK;IACnC,MAAMM,6BAA6BC,MAAM,OAAO,CAACZ,0BAC7CA,yBACA;QAACA;KAAuB;IAE5B,MAAMa,cAAc;QAClB,cAAc;QACd,YAAY;QACZ,eAAe;QACf,aAAa;QACb,cAAc;QACd,WAAW;IACb;IACA,MAAMC,WAAWH,2BAA2B,OAAO,CAAC,CAACX;QACnD,MAAM,EACJ,UAAUe,aAAa,EACvBC,MAAM,EACNC,OAAO,EAAE,EACTC,eAAe,WAAW,EAC1BC,YAAYT,OAAO,aAAa,SAAS,EACzCU,eAAeV,OAAO,gBAAgB,EAAE,EACxCW,iBAAiBX,OAAO,kBAAkB,GAAG,EAC7CY,YAAY,QAAQ,EACpBC,eAAe,KAAK,EAEpBC,YAAYd,OAAO,aAAa,SAAS,EACzCe,YAAYf,OAAO,aAAa,QAAQ,EACxCgB,cAAchB,OAAO,aAAa,IAAI,EACtCiB,YAAYjB,OAAO,aAAa,CAAC,EAEjCkB,wBAAwBlB,OAAO,yBAAyB,IAAI,EAC5DmB,sBAAsBnB,OAAO,uBAAuB,SAAS,EAC7DoB,4BAA4BpB,OAAO,6BAA6B,SAAS,EACzEqB,6BAA6BrB,OAAO,8BAA8B,CAAC,EACnEsB,4BAA4BtB,OAAO,6BAA6B,CAAC,EACjEuB,wBAAwBvB,OAAO,yBAAyB,CAAC,EAC1D,GAAGV;QAEJ,MAAMkC,UAAU/B,cAAc,OAAO,CAAC,IAAI;QAE1C,MAAMgC,sBAAsB,CAACC,IAAwB;gBACnDA;gBACA,WAAW;gBACX,QAAQC;gBACR,MAAM;oBACJ,OAAO;wBACL,SAASX;wBACT,QAAQF;wBACR,WAAWC;wBACX,WAAWE;wBACX,UAAUF,AAAc,aAAdA,YAAyB;4BAAC;4BAAG;yBAAE,GAAGA,AAAc,aAAdA,YAAyB;4BAAC;4BAAG;yBAAE,GAAG;4BAAC;yBAAE;oBACnF;gBACF;gBACA,OAAO;oBACL,SAAS;oBACT,MAAMR;oBACN,UAAWJ,WAAmB,CAACK,gBAAgB,YAAY;oBAC3D,OAAO;wBACL,SAAS;wBACT,IAAI;wBACJ,SAAS;wBACT,QAAQW;wBACR,WAAW;wBACX,WAAWP;wBACX,cAAcC;wBACd,MAAMJ;wBACN,UAAUC;wBACV,YAAYC;oBACd;oBACA,iBAAiB;wBACf,SAASO;wBACT,SAASK;wBACT,OAAO;4BACL,SAAS;4BACT,IAAI;4BACJ,cAAcF;4BACd,MAAMF;4BACN,aAAa;4BACb,QAAQC;4BACR,WAAWE;wBACb;oBACF;gBACF;gBACA,aAAa;oBACX,SAAStB,OAAO,sBAAsB;oBACtC,YAAYA,OAAO,mBAAmB;oBACtC,MAAM,IAAKiB,CAAAA,aAAa;oBACxB,OAAO;wBACL,IAAI;wBACJ,MAAMH;oBACR;gBACF;gBACA,WAAW;oBACT,SAASd,OAAO,oBAAoB;oBACpC,YAAYA,OAAO,iBAAiB;oBACpC,MAAM,KAAMiB,CAAAA,aAAa;oBACzB,OAAO;wBACL,IAAI;wBACJ,MAAMH;oBACR;gBACF;YACF;QAEA,IAAK,CAACT,iBAAiBuB,QAAQtB,WAAYuB,SAASvB,WAAWwB,SAASxB,SAAS;YAC/E,MAAMyB,YAAY7B,MAAM,OAAO,CAACI,UAAUA,SAAS;gBAACA;aAAO;YAC3D,OAAOyB,UAAU,GAAG,CAACN;QACvB;QAEA,MAAMO,eAAe3B,gBAAgBmB,QAAQ,MAAM,CAAC,CAACS,QAAUC,SAASD,OAAO5B,kBAAkB,EAAE;QAEnG,OAAO2B,aAAa,GAAG,CAAC,CAACC;YACvB,IAAIA,KAAK,CAACnC,WAAW,SAAS,CAAC,EAC7B,OAAO2B,oBAAoBQ,KAAK,CAACnC,WAAW,SAAS,CAAC;YAExD,IAAImC,KAAK,CAAClC,SAAS,YAAY,CAAC,EAC9B,OAAO0B,oBAAoBQ,KAAK,CAAClC,SAAS,YAAY,CAAC;YAEzD,OAAO,CAAC;QACV;IACF;IAEA,MAAMoC,eAAiB5C,KAAwB,QAAQ,IAAwB,EAAE;IACjF,MAAM6C,cAAc;WAAID;WAAkB/B,YAAY,EAAE;KAAE;IAE1D,OAAO;QACL,GAAGb,IAAI;QACP,UAAU6C;IACZ;AACF"}