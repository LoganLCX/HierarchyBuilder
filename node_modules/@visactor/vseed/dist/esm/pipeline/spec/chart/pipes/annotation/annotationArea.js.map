{"version":3,"file":"pipeline/spec/chart/pipes/annotation/annotationArea.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/annotation/annotationArea.ts"],"sourcesContent":["/**\n * @description 适用于线图、面积图等的区块标注，计算标注区块的时候，只考虑点的大小\n */\nimport type { ICartesianSeries, ILineChartSpec } from '@visactor/vchart'\nimport { selector } from '../../../../../dataSelector'\nimport type { Datum, VChartSpecPipe, VSeed } from 'src/types'\nimport { ANNOTATION_AREA_TEXT_STYLE_BY_POSITION, isSubset } from './utils'\nimport { ANNOTATION_Z_INDEX } from '../../../../utils/constant'\nimport { isBarLikeChart } from 'src/pipeline/utils/chatType'\n\nexport const annotationArea: VChartSpecPipe = (spec, context) => {\n  const { advancedVSeed, vseed } = context\n  const { annotation, config } = advancedVSeed\n\n  if (!annotation || !annotation.annotationArea) {\n    return spec\n  }\n\n  const theme = config?.[vseed.chartType as 'column']?.annotation?.annotationArea\n  const { annotationArea } = annotation\n  const annotationAreaList = Array.isArray(annotationArea) ? annotationArea : [annotationArea]\n\n  const positionMap = {\n    top: 'insideTop',\n    topRight: 'insideTopRight',\n    topLeft: 'insideTopLeft',\n    bottom: 'insideBottom',\n    bottomLeft: 'insideBottomLeft',\n    bottomRight: 'insideBottomRight',\n    left: 'insideLeft',\n    right: 'insideRight',\n  }\n  const defaultTextPosition = isBarLikeChart(advancedVSeed as VSeed) ? 'right' : 'top'\n\n  const markArea = annotationAreaList.flatMap((annotationArea) => {\n    const {\n      selector: selectorPoint,\n      text = '',\n      textColor = theme?.textColor ?? '#ffffff',\n      textFontSize = theme?.textFontSize ?? 12,\n      textFontWeight = theme?.textFontWeight ?? 400,\n\n      textBackgroundVisible = theme?.textBackgroundVisible ?? true,\n      textBackgroundColor = theme?.textBackgroundColor ?? '#191d24',\n      textBackgroundBorderColor = theme?.textBackgroundBorderColor ?? '#191d24',\n      textBackgroundBorderWidth = theme?.textBackgroundBorderWidth ?? 1,\n      textBackgroundBorderRadius = theme?.textBackgroundBorderRadius ?? 4,\n      textBackgroundPadding = theme?.textBackgroundPadding ?? 4,\n\n      areaColor = theme?.areaColor ?? '#888888',\n      areaColorOpacity = theme?.areaColorOpacity ?? 0.15,\n      areaBorderColor = theme?.areaBorderColor ?? '#888888',\n      areaBorderRadius = theme?.areaBorderRadius ?? 4,\n      areaBorderWidth = theme?.areaBorderWidth ?? 1,\n      areaLineDash = theme?.areaLineDash,\n\n      outerPadding = theme?.outerPadding ?? 4,\n    } = annotationArea\n\n    const dataset = advancedVSeed.dataset.flat()\n    const selectedData = selectorPoint ? dataset.filter((datum) => selector(datum, selectorPoint)) : []\n    const textPosition: string = annotationArea.textPosition ?? defaultTextPosition\n    const textAlign =\n      annotationArea.textAlign ??\n      ANNOTATION_AREA_TEXT_STYLE_BY_POSITION[textPosition as keyof typeof ANNOTATION_AREA_TEXT_STYLE_BY_POSITION]\n        .textAlign\n    const textBaseline =\n      annotationArea.textBaseline ??\n      ANNOTATION_AREA_TEXT_STYLE_BY_POSITION[textPosition as keyof typeof ANNOTATION_AREA_TEXT_STYLE_BY_POSITION]\n        .textBaseline\n\n    return {\n      zIndex: ANNOTATION_Z_INDEX,\n      regionRelative: true,\n      positions: (data: Datum[], context: ICartesianSeries) => {\n        const positionData = data.filter((item) => selectedData.some((datum) => isSubset(datum, item)))\n        const xyList = positionData.map((datum) => context.dataToPosition(datum) as { x: number; y: number })\n\n        const yAxisHelper = context.getYAxisHelper() as unknown as {\n          getBandwidth: (depth?: number) => number\n          getScale: () => {\n            range: () => number[]\n          }\n        }\n        const xAxisHelper = context.getXAxisHelper() as unknown as {\n          getBandwidth: (depth?: number) => number\n          getScale: () => {\n            range: () => number[]\n          }\n        }\n\n        if (typeof xAxisHelper?.getBandwidth === 'function') {\n          const regionRect = context.getRegion().getLayoutRect()\n\n          const minX = Math.min(...xyList.map((item) => item.x)) - (outerPadding || 4)\n          const maxX = Math.max(...xyList.map((item) => item.x)) + (outerPadding || 4)\n          const minY = 0\n          const maxY = regionRect.height\n          return [\n            // 左上\n            {\n              x: minX,\n              y: minY,\n            },\n            // 右上\n            {\n              x: maxX,\n              y: minY,\n            },\n            // 右下\n            {\n              x: maxX,\n              y: maxY,\n            },\n            // 左下\n            {\n              x: minX,\n              y: maxY,\n            },\n          ]\n        }\n\n        if (typeof yAxisHelper?.getBandwidth === 'function') {\n          const regionRect = context.getRegion().getLayoutRect()\n\n          const minY = Math.min(...xyList.map((item) => item.y)) - (outerPadding || 4)\n          const maxY = Math.max(...xyList.map((item) => item.y)) + (outerPadding || 4)\n          const minX = 0\n          const maxX = regionRect.width\n\n          return [\n            // 左上\n            {\n              x: minX,\n              y: minY,\n            },\n            // 右上\n            {\n              x: maxX,\n              y: minY,\n            },\n            // 右下\n            {\n              x: maxX,\n              y: maxY,\n            },\n            // 左下\n            {\n              x: minX,\n              y: maxY,\n            },\n          ]\n        }\n\n        return []\n      },\n      label: {\n        position: (positionMap as any)[textPosition],\n        visible: true,\n        text: text,\n        style: {\n          opacity: 0.95,\n          textAlign: textAlign,\n          textBaseline: textBaseline,\n          fill: textColor,\n          stroke: textBackgroundColor,\n          lineWidth: 1,\n          fontSize: textFontSize,\n          fontWeight: textFontWeight,\n        },\n\n        labelBackground: {\n          visible: textBackgroundVisible,\n          padding: textBackgroundPadding,\n          style: {\n            opacity: 0.95,\n            cornerRadius: textBackgroundBorderRadius ?? 4,\n            fill: textBackgroundColor,\n            stroke: textBackgroundBorderColor,\n            lineWidth: textBackgroundBorderWidth,\n            fillOpacity: 1,\n          },\n        },\n      },\n      area: {\n        style: {\n          visible: true,\n          fill: areaColor,\n          fillOpacity: areaColorOpacity,\n          stroke: areaBorderColor,\n          lineWidth: areaBorderWidth,\n          cornerRadius: areaBorderRadius,\n          lineDash: areaLineDash,\n        },\n      },\n    }\n  }) as ILineChartSpec['markArea']\n\n  return {\n    ...spec,\n    markArea: markArea,\n  }\n}\n"],"names":["annotationArea","spec","context","advancedVSeed","vseed","annotation","config","theme","annotationAreaList","Array","positionMap","defaultTextPosition","isBarLikeChart","markArea","selectorPoint","text","textColor","textFontSize","textFontWeight","textBackgroundVisible","textBackgroundColor","textBackgroundBorderColor","textBackgroundBorderWidth","textBackgroundBorderRadius","textBackgroundPadding","areaColor","areaColorOpacity","areaBorderColor","areaBorderRadius","areaBorderWidth","areaLineDash","outerPadding","dataset","selectedData","datum","selector","textPosition","textAlign","ANNOTATION_AREA_TEXT_STYLE_BY_POSITION","textBaseline","ANNOTATION_Z_INDEX","data","positionData","item","isSubset","xyList","yAxisHelper","xAxisHelper","regionRect","minX","Math","maxX","minY","maxY"],"mappings":"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"}