{"version":3,"file":"pipeline/spec/chart/pipes/label/label.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/label/label.ts"],"sourcesContent":["import type { ILineChartSpec } from '@visactor/vchart'\nimport { createFormatter, createFormatterByMeasure, DATUM_HIDE_KEY, findMeasureById } from '../../../../utils'\nimport type {\n  Datum,\n  Dimension,\n  Dimensions,\n  Encoding,\n  FoldInfo,\n  Formatter,\n  Label,\n  Measure,\n  Measures,\n  NumFormat,\n  VChartSpecPipe,\n} from 'src/types'\nimport { isNumber, merge, uniqueBy } from 'remeda'\nimport { selector } from 'src/dataSelector'\nimport { MeasureId } from 'src/dataReshape/constant'\n\nexport const label: VChartSpecPipe = (spec, context) => {\n  const result = { ...spec } as ILineChartSpec\n  const { advancedVSeed, vseed } = context\n  const { datasetReshapeInfo } = advancedVSeed\n  const { chartType, encoding } = advancedVSeed\n  const baseConfig = advancedVSeed.config[chartType] as { label: Label }\n  const foldInfo = datasetReshapeInfo[0].foldInfo as FoldInfo\n\n  const { label } = baseConfig\n\n  result.label = buildLabel(\n    label,\n    vseed.measures,\n    vseed.dimensions,\n    advancedVSeed.dimensions,\n    advancedVSeed.measures,\n    encoding as Encoding,\n    [foldInfo],\n  ) as unknown as ILineChartSpec['label']\n\n  return result\n}\n\nexport const generateMeasureValue = (\n  value: number | string,\n  measure: Measure,\n  labelAutoFormat?: boolean,\n  numFormat: NumFormat = {},\n) => {\n  const format = merge(numFormat, measure.numFormat || measure.format)\n  const mergedMeasure = { ...measure, numFormat: format, autoFormat: labelAutoFormat || measure.autoFormat }\n\n  const formatter = createFormatterByMeasure(mergedMeasure)\n  return formatter(value)\n}\n\nexport const generateMeasurePercent = (value: number | string, sum: number, formatter: Formatter) => {\n  if (value === undefined || value === null) return String(value)\n  const num = Number(value)\n  if (Number.isNaN(num)) return String(value)\n\n  const percentValue = num / sum\n  return formatter(percentValue)\n}\n\nexport const buildLabel = (\n  label: Label,\n  vseedMeasures: Measures = [],\n  vseedDimensions: Dimensions = [],\n  advancedVSeedDimensions: Dimensions,\n  advancedVSeedMeasures: Measures,\n  encoding: Encoding,\n  foldInfoList: FoldInfo[],\n) => {\n  const {\n    enable,\n    wrap,\n    showValue,\n    showValuePercent,\n    showDimension,\n    labelOverlap,\n    labelColorSmartInvert,\n    labelStroke,\n    labelColor,\n    labelFontSize,\n    labelFontWeight,\n    labelBackgroundColor,\n    labelPosition,\n    autoFormat,\n    numFormat = {},\n  } = label\n\n  const hasDimLabelEncoding = vseedDimensions.some((item) => encoding.label?.includes(item.id))\n\n  const labelDims = uniqueBy(\n    hasDimLabelEncoding\n      ? vseedDimensions.filter((item) => encoding.label?.includes(item.id))\n      : showDimension\n        ? advancedVSeedDimensions.filter((d) => d.id !== MeasureId)\n        : [],\n    (item: Dimension) => item.id,\n  )\n\n  const labelMeas = uniqueBy(\n    vseedMeasures.filter((item) => encoding.label?.includes(item.id)),\n    (item: Measure) => item.id,\n  )\n\n  const percentFormat: NumFormat = merge(numFormat, {\n    type: 'percent',\n  } as NumFormat)\n\n  const percentFormatter = createFormatter(percentFormat)\n\n  const result = {\n    visible: enable,\n    dataFilter: (data: Datum[]) => {\n      return data.filter((entry) => {\n        return entry.data?.[DATUM_HIDE_KEY] !== true && selector(entry.data as Datum, label.selector, 'Or')\n      })\n    },\n    formatMethod: (_: unknown, datum: Datum) => {\n      const result = []\n\n      const dimLabels = labelDims.map((item: Dimension) => {\n        const id = item.id\n        return datum[id] as number | string\n      })\n\n      const meaLabels = labelMeas.map((item: Measure) =>\n        generateMeasureValue(datum[item.id] as number | string, item, autoFormat, numFormat),\n      )\n\n      result.push(...dimLabels)\n\n      foldInfoList.forEach((foldInfo) => {\n        const { measureId, measureValue, statistics } = foldInfo\n        const measure = findMeasureById(advancedVSeedMeasures, datum[measureId] as string)\n        if (measure) {\n          const measureValueLabel = generateMeasureValue(\n            datum[measureValue] as number | string,\n            measure,\n            autoFormat,\n            numFormat,\n          )\n          // 饼图/环图需要使用实际占比数据\n          const measurePercentLabel = isNumber(datum['__VCHART_ARC_RATIO'])\n            ? generateMeasurePercent(datum['__VCHART_ARC_RATIO'], 1, percentFormatter)\n            : generateMeasurePercent(datum[measureValue] as number | string, statistics.sum, percentFormatter)\n          if (showValue) {\n            result.push(measureValueLabel)\n          }\n          if (showValuePercent) {\n            result.push(measurePercentLabel)\n          }\n        }\n      })\n\n      result.push(...meaLabels)\n\n      if (wrap) {\n        return result\n      }\n      return result.join(' ')\n    },\n    position: labelPosition,\n    style: {\n      stroke: labelStroke,\n      fill: labelColor,\n      fontSize: labelFontSize,\n      fontWeight: labelFontWeight,\n      background: labelBackgroundColor,\n    },\n    smartInvert: labelColorSmartInvert,\n  }\n\n  if (labelOverlap) {\n    ;(result as any).overlap = {\n      hideOnHit: true,\n      clampForce: true,\n    }\n  }\n\n  return result\n}\n"],"names":["label","spec","context","result","advancedVSeed","vseed","datasetReshapeInfo","chartType","encoding","baseConfig","foldInfo","buildLabel","generateMeasureValue","value","measure","labelAutoFormat","numFormat","format","merge","mergedMeasure","formatter","createFormatterByMeasure","generateMeasurePercent","sum","String","num","Number","percentValue","vseedMeasures","vseedDimensions","advancedVSeedDimensions","advancedVSeedMeasures","foldInfoList","enable","wrap","showValue","showValuePercent","showDimension","labelOverlap","labelColorSmartInvert","labelStroke","labelColor","labelFontSize","labelFontWeight","labelBackgroundColor","labelPosition","autoFormat","hasDimLabelEncoding","item","labelDims","uniqueBy","d","MeasureId","labelMeas","percentFormat","percentFormatter","createFormatter","data","entry","DATUM_HIDE_KEY","selector","_","datum","dimLabels","id","meaLabels","measureId","measureValue","statistics","findMeasureById","measureValueLabel","measurePercentLabel","isNumber"],"mappings":"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"}