{"version":3,"file":"pipeline/spec/chart/pipes/tooltip/tooltipBoxplot.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/tooltip/tooltipBoxplot.ts"],"sourcesContent":["import { pipe, uniqueBy, isNullish } from 'remeda'\nimport { createFormatterByMeasure, findAllMeasures } from '../../../../utils'\nimport type { Dimension, Dimensions, Encoding, VChartSpecPipe, Tooltip } from 'src/types'\nimport type { Datum, ISpec, ITooltipLinePattern, ITooltipLineActual, TooltipData } from '@visactor/vchart'\nimport {\n  ColorEncoding,\n  LowerWhisker,\n  MedianMeasureId,\n  OutliersMeasureId,\n  Q1MeasureValue,\n  Q3MeasureValue,\n  UpperWhisker,\n  XEncoding,\n} from 'src/dataReshape'\nimport { getTooltipStyle } from './tooltipStyle'\nimport { intl } from 'src/i18n'\n\nconst boxPlotMeasureKeys = [UpperWhisker, Q3MeasureValue, MedianMeasureId, Q1MeasureValue, LowerWhisker]\nconst VCHART_OUTLIER_KEY = '__VCHART_BOX_PLOT_OUTLIER_VALUE'\n\nexport const tooltipBoxplot: VChartSpecPipe = (spec, context) => {\n  const result = { ...spec }\n  const { advancedVSeed, vseed } = context\n  const { chartType, dimensions, encoding } = advancedVSeed\n  const baseConfig = advancedVSeed.config[chartType] as { tooltip: Tooltip }\n  const { tooltip = { enable: true } } = baseConfig\n  const { enable } = tooltip\n  const meas = findAllMeasures(vseed.measures)\n  const valueMeasure = meas.find((item) => item.encoding === 'value' || isNullish(item.encoding))\n  const defaultFormatter = valueMeasure ? createFormatterByMeasure(valueMeasure) : (v: unknown) => v\n  const measureAliasMapping: Record<string, string> = {\n    [OutliersMeasureId]: intl.i18n`异常点`,\n    [UpperWhisker]: intl.i18n`上边界`,\n    [Q3MeasureValue]: intl.i18n`上四分位数`,\n    [MedianMeasureId]: intl.i18n`中位数`,\n    [Q1MeasureValue]: intl.i18n`下四分位数`,\n    [LowerWhisker]: intl.i18n`下边界`,\n  }\n\n  result.tooltip = {\n    visible: enable,\n    style: getTooltipStyle(tooltip),\n    mark: {\n      title: {\n        visible: false,\n      },\n      content: createMarkContent(encoding.tooltip || [], dimensions, encoding as Encoding),\n      updateContent: (prev: ITooltipLineActual[] | undefined, data: TooltipData | undefined) => {\n        const datum = (data as any)?.[0]?.datum?.[0]\n\n        if (!isNullish(datum?.[VCHART_OUTLIER_KEY])) {\n          const tooltipItems: ITooltipLineActual[] = (prev ?? []).filter(\n            (item: any) => !boxPlotMeasureKeys.includes(item.key as string),\n          )\n          const outerlierMeasure = meas.find((item) => item.id === OutliersMeasureId)\n          const formatter = outerlierMeasure ? createFormatterByMeasure(outerlierMeasure) : defaultFormatter\n\n          tooltipItems.push({\n            ...(tooltipItems[0] as any),\n            key: outerlierMeasure?.alias ?? measureAliasMapping[OutliersMeasureId],\n            value: formatter(datum?.[VCHART_OUTLIER_KEY] as number) as string,\n          } as ITooltipLineActual)\n\n          return tooltipItems\n        }\n\n        return (prev ?? []).map((entry) => {\n          if (boxPlotMeasureKeys.includes((entry as any).key as string)) {\n            const mea = meas.find((item) => item.id === (entry as any).key)\n            const formatter = mea ? createFormatterByMeasure(mea) : defaultFormatter\n\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n            return {\n              ...(entry as any),\n              value: formatter(datum?.[(entry as any).key] as number) as string,\n              key: mea?.alias ?? measureAliasMapping[entry?.key as string] ?? (entry as any).key,\n            }\n          }\n\n          return entry\n        }) as ITooltipLineActual[]\n      },\n    },\n    dimension: {\n      visible: false,\n    },\n  }\n  return result as unknown as ISpec\n}\n\nconst createMarkContent = (tooltip: string[], dimensions: Dimensions, encoding: Encoding) => {\n  const dims = pipe(\n    dimensions.filter((item) => tooltip.includes(item.id)),\n    uniqueBy((item: Dimension) => item.id),\n    uniqueBy((item: Dimension) => item.alias),\n  )\n\n  const dimContent = dims.map((item: Dimension) => ({\n    visible: true,\n    hasShape: true,\n    shapeType: 'rectRound',\n    key: item.alias ?? item.id,\n    value: (datum: Datum | undefined) => {\n      if (!isNullish(datum?.[VCHART_OUTLIER_KEY])) {\n        if (encoding.color?.includes(item.id)) {\n          return datum?.[ColorEncoding] as string\n        }\n        if (encoding.x?.includes(item.id)) {\n          return datum?.[XEncoding] as string\n        }\n      }\n\n      return datum?.[item.id] as string\n    },\n  }))\n\n  const defaultContent = boxPlotMeasureKeys.map((key: string) => {\n    return {\n      visible: true,\n      hasShape: true,\n      shapeType: 'rectRound',\n      key,\n      value: (datum: Datum | undefined) => {\n        if (!datum) {\n          return ''\n        }\n        return datum[key] as string | number\n      },\n    }\n  })\n\n  return [...dimContent, defaultContent] as ITooltipLinePattern[]\n}\n"],"names":["boxPlotMeasureKeys","UpperWhisker","Q3MeasureValue","MedianMeasureId","Q1MeasureValue","LowerWhisker","VCHART_OUTLIER_KEY","tooltipBoxplot","spec","context","result","advancedVSeed","vseed","chartType","dimensions","encoding","baseConfig","tooltip","enable","meas","findAllMeasures","valueMeasure","item","isNullish","defaultFormatter","createFormatterByMeasure","v","measureAliasMapping","OutliersMeasureId","intl","getTooltipStyle","createMarkContent","prev","data","datum","tooltipItems","outerlierMeasure","formatter","entry","mea","dims","pipe","uniqueBy","dimContent","ColorEncoding","XEncoding","defaultContent","key"],"mappings":"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"}