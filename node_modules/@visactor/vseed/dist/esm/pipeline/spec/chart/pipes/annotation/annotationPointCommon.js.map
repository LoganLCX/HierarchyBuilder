{"version":3,"file":"pipeline/spec/chart/pipes/annotation/annotationPointCommon.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/annotation/annotationPointCommon.ts"],"sourcesContent":["import type { ISpec, IMarkPointSpec } from '@visactor/vchart'\nimport { selector } from '../../../../../dataSelector'\nimport type { Datum, Selector, Selectors, SpecPipelineContext, VChartSpecPipe, VSeed } from 'src/types'\nimport { isSubset } from './utils'\nimport { ANNOTATION_Z_INDEX } from '../../../../utils/constant'\nimport { isBarLikeChart } from 'src/pipeline/utils/chatType'\n\nexport const generateAnnotationPointPipe = (options: {\n  findSelectedDatas?: (\n    dataset: Datum[],\n    selector: Selector | Selectors | undefined | null,\n    spec: ISpec,\n    context: SpecPipelineContext,\n  ) => Datum[]\n  generateMarkPoint?: (datum: Datum, spec: ISpec, context: SpecPipelineContext) => IMarkPointSpec[] | undefined\n}) => {\n  const findSelectedDatas = options.findSelectedDatas ?? ((dataset, s) => dataset.filter((datum) => selector(datum, s)))\n  const generateMarkPoint =\n    options.generateMarkPoint ??\n    ((datum: Datum) => {\n      return [\n        {\n          coordinate: (data: Datum[]) => {\n            return data.find((item) => isSubset(datum, item))\n          },\n        },\n      ]\n    })\n\n  return ((spec: ISpec, context: SpecPipelineContext) => {\n    const { advancedVSeed, vseed } = context\n    const { annotation, config } = advancedVSeed\n\n    if (!annotation || !annotation.annotationPoint) {\n      return spec\n    }\n\n    const theme = config?.[vseed.chartType as 'column']?.annotation?.annotationPoint\n    const { annotationPoint } = annotation\n    const annotationPointList = Array.isArray(annotationPoint) ? annotationPoint : [annotationPoint]\n    const isHorizontalBar = isBarLikeChart(advancedVSeed as VSeed)\n    const defaultStyle = isHorizontalBar\n      ? {\n          textAlign: 'right',\n          textBaseline: 'middle',\n        }\n      : {\n          textAlign: 'center',\n          textBaseline: 'top',\n        }\n\n    const markPoint = annotationPointList.flatMap((annotationPoint) => {\n      const {\n        selector: selectorPoint,\n        text = '',\n        textColor = theme?.textColor ?? '#ffffff',\n        textFontSize = theme?.textFontSize ?? 12,\n        textFontWeight = theme?.textFontWeight ?? 400,\n        textAlign = defaultStyle.textAlign,\n        textBaseline = defaultStyle.textBaseline,\n        textBackgroundBorderColor = theme?.textBackgroundBorderColor,\n        textBackgroundBorderRadius = theme?.textBackgroundBorderRadius ?? 4,\n        textBackgroundBorderWidth = theme?.textBackgroundBorderWidth ?? 1,\n        textBackgroundColor = theme?.textBackgroundColor ?? '#212121',\n        textBackgroundPadding = theme?.textBackgroundPadding ?? 2,\n        textBackgroundVisible = theme?.textBackgroundVisible ?? true,\n        offsetX = theme?.offsetX ?? 0,\n        offsetY = theme?.offsetY ?? 0,\n      } = annotationPoint\n\n      const dataset = advancedVSeed.dataset.flat()\n      const selectedData = selectorPoint ? findSelectedDatas(dataset, selectorPoint, spec, context) : []\n      const dx = -10 - (isHorizontalBar ? (textFontSize as number) : 0) // 由于vchart tag实现问题，需要设置这个强制偏移量\n      const dy = isHorizontalBar ? 0 : (textFontSize as number)\n      const markPointStyle = {\n        zIndex: ANNOTATION_Z_INDEX,\n        regionRelative: true,\n        itemLine: {\n          visible: false,\n        },\n        itemContent: {\n          offsetY,\n          offsetX,\n          confine: true,\n          text: {\n            text: text,\n            style: {\n              opacity: 0.95,\n              visible: true,\n              textAlign: textAlign,\n              textBaseline: textBaseline,\n              fill: textColor,\n              stroke: textBackgroundColor,\n              lineWidth: 1,\n              fontSize: textFontSize,\n              fontWeight: textFontWeight,\n              dx,\n              dy,\n            },\n            labelBackground: {\n              visible: textBackgroundVisible,\n              padding: textBackgroundPadding,\n              style: {\n                opacity: 0.95,\n                cornerRadius: textBackgroundBorderRadius ?? 4,\n                fill: textBackgroundColor,\n                stroke: textBackgroundBorderColor,\n                lineWidth: textBackgroundBorderWidth,\n                dx,\n                dy,\n              },\n            },\n          },\n        },\n      } as Partial<IMarkPointSpec>\n\n      return selectedData.reduce((res: IMarkPointSpec[], datum) => {\n        const marks = generateMarkPoint(datum, spec, context)\n\n        if (marks && marks.length) {\n          marks.forEach((mark) => {\n            res.push({\n              ...markPointStyle,\n              ...mark,\n            } as IMarkPointSpec)\n          })\n        }\n\n        return res\n      }, [])\n    }) as unknown as IMarkPointSpec[]\n\n    return {\n      ...spec,\n      markPoint,\n    } as ISpec\n  }) as VChartSpecPipe\n}\n"],"names":["generateAnnotationPointPipe","options","findSelectedDatas","dataset","s","datum","selector","generateMarkPoint","data","item","isSubset","spec","context","advancedVSeed","vseed","annotation","config","theme","annotationPoint","annotationPointList","Array","isHorizontalBar","isBarLikeChart","defaultStyle","markPoint","selectorPoint","text","textColor","textFontSize","textFontWeight","textAlign","textBaseline","textBackgroundBorderColor","textBackgroundBorderRadius","textBackgroundBorderWidth","textBackgroundColor","textBackgroundPadding","textBackgroundVisible","offsetX","offsetY","selectedData","dx","dy","markPointStyle","ANNOTATION_Z_INDEX","res","marks","mark"],"mappings":"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"}