{"version":3,"file":"pipeline/spec/chart/pipes/regressionLine/columnRegressionLine.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/regressionLine/columnRegressionLine.ts"],"sourcesContent":["import type { IBarChartSpec, ICartesianSeries, IChart, IVChart } from '@visactor/vchart'\nimport { isNullish } from 'remeda'\nimport { array, clamper, regressionPolynomial } from '@visactor/vutils'\nimport type {\n  Datum,\n  VChartSpecPipe,\n  RegressionLineConfig,\n  LinearRegressionLine,\n  PolynomialRegressionLine,\n} from 'src/types'\nimport { defaultRegressionLineColor, getAlphaByConfidenceLevel } from './common'\n\nexport const columnPolynomialRegressionLine: VChartSpecPipe = (spec, context): Partial<IBarChartSpec> => {\n  const result = { ...spec } as Partial<IBarChartSpec>\n  const { advancedVSeed } = context\n  const { chartType, regressionLine } = advancedVSeed\n  const lineTheme = advancedVSeed.config[chartType as 'scatter']?.regressionLine as RegressionLineConfig\n\n  if (!regressionLine || !regressionLine.polynomialRegressionLine) {\n    return result\n  }\n\n  const lineList = array(regressionLine.polynomialRegressionLine)\n\n  if (!result.extensionMark) {\n    result.extensionMark = []\n  }\n\n  lineList.forEach((line, lineIndex) => {\n    if (line.enable === false) {\n      return\n    }\n    const theme = (lineTheme.linearRegressionLine ?? {}) as LinearRegressionLine\n    const {\n      color,\n      lineWidth,\n      lineDash,\n      text,\n      textColor,\n      textFontSize,\n      textFontWeight,\n      confidenceIntervalOpacity,\n      confidenceLevel = 0.95,\n      confidenceIntervalVisible = theme.confidenceIntervalVisible,\n    } = line as LinearRegressionLine\n\n    const childrenMarks: any[] = []\n\n    ;(result.extensionMark as any[]).push({\n      type: 'group',\n      interactive: false,\n      zIndex: 500,\n      name: `polynomialRegressionLine-${lineIndex}`,\n      dataId: (spec.data as any)?.id,\n      style: {\n        data: (datum: any, ctx: any) => {\n          const vchart = ctx.vchart as IVChart\n          const chart = vchart.getChart() as IChart\n          const s = chart.getAllSeries()[0] as ICartesianSeries\n\n          if (s) {\n            const rect = s.getRegion().getLayoutRect()\n\n            if (rect.width === 0 || rect.height === 0) {\n              return null\n            }\n\n            const yClamper = clamper(0, 0 + rect.height)\n            const data = s.getViewData()?.latestData as Datum[]\n            const fieldX = s.fieldX?.[0]\n            const fieldY = s.fieldY?.[0]\n            const xValues = s.getRawDataStatisticsByField(fieldX).values as string[]\n            const degree = (line as PolynomialRegressionLine).degree ?? 2\n            // 多项式拟合需要至少 degree + 1 个点\n            const minPoints = degree + 1\n\n            if (!fieldX || !fieldY || !data || data.length < minPoints || xValues.length < minPoints) {\n              return null\n            }\n\n            // eslint-disable-next-line @typescript-eslint/unbound-method\n            const { confidenceInterval, evaluateGrid } = regressionPolynomial(\n              xValues.map((xVal, index: number) => {\n                const filteredData = data.filter((d) => d[fieldX] === xVal)\n\n                return {\n                  x: index,\n                  y: Math.max(...filteredData.map((d) => d[fieldY] as number)),\n                }\n              }),\n              undefined,\n              undefined,\n              {\n                degree: (line as PolynomialRegressionLine).degree ?? 2,\n                alpha: getAlphaByConfidenceLevel(confidenceLevel),\n              },\n            )\n            const N = xValues.length\n            const xAxisHelper = s.getXAxisHelper()\n            const halfBandWidth = xAxisHelper ? xAxisHelper.getBandwidth!(0) / 2 : 0\n            const lineData = evaluateGrid(N)\n            const linePoints = lineData.map((datum: Datum, index: number) => {\n              const d = { [fieldX]: xValues[index], [fieldY]: datum.y }\n              return {\n                x: s.dataToPositionX(d)! + halfBandWidth,\n                y: yClamper(s.dataToPositionY(d)!),\n              }\n            })\n            const result: {\n              linePoints: { x: number; y: number }[]\n              areaPoints?: { x: number; y: number; y1: number }[]\n              color: string\n            } = {\n              linePoints,\n              color: s.getOption().globalScale.getScale('color')?.scale(s.getSeriesKeys()[0]),\n            }\n\n            if (confidenceIntervalVisible) {\n              const intervalData = confidenceInterval(N)\n\n              result.areaPoints = intervalData.map((datum: Datum, index: number) => {\n                const d = { [fieldX]: xValues[index], [fieldY]: datum.lower }\n                return {\n                  x: s.dataToPositionX(d)! + halfBandWidth,\n                  y: yClamper(s.dataToPositionY(d)!),\n                  y1: yClamper(s.dataToPositionY({ [fieldY]: datum.upper })!),\n                }\n              })\n            }\n\n            return result\n          }\n          return null\n        },\n      },\n      children: childrenMarks,\n    })\n\n    if (confidenceIntervalVisible) {\n      childrenMarks.push({\n        type: 'area',\n        interactive: false,\n        zIndex: 500,\n        dataId: (spec.data as any)?.id,\n        style: {\n          lineWidth: lineWidth ?? theme.lineWidth,\n          lineDash: lineDash ?? theme.lineDash,\n          fillOpacity: confidenceIntervalOpacity ?? theme.confidenceIntervalOpacity,\n          fill: color ?? defaultRegressionLineColor,\n          points: (datum: any, ctx: any, opt: any) => {\n            const parentNode = opt.mark?._product?.parent\n\n            if (parentNode?.attribute?.data) {\n              // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n              return parentNode.attribute.data.areaPoints\n            }\n\n            return []\n          },\n        },\n      })\n    }\n\n    childrenMarks.push({\n      type: 'line',\n      interactive: false,\n      zIndex: 500,\n      dataId: (spec.data as any)?.id,\n      style: {\n        lineWidth: lineWidth ?? theme.lineWidth,\n        lineDash: lineDash ?? theme.lineDash,\n        stroke: color ?? defaultRegressionLineColor,\n        points: (datum: any, ctx: any, opt: any) => {\n          const parentNode = opt.mark?._product?.parent\n\n          if (parentNode?.attribute?.data) {\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n            return parentNode.attribute.data.linePoints\n          }\n\n          return []\n        },\n      },\n    })\n\n    if (!isNullish(text)) {\n      childrenMarks.push({\n        type: 'text',\n        interactive: false,\n        zIndex: 500,\n        dataId: (spec.data as any)?.id,\n        dataKey: () => {\n          return `polynomialRegressionLine-label-${lineIndex}`\n        },\n        style: {\n          textAlign: 'end',\n          fill: textColor ?? theme.textColor,\n          fontSize: textFontSize ?? theme.textFontSize,\n          fontWeight: textFontWeight ?? theme.textFontWeight,\n          text: text,\n          x: (datum: any, ctx: any, opt: any) => {\n            const parentNode = opt.mark?._product?.parent\n\n            if (parentNode?.attribute?.data?.linePoints) {\n              const points = parentNode.attribute.data.linePoints\n              return points[points.length - 1]?.x\n            }\n\n            return undefined\n          },\n          y: (datum: any, ctx: any, opt: any) => {\n            const parentNode = opt.mark?._product?.parent\n\n            if (parentNode?.attribute?.data?.linePoints) {\n              const points = parentNode.attribute.data.linePoints\n              return points[points.length - 1]?.y\n            }\n\n            return undefined\n          },\n        },\n      })\n    }\n  })\n\n  return result\n}\n"],"names":["columnPolynomialRegressionLine","spec","context","result","advancedVSeed","chartType","regressionLine","lineTheme","lineList","array","line","lineIndex","theme","color","lineWidth","lineDash","text","textColor","textFontSize","textFontWeight","confidenceIntervalOpacity","confidenceLevel","confidenceIntervalVisible","childrenMarks","datum","ctx","vchart","chart","s","rect","yClamper","clamper","data","fieldX","fieldY","xValues","degree","minPoints","confidenceInterval","evaluateGrid","regressionPolynomial","xVal","index","filteredData","d","Math","undefined","getAlphaByConfidenceLevel","N","xAxisHelper","halfBandWidth","lineData","linePoints","intervalData","defaultRegressionLineColor","opt","parentNode","isNullish","points"],"mappings":"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"}