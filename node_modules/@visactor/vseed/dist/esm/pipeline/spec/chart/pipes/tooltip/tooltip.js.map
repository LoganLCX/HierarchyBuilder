{"version":3,"file":"pipeline/spec/chart/pipes/tooltip/tooltip.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/tooltip/tooltip.ts"],"sourcesContent":["import { pipe, uniqueBy } from 'remeda'\nimport { createFormatterByMeasure, findAllMeasures, findMeasureById } from '../../../../utils'\nimport type { Datum, Dimensions, FoldInfo, Measures, VChartSpecPipe, TooltipConfig, UnfoldInfo } from 'src/types'\nimport { ORIGINAL_DATA } from 'src/dataReshape'\nimport { getTooltipStyle } from './tooltipStyle'\n\nexport const tooltip: VChartSpecPipe = (spec, context) => {\n  const result = { ...spec }\n  const { advancedVSeed, vseed } = context\n  const { measures, datasetReshapeInfo, chartType, dimensions, encoding } = advancedVSeed\n  const baseConfig = advancedVSeed.config[chartType] as { tooltip: TooltipConfig }\n  const { tooltip = { enable: true } } = baseConfig\n  const { enable = true } = tooltip\n  const { foldInfo, unfoldInfo } = datasetReshapeInfo[0] as unknown as {\n    foldInfo: FoldInfo\n    unfoldInfo: UnfoldInfo\n  }\n\n  result.tooltip = {\n    style: getTooltipStyle(tooltip),\n    visible: !!enable,\n    mark: {\n      title: {\n        visible: false,\n      },\n      content: createMarkContent(\n        encoding.tooltip || [],\n        dimensions,\n        findAllMeasures(vseed.measures),\n        foldInfo,\n        unfoldInfo,\n      ),\n    },\n    dimension: {\n      title: {\n        visible: true,\n      },\n      content: createDimensionContent(dimensions, measures, foldInfo, unfoldInfo),\n    },\n  }\n  return result\n}\n\nexport const createDimensionContent = (\n  dimensions: Dimensions,\n  measures: Measures,\n  foldInfo: FoldInfo,\n  unfoldInfo: UnfoldInfo,\n) => {\n  const { measureId, measureValue, foldMap } = foldInfo\n  const { encodingColor } = unfoldInfo\n\n  return [\n    {\n      visible: true,\n      shapeType: 'rectRound',\n      hasShape: true,\n      key: dimensions.some((d) => d.encoding === 'color')\n        ? (v: unknown) => {\n            const datum = v as Datum\n            const key = (datum && (datum[encodingColor] as string)) || ''\n            return unfoldInfo.colorIdMap[key].alias ?? key\n          }\n        : (v: unknown) => {\n            const datum = v as Datum\n            const key = (datum && (datum[measureId] as string)) || ''\n            return foldMap[key] ?? key\n          },\n      value: (v: unknown) => {\n        const datum = v as Datum\n        if (!datum) {\n          return ''\n        }\n        const value = datum[measureValue] as string | number\n        const id = datum[measureId] as string\n        const measure = findMeasureById(measures, id)\n        const formatter = createFormatterByMeasure(measure)\n        return formatter(value)\n      },\n    },\n  ]\n}\n\nexport const createMarkContent = (\n  tooltip: string[],\n  dimensions: Dimensions,\n  measures: Measures,\n  foldInfo: FoldInfo,\n  unfoldInfo: UnfoldInfo,\n) => {\n  const dims = pipe(\n    dimensions.filter((item) => tooltip.includes(item.id)),\n    uniqueBy((item) => item.id),\n    uniqueBy((item) => item.alias),\n  )\n  const meas = pipe(\n    measures.filter((item) => tooltip.includes(item.id)),\n    uniqueBy((item) => item.id),\n    uniqueBy((item) => item.alias),\n  )\n\n  const dimContent = dims.map((item) => ({\n    visible: true,\n    hasShape: true,\n    shapeType: 'rectRound',\n    key: (v: unknown) => {\n      const datum = v as Datum\n      if (item.alias || item.id) {\n        return item.alias || item.id\n      }\n      return datum && (datum[item.id] as string)\n    },\n    value: (v: unknown) => {\n      const datum = v as Datum\n      return datum && (datum[item.id] as string)\n    },\n  }))\n\n  const meaContent = meas.map((item) => ({\n    visible: true,\n    hasShape: true,\n    shapeType: 'rectRound',\n    key: item.alias || item.id,\n    value: (v: unknown) => {\n      const datum = v as Datum\n      if (!datum) {\n        return ''\n      }\n      const id = item.id\n      if (!datum || !datum[ORIGINAL_DATA] || !datum[ORIGINAL_DATA]) {\n        return ''\n      }\n      const originalData = datum[ORIGINAL_DATA] as Datum\n      const value = originalData[id] as string | number\n      const measure = findMeasureById(measures, id)\n      const formatter = createFormatterByMeasure(measure)\n      return formatter(value)\n    },\n  }))\n\n  const defaultContent = {\n    visible: true,\n    hasShape: true,\n    shapeType: 'rectRound',\n    key: (v: unknown) => {\n      const { measureName } = foldInfo\n      const { encodingColor: colorName } = unfoldInfo\n\n      const datum = v as Datum\n      return (datum && (datum[measureName || colorName] as string)) || ''\n    },\n    value: (v: unknown) => {\n      const { measureId, measureValue } = foldInfo\n\n      const datum = v as Datum\n      if (!datum) {\n        return ''\n      }\n      const value = datum[measureValue] as string | number\n      const id = datum[measureId] as string\n      const measure = findMeasureById(measures, id)\n      if (!measure) {\n        return String(value)\n      }\n\n      const formatter = createFormatterByMeasure(measure)\n      return formatter(value)\n    },\n  }\n\n  return [...dimContent, defaultContent, ...meaContent]\n}\n"],"names":["tooltip","spec","context","result","advancedVSeed","vseed","measures","datasetReshapeInfo","chartType","dimensions","encoding","baseConfig","enable","foldInfo","unfoldInfo","getTooltipStyle","createMarkContent","findAllMeasures","createDimensionContent","measureId","measureValue","foldMap","encodingColor","d","v","datum","key","value","id","measure","findMeasureById","formatter","createFormatterByMeasure","dims","pipe","item","uniqueBy","meas","dimContent","meaContent","ORIGINAL_DATA","originalData","defaultContent","measureName","colorName","String"],"mappings":"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"}