{"version":3,"file":"pipeline/spec/chart/pipes/annotation/splitLine.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/annotation/splitLine.ts"],"sourcesContent":["import type { ICartesianSeries, IChart, ILineChartSpec, IVChart } from '@visactor/vchart'\nimport { array, clamper, Color as VUtilColor } from '@visactor/vutils'\nimport { isNullish, isNumber, isPlainObject } from 'remeda'\nimport type { AnnotationHorizontalLine, VChartSpecPipe, Color } from 'src/types'\n\ninterface SplitConfig {\n  points: { x: number; y: number }[]\n  splitCoordinate: number\n  lineStroke: {\n    gradient: string\n    x0: number\n    x1: number\n    y0: number\n    y1: number\n    stops: {\n      color: string\n      offset: number\n    }[]\n  }\n  areaFill: {\n    gradient: string\n    x0: number\n    x1: number\n    y0: number\n    y1: number\n    stops: {\n      color: string\n      offset: number\n    }[]\n  }\n}\n\nconst formatGradientStops = (stops: { color: string; offset: number }[]) => {\n  const firstInvalidateIndex = stops.findIndex((stop) => stop.offset < 0 || stop.offset > 1)\n\n  if (firstInvalidateIndex >= 0) {\n    if (stops[firstInvalidateIndex].offset > 1) {\n      const newStops = stops.slice(0, firstInvalidateIndex + 1)\n      newStops[newStops.length - 1].offset = 1\n\n      return newStops\n    }\n    const newStops = stops.slice(firstInvalidateIndex + 1)\n\n    newStops[0].offset = 0\n    return newStops\n  }\n\n  return stops\n}\n\nexport const splitLine: VChartSpecPipe = (spec, context) => {\n  const { advancedVSeed } = context\n  const { annotation, chartType, datasetReshapeInfo } = advancedVSeed\n\n  if (!annotation || !annotation.annotationHorizontalLine) {\n    return spec\n  }\n  const baseConfig = advancedVSeed.config[chartType] as { color: Color }\n\n  const splitLineConfig = array(annotation.annotationHorizontalLine).find(\n    (item) => !!(item as AnnotationHorizontalLine).splitLine,\n  ) as AnnotationHorizontalLine | undefined\n\n  const splitValue = +(splitLineConfig?.yValue as number | string)\n\n  if (Number.isNaN(splitValue) || !isNumber(splitValue)) {\n    return spec\n  }\n  const result = { ...spec } as Partial<ILineChartSpec>\n  const colorTheme = baseConfig?.color ?? {}\n  const colorConfig = {\n    positiveColor: colorTheme.positiveColor || 'red',\n    negativeColor: colorTheme.negativeColor || 'green',\n    ...(isPlainObject(splitLineConfig?.splitLine) ? splitLineConfig?.splitLine : {}),\n  }\n\n  const groupMark = {\n    type: 'group',\n    name: 'annotationHorizontalLine-splitLine',\n    zIndex: 300,\n    style: {\n      splitConfig: (datum: any, ctx: any) => {\n        const vchart = ctx.vchart as IVChart\n        const chart = vchart.getChart() as IChart\n        const lineSeries = chart.getAllSeries().find((s) => s.type === 'line' || s.type === 'area') as ICartesianSeries\n\n        if (!lineSeries) {\n          return\n        }\n        const lineMark = lineSeries.getMarkInName('line') ?? lineSeries.getMarkInName('area')\n\n        if (!lineMark) {\n          return\n        }\n        const lineGraphics = lineMark.getGraphics()\n\n        if (!lineGraphics || lineGraphics.length !== 1 || !lineGraphics[0]) {\n          return\n        }\n        const points = ((lineGraphics[0].attribute as any).points ?? []) as { x: number; y: number }[]\n\n        if ((lineGraphics[0].attribute as any).segments?.length) {\n          ;((lineGraphics[0].attribute as any).segments as any[]).forEach(\n            (seg: { points: { x: number; y: number }[] }) => {\n              seg.points.forEach((pt: { x: number; y: number }) => {\n                points.push({ x: pt.x, y: pt.y })\n              })\n            },\n          )\n        }\n\n        if (!points || !points.length) {\n          return\n        }\n        const scale = lineSeries.getYAxisHelper().getScale!(0)\n        const splitCoordinate = scale.scale(splitValue)\n        const minY = Math.min(...points.map((p) => p.y))\n        const maxY = Math.max(...points.map((p) => p.y))\n        const ratio = (splitCoordinate - minY) / (maxY - minY)\n\n        const lineStroke = {\n          gradient: 'linear',\n          x0: 0,\n          x1: 0,\n          y0: 0,\n          y1: 1,\n          stops: formatGradientStops([\n            {\n              color: colorConfig.positiveColor,\n              offset: 0,\n            },\n            {\n              color: colorConfig.positiveColor,\n              offset: ratio,\n            },\n            {\n              color: colorConfig.negativeColor,\n              offset: ratio + 0.0000001,\n            },\n            {\n              color: colorConfig.negativeColor,\n              offset: 1,\n            },\n          ]),\n        }\n        const areaFill = {\n          gradient: 'linear',\n          x0: 0,\n          x1: 0,\n          y0: 0,\n          y1: 1,\n          stops: formatGradientStops([\n            {\n              color: colorConfig.positiveColor,\n              offset: 0,\n            },\n            {\n              color: new VUtilColor(colorConfig.positiveColor).setOpacity(0).toRGBA(),\n              offset: ratio,\n            },\n            {\n              offset: ratio + 0.0000001,\n              color: new VUtilColor(colorConfig.negativeColor).setOpacity(0).toRGBA(),\n            },\n            {\n              color: colorConfig.negativeColor,\n              offset: 1,\n            },\n          ]),\n        }\n        const attrs: any = {\n          segments: null,\n          points,\n        }\n\n        if (lineGraphics[0].type === 'area') {\n          attrs.stroke = lineStroke\n          attrs.fill = areaFill\n        } else {\n          attrs.stroke = lineStroke\n        }\n\n        lineGraphics[0].setAttributes(attrs as unknown as Record<string, any>)\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-call\n        lineGraphics[0].setFinalAttributes?.(attrs)\n        const start = lineSeries.getRegion().getLayoutStartPoint()\n        const range = scale.range() as number[]\n\n        return {\n          points: points.map((entry) => ({ x: entry.x + start.x, y: entry.y + start.y })),\n          splitCoordinate: clamper(range[0], range[range.length - 1])(splitCoordinate as number) + start.y,\n          areaFill,\n          lineStroke,\n        } as SplitConfig\n      },\n    },\n    children: [\n      {\n        type: 'area',\n        interactive: false,\n        zIndex: 500,\n        style: {\n          fillOpacity: 0.5,\n          points: (datum: any, ctx: any, opt: any) => {\n            const parentNode = opt.mark?._product?.parent\n\n            if (parentNode?.attribute?.splitConfig) {\n              const { points, splitCoordinate } = parentNode.attribute.splitConfig as SplitConfig\n\n              return points.map((entry: { x: number; y: number }) => {\n                return {\n                  ...entry,\n                  y1: splitCoordinate,\n                }\n              })\n            }\n\n            return []\n          },\n          fill: (datum: any, ctx: any, opt: any) => {\n            const parentNode = opt.mark?._product?.parent\n\n            if (parentNode?.attribute?.splitConfig) {\n              const { areaFill } = parentNode.attribute.splitConfig as SplitConfig\n\n              return areaFill\n            }\n\n            return\n          },\n        },\n      },\n    ],\n  }\n\n  if (!result.customMark) {\n    result.customMark = []\n  }\n\n  ;(result.customMark as any[]).push(groupMark)\n\n  const seriesSpec =\n    result.type === 'line' || result.type === 'area'\n      ? result\n      : result.series?.find((s) => s.type === 'line' || s.type === 'area')\n\n  if (seriesSpec) {\n    if (!seriesSpec.point) {\n      seriesSpec.point = {}\n    }\n    if (!seriesSpec.line) {\n      seriesSpec.line = {}\n    }\n\n    if (!seriesSpec.point.style) {\n      seriesSpec.point.style = {}\n    }\n    if (!seriesSpec.line.style) {\n      seriesSpec.line.style = {}\n    }\n\n    const measureValueKey = datasetReshapeInfo[0].foldInfo.measureValue\n\n    seriesSpec.point.style.fill = (datum) => {\n      return datum?.[measureValueKey] < splitValue ? colorConfig.negativeColor : colorConfig.positiveColor\n    }\n    seriesSpec.line.style.stroke = (datum) => {\n      return datum?.[measureValueKey] < splitValue ? colorConfig.negativeColor : colorConfig.positiveColor\n    }\n    if (seriesSpec.label && (seriesSpec.label as any).visible && isNullish((seriesSpec.label as any).style?.fill)) {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n      ;(seriesSpec.label as any).style = {\n        ...(seriesSpec.label as any).style,\n        fill: (datum: any) => {\n          return datum?.[measureValueKey] < splitValue ? colorConfig.negativeColor : colorConfig.positiveColor\n        },\n      }\n    }\n  }\n\n  return result\n}\n"],"names":["formatGradientStops","stops","firstInvalidateIndex","stop","newStops","splitLine","spec","context","advancedVSeed","annotation","chartType","datasetReshapeInfo","baseConfig","splitLineConfig","array","item","splitValue","Number","isNumber","result","colorTheme","colorConfig","isPlainObject","groupMark","datum","ctx","vchart","chart","lineSeries","s","lineMark","lineGraphics","points","seg","pt","scale","splitCoordinate","minY","Math","p","maxY","ratio","lineStroke","areaFill","VUtilColor","attrs","start","range","entry","clamper","opt","parentNode","seriesSpec","measureValueKey","isNullish"],"mappings":"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"}