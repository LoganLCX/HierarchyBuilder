{"version":3,"file":"pipeline/spec/chart/pipes/tooltip/tooltipHistogram.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/tooltip/tooltipHistogram.ts"],"sourcesContent":["import { pipe, uniqueBy, isNullish } from 'remeda'\nimport type { Dimension, Dimensions, Encoding, VChartSpecPipe, Tooltip } from 'src/types'\nimport type { Datum, ISpec, ITooltipLinePattern } from '@visactor/vchart'\nimport { BinEndMeasureId, BinStartMeasureId, ColorEncoding, FoldMeasureValue, XEncoding } from 'src/dataReshape'\nimport { getTooltipStyle } from './tooltipStyle'\nimport { getDefaultValueFormatterOfHistogram, getDefaultXFormatterOfHistogram } from '../../utils/histogram'\n\nconst VCHART_OUTLIER_KEY = '__VCHART_BOX_PLOT_OUTLIER_VALUE'\n\nexport const tooltipHistogram: VChartSpecPipe = (spec, context) => {\n  const result = { ...spec }\n  const { advancedVSeed } = context\n  const { chartType, dimensions, encoding } = advancedVSeed\n  const baseConfig = advancedVSeed.config[chartType] as { tooltip: Tooltip; binValueType: 'count' | 'percentage' }\n  const { binValueType, tooltip = { enable: true } } = baseConfig\n  const { enable } = tooltip\n  const defaultXFormatter = getDefaultXFormatterOfHistogram(advancedVSeed)\n  const defaultValueFormatter = getDefaultValueFormatterOfHistogram(binValueType)\n\n  result.tooltip = {\n    style: getTooltipStyle(tooltip),\n    visible: enable,\n    mark: {\n      title: {\n        visible: false,\n      },\n      content: createMarkContent(\n        encoding.tooltip || [],\n        dimensions,\n        encoding as Encoding,\n        defaultXFormatter,\n        defaultValueFormatter,\n      ),\n    },\n    dimension: {\n      title: {\n        visible: false,\n      },\n      content: createMarkContent(\n        encoding.tooltip || [],\n        dimensions,\n        encoding as Encoding,\n        defaultXFormatter,\n        defaultValueFormatter,\n      ),\n    },\n  }\n  return result as unknown as ISpec\n}\n\nconst createMarkContent = (\n  tooltip: string[],\n  dimensions: Dimensions,\n  encoding: Encoding,\n  dimFormatter: (value: number) => string,\n  defaultValueFormatter: (value: number | string) => string,\n) => {\n  const dims = pipe(\n    dimensions.filter((item) => tooltip.includes(item.id)),\n    uniqueBy((item: Dimension) => item.id),\n    uniqueBy((item: Dimension) => item.alias),\n  )\n\n  const dimContent = dims.map((item: Dimension) => ({\n    visible: true,\n    hasShape: true,\n    shapeType: 'rectRound',\n    key: item.alias ?? item.id,\n    value: (datum: Datum | undefined) => {\n      if (!isNullish(datum?.[VCHART_OUTLIER_KEY])) {\n        if (encoding.color?.includes(item.id)) {\n          return datum?.[ColorEncoding] as string\n        }\n        if (encoding.x?.includes(item.id)) {\n          return datum?.[XEncoding] as string\n        }\n      }\n\n      return defaultValueFormatter(datum?.[item.id] as string)\n    },\n  }))\n\n  const defaultContent = [\n    {\n      visible: true,\n      hasShape: true,\n      shapeType: 'rectRound',\n      key: (datum: Datum | undefined) => {\n        if (!datum) {\n          return ''\n        }\n        return `[${dimFormatter(+datum[BinStartMeasureId])}, ${dimFormatter(+datum[BinEndMeasureId])})`\n      },\n      value: (datum: Datum | undefined) => {\n        if (!datum) {\n          return ''\n        }\n        return defaultValueFormatter(datum[FoldMeasureValue] as string | number)\n      },\n    },\n  ]\n\n  return [...dimContent, defaultContent] as ITooltipLinePattern[]\n}\n"],"names":["VCHART_OUTLIER_KEY","tooltipHistogram","spec","context","result","advancedVSeed","chartType","dimensions","encoding","baseConfig","binValueType","tooltip","enable","defaultXFormatter","getDefaultXFormatterOfHistogram","defaultValueFormatter","getDefaultValueFormatterOfHistogram","getTooltipStyle","createMarkContent","dimFormatter","dims","pipe","item","uniqueBy","dimContent","datum","isNullish","ColorEncoding","XEncoding","defaultContent","BinStartMeasureId","BinEndMeasureId","FoldMeasureValue"],"mappings":";;;;AAOA,MAAMA,qBAAqB;AAEpB,MAAMC,mBAAmC,CAACC,MAAMC;IACrD,MAAMC,SAAS;QAAE,GAAGF,IAAI;IAAC;IACzB,MAAM,EAAEG,aAAa,EAAE,GAAGF;IAC1B,MAAM,EAAEG,SAAS,EAAEC,UAAU,EAAEC,QAAQ,EAAE,GAAGH;IAC5C,MAAMI,aAAaJ,cAAc,MAAM,CAACC,UAAU;IAClD,MAAM,EAAEI,YAAY,EAAEC,UAAU;QAAE,QAAQ;IAAK,CAAC,EAAE,GAAGF;IACrD,MAAM,EAAEG,MAAM,EAAE,GAAGD;IACnB,MAAME,oBAAoBC,gCAAgCT;IAC1D,MAAMU,wBAAwBC,oCAAoCN;IAElEN,OAAO,OAAO,GAAG;QACf,OAAOa,gBAAgBN;QACvB,SAASC;QACT,MAAM;YACJ,OAAO;gBACL,SAAS;YACX;YACA,SAASM,kBACPV,SAAS,OAAO,IAAI,EAAE,EACtBD,YACAC,UACAK,mBACAE;QAEJ;QACA,WAAW;YACT,OAAO;gBACL,SAAS;YACX;YACA,SAASG,kBACPV,SAAS,OAAO,IAAI,EAAE,EACtBD,YACAC,UACAK,mBACAE;QAEJ;IACF;IACA,OAAOX;AACT;AAEA,MAAMc,oBAAoB,CACxBP,SACAJ,YACAC,UACAW,cACAJ;IAEA,MAAMK,OAAOC,KACXd,WAAW,MAAM,CAAC,CAACe,OAASX,QAAQ,QAAQ,CAACW,KAAK,EAAE,IACpDC,SAAS,CAACD,OAAoBA,KAAK,EAAE,GACrCC,SAAS,CAACD,OAAoBA,KAAK,KAAK;IAG1C,MAAME,aAAaJ,KAAK,GAAG,CAAC,CAACE,OAAqB;YAChD,SAAS;YACT,UAAU;YACV,WAAW;YACX,KAAKA,KAAK,KAAK,IAAIA,KAAK,EAAE;YAC1B,OAAO,CAACG;gBACN,IAAI,CAACC,UAAUD,OAAO,CAACzB,mBAAmB,GAAG;oBAC3C,IAAIQ,SAAS,KAAK,EAAE,SAASc,KAAK,EAAE,GAClC,OAAOG,OAAO,CAACE,cAAc;oBAE/B,IAAInB,SAAS,CAAC,EAAE,SAASc,KAAK,EAAE,GAC9B,OAAOG,OAAO,CAACG,UAAU;gBAE7B;gBAEA,OAAOb,sBAAsBU,OAAO,CAACH,KAAK,EAAE,CAAC;YAC/C;QACF;IAEA,MAAMO,iBAAiB;QACrB;YACE,SAAS;YACT,UAAU;YACV,WAAW;YACX,KAAK,CAACJ;gBACJ,IAAI,CAACA,OACH,OAAO;gBAET,OAAO,CAAC,CAAC,EAAEN,aAAa,CAACM,KAAK,CAACK,kBAAkB,EAAE,EAAE,EAAEX,aAAa,CAACM,KAAK,CAACM,gBAAgB,EAAE,CAAC,CAAC;YACjG;YACA,OAAO,CAACN;gBACN,IAAI,CAACA,OACH,OAAO;gBAET,OAAOV,sBAAsBU,KAAK,CAACO,iBAAiB;YACtD;QACF;KACD;IAED,OAAO;WAAIR;QAAYK;KAAe;AACxC"}