{"version":3,"file":"pipeline/spec/chart/pipes/regressionLine/ecdfRegressionLine.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/regressionLine/ecdfRegressionLine.ts"],"sourcesContent":["import type { ICartesianSeries, IChart, IHistogramChartSpec, IVChart } from '@visactor/vchart'\nimport { isNullish, uniqueBy } from 'remeda'\nimport { ecdf, array, isArray } from '@visactor/vutils'\nimport type { Datum, Dimension, VChartSpecPipe, Encoding, RegressionLineConfig, EcdfRegressionLine } from 'src/types'\nimport { defaultRegressionLineColor, defaultRegressionLineLabelX, defaultRegressionLineLabelY } from './common'\n\nexport const ecdfRegressionLine: VChartSpecPipe = (spec, context) => {\n  const result = { ...spec } as IHistogramChartSpec\n  const { advancedVSeed, vseed } = context\n  const { chartType, encoding = {} as Encoding, dimensions, regressionLine } = advancedVSeed\n  const { dataset } = vseed\n  const lineTheme = advancedVSeed.config[chartType as 'histogram']?.regressionLine as RegressionLineConfig\n\n  if (!regressionLine || !regressionLine.ecdfRegressionLine) {\n    return result\n  }\n\n  const rowColumnFields = uniqueBy(\n    dimensions.filter((dim: Dimension) => dim.encoding === 'row' || dim.encoding === 'column'),\n    (item: Dimension) => item.id,\n  )\n\n  const lineList = array(regressionLine.ecdfRegressionLine).filter((ecdfLine) => ecdfLine.enable !== false)\n\n  if (!result.extensionMark) {\n    result.extensionMark = []\n  }\n\n  lineList.forEach((line, lineIndex) => {\n    if (line.enable === false) {\n      return\n    }\n    const theme = (lineTheme?.ecdfRegressionLine ?? {}) as EcdfRegressionLine\n    const { color, lineWidth, lineDash, text, textColor, textFontSize, textFontWeight } = line as EcdfRegressionLine\n\n    const childrenMarks: any[] = []\n\n    ;(result.extensionMark as any[]).push({\n      type: 'group',\n      interactive: false,\n      zIndex: 500,\n      name: `ecdfRegressionLine-${lineIndex}`,\n      dataId: (spec.data as any)?.id,\n      style: {\n        data: (datum: any, ctx: any) => {\n          const vchart = ctx.vchart as IVChart\n          const chart = vchart.getChart() as IChart\n          const series = chart.getAllSeries().filter((s: any) => s.type === 'bar')\n\n          // 直方图使用的是bar系列\n          if (series && series.length) {\n            const s = series[0] as ICartesianSeries\n\n            const fieldX = s.fieldX?.[0]\n            const scaleY = s.getYAxisHelper().getScale?.(0)\n            const viewData = s.getViewData()?.latestData\n\n            if (!dataset || !dataset.length || !viewData || !viewData.length || !scaleY) {\n              return null\n            }\n            const simpleData = dataset\n              .filter((entry: Datum) => {\n                return rowColumnFields.length\n                  ? rowColumnFields.every((dim: Dimension) => {\n                      return entry[dim.id] === viewData[0][dim.id]\n                    })\n                  : true\n              })\n              .map((d: Datum) => +(d as any)[encoding.value?.[0] as string])\n            const res = ecdf(simpleData)\n            const N = Math.max(3, Math.floor(simpleData.length / 4))\n            const lineData = res.evaluateGrid(N)\n            const yRange = scaleY.range()\n            const y0 = yRange[0]\n            const y1 = yRange[yRange.length - 1]\n            const scaleR = (e: number) => {\n              return y0 + (y1 - y0) * e\n            }\n\n            const linePoints = lineData.map((ld: Datum) => {\n              const d = { [fieldX]: ld.x }\n              return {\n                x: s.dataToPositionX(d)!,\n                y: scaleR(ld.y as number),\n              }\n            })\n\n            return {\n              linePoints,\n              color: color ?? s.getOption().globalScale.getScale('color')?.scale(s.getSeriesKeys()[0]),\n            }\n          }\n          return null\n        },\n      },\n      children: childrenMarks,\n    })\n\n    childrenMarks.push({\n      type: 'line',\n      interactive: false,\n      zIndex: 500,\n      dataId: (spec.data as any)?.id,\n      style: {\n        lineWidth: lineWidth ?? theme.lineWidth,\n        lineDash: lineDash ?? theme.lineDash,\n        stroke: color ?? defaultRegressionLineColor,\n        points: (datum: any, ctx: any, opt: any) => {\n          const parentNode = opt.mark?._product?.parent\n\n          if (parentNode?.attribute?.data) {\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n            return parentNode.attribute.data.linePoints\n          }\n\n          return []\n        },\n      },\n    })\n\n    if (!isNullish(text)) {\n      childrenMarks.push({\n        type: 'text',\n        interactive: false,\n        zIndex: 500,\n        dataId: (spec.data as any)?.id,\n        dataKey: () => {\n          return `ecdfRegressionLine-label-${lineIndex}`\n        },\n        style: {\n          textAlign: 'end',\n          fill: textColor ?? theme.textColor,\n          fontSize: textFontSize ?? theme.textFontSize,\n          fontWeight: textFontWeight ?? theme.textFontWeight,\n          text: text,\n          x: defaultRegressionLineLabelX,\n          y: defaultRegressionLineLabelY,\n        },\n      })\n    }\n  })\n\n  // add percent axis of ecdf\n  const leftAxis = result.axes?.find((v) => v.orient === 'left')\n  if (leftAxis && lineList.length) {\n    result.axes?.push({\n      visible: true,\n      orient: 'right',\n      type: 'linear',\n      base: 10,\n      min: 0,\n      max: 1,\n      domainLine: {\n        ...leftAxis.domainLine,\n      },\n      grid: {\n        visible: false,\n      },\n      tick: {\n        ...leftAxis.tick,\n      },\n      title: {\n        ...leftAxis.title,\n        visible: false,\n      },\n      label: {\n        ...leftAxis.label,\n        visible: true,\n        formatMethod: (v) => {\n          const text = isArray(v) ? v[0] : v\n          return `${(+text * 100).toFixed(1)}%`\n        },\n      },\n    })\n  }\n\n  return result\n}\n"],"names":["ecdfRegressionLine","spec","context","result","advancedVSeed","vseed","chartType","encoding","dimensions","regressionLine","dataset","lineTheme","rowColumnFields","uniqueBy","dim","item","lineList","array","ecdfLine","line","lineIndex","theme","color","lineWidth","lineDash","text","textColor","textFontSize","textFontWeight","childrenMarks","datum","ctx","vchart","chart","series","s","fieldX","scaleY","viewData","simpleData","entry","d","res","ecdf","N","Math","lineData","yRange","y0","y1","scaleR","e","linePoints","ld","defaultRegressionLineColor","opt","parentNode","isNullish","defaultRegressionLineLabelX","defaultRegressionLineLabelY","leftAxis","v","isArray"],"mappings":"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"}