{"version":3,"file":"pipeline/spec/chart/pipes/regressionLine/linearRegressionLine.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/regressionLine/linearRegressionLine.ts"],"sourcesContent":["import type { ICartesianSeries, IChart, IScatterChartSpec, IVChart } from '@visactor/vchart'\nimport { isNullish } from 'remeda'\nimport {\n  array,\n  clamper,\n  regressionLinear,\n  regressionLowess,\n  regressionPolynomial,\n  regressionLogistic,\n} from '@visactor/vutils'\nimport type {\n  Datum,\n  VChartSpecPipe,\n  RegressionLineConfig,\n  LinearRegressionLine,\n  PolynomialRegressionLine,\n  SpecPipelineContext,\n  LogisticRegressionLine,\n  LowessRegressionLine,\n} from 'src/types'\nimport { getAlphaByConfidenceLevel } from './common'\n\nexport const generateRegressionLinePipe = (\n  type: 'linearRegressionLine' | 'lowessRegressionLine' | 'polynomialRegressionLine' | 'logisticRegressionLine',\n  regressionFunction: (\n    arr: Datum[],\n    xAccessor: (d: Datum) => number,\n    yAccessor: (d: Datum) => number,\n    options?: any,\n  ) => {\n    confidenceInterval: (N: number) => { lower: number; upper: number; x: number }[]\n    evaluateGrid: (N: number) => { x: number; y: number }[]\n  },\n  getOptions: (lineConfig: any) => any = getDefaultRegressionOptions,\n  getMinPoints: (lineConfig: any) => number = () => 2,\n): VChartSpecPipe => {\n  return ((spec: Partial<IScatterChartSpec>, context: SpecPipelineContext): Partial<IScatterChartSpec> => {\n    const result = { ...spec }\n    const { advancedVSeed } = context\n    const { chartType, regressionLine } = advancedVSeed\n    const lineTheme = advancedVSeed.config[chartType as 'scatter']?.regressionLine as RegressionLineConfig\n\n    if (!regressionLine || !regressionLine[type]) {\n      return result\n    }\n\n    const lineList = array(regressionLine[type])\n\n    if (!result.extensionMark) {\n      result.extensionMark = []\n    }\n\n    lineList.forEach((line, lineIndex) => {\n      if (line.enable === false) {\n        return\n      }\n\n      const theme = (lineTheme.linearRegressionLine ?? {}) as LinearRegressionLine\n      const {\n        color,\n        lineWidth,\n        lineDash,\n        text,\n        textColor,\n        textFontSize,\n        textFontWeight,\n        confidenceIntervalOpacity,\n        confidenceIntervalVisible = theme.confidenceIntervalVisible,\n      } = line as LinearRegressionLine\n\n      const childrenMarks: any[] = []\n\n      ;(result.extensionMark as any[]).push({\n        type: 'group',\n        interactive: false,\n        zIndex: 500,\n        name: `${type}-${lineIndex}`,\n        layoutType: 'region-relative',\n        dataId: (spec.data as any)?.id,\n        animation: false,\n        style: {\n          data: (datum: any, ctx: any) => {\n            const vchart = ctx.vchart as IVChart\n            const chart = vchart.getChart() as IChart\n            const s = chart.getAllSeries()[0] as ICartesianSeries\n\n            if (s) {\n              const rect = s.getRegion().getLayoutRect()\n              const segments: {\n                areaPoints?: { x: number; y: number; y1: number }[]\n                linePoints: { x: number; y: number }[]\n                color: string\n              }[] = []\n\n              if (rect.width === 0 || rect.height === 0) {\n                return segments\n              }\n\n              const yClamper = clamper(0, rect.height)\n              const colorAttrOptions = s.getColorAttribute()\n              const groups: (string | undefined)[] = s.getSeriesKeys()\n              const data = s.getViewData()?.latestData as Datum[]\n              const fieldX = s.fieldX?.[0]\n              const fieldY = s.fieldY?.[0]\n\n              if (!groups.length) {\n                groups.push(undefined)\n              }\n\n              groups.forEach((group) => {\n                const groupData = data.filter((d: Datum) => d[colorAttrOptions?.field] === group)\n\n                const minPoints = getMinPoints(line)\n\n                if (groupData.length < minPoints) {\n                  return\n                }\n                const { confidenceInterval, evaluateGrid } = regressionFunction(\n                  groupData,\n                  (datum: Datum) => datum?.[fieldX],\n                  (datum: Datum) => datum?.[fieldY],\n                  getOptions?.(line),\n                )\n                const N = Math.max(3, Math.floor(groupData.length / 4))\n                const mainColor = color ?? colorAttrOptions?.scale?.scale(group)\n\n                const lineData = evaluateGrid(N)\n                const linePoints: { x: number; y: number }[] = []\n\n                lineData.forEach((ld: Datum, index: number) => {\n                  const d = { [fieldX]: ld.x, [fieldY]: ld.y }\n                  const x = s.dataToPositionX(d)!\n                  const y = yClamper(s.dataToPositionY(d)!)\n\n                  if (segments.length && index === 0) {\n                    segments[segments.length - 1].linePoints.push({ x, y: NaN }) // 断开线段用的\n                  }\n\n                  linePoints.push({\n                    x,\n                    y,\n                  })\n                })\n\n                const segment: {\n                  color: string\n                  linePoints: { x: number; y: number }[]\n                  areaPoints?: { x: number; y: number; y1: number }[]\n                } = {\n                  color: mainColor,\n                  linePoints,\n                }\n\n                if (confidenceIntervalVisible) {\n                  const intervalData = confidenceInterval(N)\n                  const areaPoints: { x: number; y: number; y1: number }[] = []\n\n                  intervalData.map((datum: Datum, index: number) => {\n                    const d = { [fieldX]: datum.x, [fieldY]: datum.lower }\n                    const x = s.dataToPositionX(d)!\n                    const y = yClamper(s.dataToPositionY(d)!)\n                    const y1 = yClamper(s.dataToPositionY({ [fieldY]: datum.upper })!)\n\n                    if (segments.length && index === 0) {\n                      segments[segments.length - 1].areaPoints!.push({ x, y: NaN, y1: NaN }) // 断开线段用的\n                    }\n\n                    areaPoints.push({ x, y, y1 })\n                  })\n\n                  segment.areaPoints = areaPoints\n                }\n\n                segments.push(segment)\n              })\n\n              return segments\n            }\n            return []\n          },\n        },\n        children: childrenMarks,\n      })\n\n      if (confidenceIntervalVisible) {\n        childrenMarks.push({\n          type: 'area',\n          interactive: false,\n          zIndex: 500,\n          dataId: (spec.data as any)?.id,\n          style: {\n            stroke: false,\n            lineWidth: lineWidth ?? theme.lineWidth,\n            lineDash: lineDash ?? theme.lineDash,\n            fillOpacity: confidenceIntervalOpacity ?? theme.confidenceIntervalOpacity,\n            fill: 'red', // vrender bug，必须要设置一个全局的fill，才会绘制\n            segments: (datum: any, ctx: any, opt: any) => {\n              const parentNode = opt.mark?._product?.parent\n\n              if (parentNode) {\n                const data = parentNode.finalAttribute?.data ?? parentNode.attribute?.data\n\n                if (data?.length) {\n                  // eslint-disable-next-line @typescript-eslint/no-unsafe-return, @typescript-eslint/no-unsafe-call\n                  return data.map((d: any) => {\n                    return {\n                      points: d.areaPoints ?? [],\n                      fill: d.color,\n                    }\n                  })\n                }\n              }\n\n              return []\n            },\n          },\n        })\n      }\n\n      childrenMarks.push({\n        type: 'line',\n        interactive: false,\n        zIndex: 500,\n        animation: false,\n        dataId: (spec.data as any)?.id,\n        style: {\n          lineWidth: lineWidth ?? theme.lineWidth,\n          lineDash: lineDash ?? theme.lineDash,\n          stroke: 'red', // vrender bug，必须要设置一个全局的stroke，才会绘制\n          segments: (datum: any, ctx: any, opt: any) => {\n            const parentNode = opt.mark?._product?.parent\n\n            if (parentNode) {\n              const data = parentNode.finalAttribute?.data ?? parentNode.attribute?.data\n              if (data?.length) {\n                // eslint-disable-next-line @typescript-eslint/no-unsafe-return, @typescript-eslint/no-unsafe-call\n                return data.map((d: any) => {\n                  return {\n                    points: d.linePoints,\n                    stroke: d.color,\n                  }\n                })\n              }\n            }\n\n            return []\n          },\n        },\n      })\n\n      if (!isNullish(text)) {\n        childrenMarks.push({\n          type: 'text',\n          interactive: false,\n          zIndex: 500,\n          animation: false,\n          dataId: (spec.data as any)?.id,\n          dataKey: () => {\n            return `regressionLine-label-${lineIndex}`\n          },\n          style: {\n            textAlign: 'end',\n            fill: textColor ?? theme.textColor,\n            fontSize: textFontSize ?? theme.textFontSize,\n            fontWeight: textFontWeight ?? theme.textFontWeight,\n            text: text,\n            x: (datum: any, ctx: any, opt: any) => {\n              const parentNode = opt.mark?._product?.parent\n\n              if (parentNode?.attribute?.data?.length) {\n                const point = parentNode.attribute.data[parentNode.attribute.data.length - 1].linePoints\n                return point[point.length - 1]?.x\n              }\n\n              return undefined\n            },\n            y: (datum: any, ctx: any, opt: any) => {\n              const parentNode = opt.mark?._product?.parent\n\n              if (parentNode?.attribute?.data?.length) {\n                const point = parentNode.attribute.data[parentNode.attribute.data.length - 1].linePoints\n                return point[point.length - 1]?.y\n              }\n\n              return undefined\n            },\n          },\n        })\n      }\n    })\n\n    return result\n  }) as VChartSpecPipe\n}\n\nconst getDefaultRegressionOptions = (\n  lineConfig: PolynomialRegressionLine | LinearRegressionLine | LogisticRegressionLine | LowessRegressionLine,\n) => {\n  const alpha = getAlphaByConfidenceLevel(lineConfig?.confidenceLevel)\n  return { alpha }\n}\n\nexport const linearRegressionLine: VChartSpecPipe = generateRegressionLinePipe(\n  'linearRegressionLine',\n  regressionLinear,\n  getDefaultRegressionOptions,\n)\nexport const lowessRegressionLine: VChartSpecPipe = generateRegressionLinePipe(\n  'lowessRegressionLine',\n  regressionLowess,\n  getDefaultRegressionOptions,\n)\nexport const polynomialRegressionLine: VChartSpecPipe = generateRegressionLinePipe(\n  'polynomialRegressionLine',\n  regressionPolynomial,\n  (lineConfig: PolynomialRegressionLine) => {\n    return { ...getDefaultRegressionOptions(lineConfig), degree: lineConfig.degree ?? 2 }\n  },\n  (lineConfig: PolynomialRegressionLine) => (lineConfig.degree ?? 2) + 1,\n)\nexport const logisticRegressionLine: VChartSpecPipe = generateRegressionLinePipe(\n  'logisticRegressionLine',\n  regressionLogistic,\n  getDefaultRegressionOptions,\n)\n"],"names":["generateRegressionLinePipe","type","regressionFunction","getOptions","getDefaultRegressionOptions","getMinPoints","spec","context","result","advancedVSeed","chartType","regressionLine","lineTheme","lineList","array","line","lineIndex","theme","color","lineWidth","lineDash","text","textColor","textFontSize","textFontWeight","confidenceIntervalOpacity","confidenceIntervalVisible","childrenMarks","datum","ctx","vchart","chart","s","rect","segments","yClamper","clamper","colorAttrOptions","groups","data","fieldX","fieldY","undefined","group","groupData","d","minPoints","confidenceInterval","evaluateGrid","N","Math","mainColor","lineData","linePoints","ld","index","x","y","NaN","segment","intervalData","areaPoints","y1","opt","parentNode","isNullish","point","lineConfig","alpha","getAlphaByConfidenceLevel","linearRegressionLine","regressionLinear","lowessRegressionLine","regressionLowess","polynomialRegressionLine","regressionPolynomial","logisticRegressionLine","regressionLogistic"],"mappings":"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"}