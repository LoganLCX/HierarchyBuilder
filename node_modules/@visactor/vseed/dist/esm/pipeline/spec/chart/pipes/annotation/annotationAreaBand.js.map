{"version":3,"file":"pipeline/spec/chart/pipes/annotation/annotationAreaBand.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/annotation/annotationAreaBand.ts"],"sourcesContent":["import { type ICartesianSeries, type ILineChartSpec } from '@visactor/vchart'\nimport { selector } from '../../../../../dataSelector'\nimport type { Datum, VChartSpecPipe, VSeed } from 'src/types'\nimport { ANNOTATION_AREA_TEXT_STYLE_BY_POSITION, isSubset } from './utils'\nimport { ANNOTATION_Z_INDEX } from '../../../../utils/constant'\nimport { isBarLikeChart } from 'src/pipeline/utils/chatType'\n\nexport const annotationAreaBand: VChartSpecPipe = (spec, context) => {\n  const { advancedVSeed, vseed } = context\n  const { annotation, config } = advancedVSeed\n\n  if (!annotation || !annotation.annotationArea) {\n    return spec\n  }\n  const theme = config?.[vseed.chartType as 'column']?.annotation?.annotationArea\n  const { annotationArea } = annotation\n  const annotationAreaList = Array.isArray(annotationArea) ? annotationArea : [annotationArea]\n\n  const positionMap = {\n    top: 'insideTop',\n    topRight: 'insideTopRight',\n    topLeft: 'insideTopLeft',\n    bottom: 'insideBottom',\n    bottomLeft: 'insideBottomLeft',\n    bottomRight: 'insideBottomRight',\n    left: 'insideLeft',\n    right: 'insideRight',\n  }\n  const defaultTextPosition = isBarLikeChart(advancedVSeed as VSeed) ? 'right' : 'top'\n\n  const markArea = annotationAreaList.flatMap((annotationArea) => {\n    const {\n      selector: selectorPoint,\n      text = '',\n      textColor = theme?.textColor ?? '#ffffff',\n      textFontSize = theme?.textFontSize ?? 12,\n      textFontWeight = theme?.textFontWeight ?? 400,\n\n      textBackgroundVisible = theme?.textBackgroundVisible ?? true,\n      textBackgroundColor = theme?.textBackgroundColor ?? '#191d24',\n      textBackgroundBorderColor = theme?.textBackgroundBorderColor ?? '#191d24',\n      textBackgroundBorderWidth = theme?.textBackgroundBorderWidth ?? 1,\n      textBackgroundBorderRadius = theme?.textBackgroundBorderRadius ?? 4,\n      textBackgroundPadding = theme?.textBackgroundPadding ?? 4,\n\n      areaColor = theme?.areaColor ?? '#888888',\n      areaColorOpacity = theme?.areaColorOpacity ?? 0.15,\n      areaBorderColor = theme?.areaBorderColor ?? '#888888',\n      areaBorderRadius = theme?.areaBorderRadius ?? 4,\n      areaBorderWidth = theme?.areaBorderWidth ?? 1,\n      areaLineDash = theme?.areaLineDash,\n\n      outerPadding = theme?.outerPadding ?? 4,\n    } = annotationArea\n    const textPosition: string = annotationArea.textPosition ?? defaultTextPosition\n    const textAlign =\n      annotationArea.textAlign ??\n      ANNOTATION_AREA_TEXT_STYLE_BY_POSITION[textPosition as keyof typeof ANNOTATION_AREA_TEXT_STYLE_BY_POSITION]\n        .textAlign\n    const textBaseline =\n      annotationArea.textBaseline ??\n      ANNOTATION_AREA_TEXT_STYLE_BY_POSITION[textPosition as keyof typeof ANNOTATION_AREA_TEXT_STYLE_BY_POSITION]\n        .textBaseline\n\n    const dataset = advancedVSeed.dataset.flat()\n    const selectedData = selectorPoint ? dataset.filter((datum) => selector(datum, selectorPoint)) : []\n\n    return {\n      zIndex: ANNOTATION_Z_INDEX,\n      regionRelative: true,\n      // coordinates: selectedData,\n      positions: (data: Datum[], context: ICartesianSeries & { _scaleConfig?: { bandPosition?: number } }) => {\n        const positionData = data.filter((item) => selectedData.some((datum) => isSubset(datum, item)))\n        const xyList = positionData.map((datum) => context.dataToPosition(datum) as { x: number; y: number })\n\n        const bandPosition = context?._scaleConfig?.bandPosition || 0\n\n        const yAxisHelper = context.getYAxisHelper() as unknown as {\n          getBandwidth: (depth?: number) => number\n          getScale: () => {\n            range: () => number[]\n          }\n        }\n        const xAxisHelper = context.getXAxisHelper() as unknown as {\n          getBandwidth: (depth?: number) => number\n          getScale: () => {\n            range: () => number[]\n          }\n        }\n\n        if (typeof xAxisHelper?.getBandwidth === 'function') {\n          const depth = context.fieldX.length ?? 0\n          const xBandWidth = xAxisHelper?.getBandwidth?.(depth - 1)\n          const regionRect = context.getRegion().getLayoutRect()\n          const startX = Math.min(...xyList.map((item) => item.x)) - (outerPadding || 4)\n          const endX = Math.max(...xyList.map((item) => item.x)) + (outerPadding || 4)\n\n          const width = endX - startX + xBandWidth\n          const middleX = (endX + startX) / 2 + xBandWidth * (0.5 - bandPosition)\n\n          const minX = middleX - width / 2\n          const maxX = middleX + width / 2\n\n          const minY = 0\n          const maxY = regionRect.height\n\n          return [\n            // 左上\n            {\n              x: minX,\n              y: minY,\n            },\n            // 右上\n            {\n              x: maxX,\n              y: minY,\n            },\n            // 右下\n            {\n              x: maxX,\n              y: maxY,\n            },\n            // 左下\n            {\n              x: minX,\n              y: maxY,\n            },\n          ]\n        }\n\n        if (typeof yAxisHelper?.getBandwidth === 'function') {\n          const depth = context.fieldY.length ?? 0\n          const yBandWidth = yAxisHelper?.getBandwidth?.(depth - 1)\n          const regionRect = context.getRegion().getLayoutRect()\n\n          const startY = Math.min(...xyList.map((item) => item.y)) - (outerPadding || 4)\n          const endY = Math.max(...xyList.map((item) => item.y)) + (outerPadding || 4)\n          const width = endY - startY + yBandWidth\n          const middleY = (endY + startY) / 2 + yBandWidth * (0.5 - bandPosition)\n\n          const minY = middleY - width / 2\n          const maxY = middleY + width / 2\n          const minX = 0\n          const maxX = regionRect.width\n\n          return [\n            // 左上\n            {\n              x: minX,\n              y: minY,\n            },\n            // 右上\n            {\n              x: maxX,\n              y: minY,\n            },\n            // 右下\n            {\n              x: maxX,\n              y: maxY,\n            },\n            // 左下\n            {\n              x: minX,\n              y: maxY,\n            },\n          ]\n        }\n\n        return []\n      },\n      label: {\n        position: positionMap[textPosition as 'bottom'],\n        visible: true,\n        text: text,\n        style: {\n          opacity: 0.95,\n          textAlign: textAlign,\n          textBaseline: textBaseline,\n          stroke: textBackgroundColor,\n          lineWidth: 1,\n          fill: textColor,\n          fontSize: textFontSize,\n          fontWeight: textFontWeight,\n        },\n\n        labelBackground: {\n          visible: textBackgroundVisible,\n          padding: textBackgroundPadding,\n          style: {\n            opacity: 0.95,\n            cornerRadius: textBackgroundBorderRadius ?? 4,\n            fill: textBackgroundColor,\n            stroke: textBackgroundBorderColor,\n            lineWidth: textBackgroundBorderWidth,\n            fillOpacity: 1,\n          },\n        },\n      },\n      area: {\n        style: {\n          visible: true,\n          fill: areaColor,\n          fillOpacity: areaColorOpacity,\n          stroke: areaBorderColor,\n          lineWidth: areaBorderWidth,\n          cornerRadius: areaBorderRadius,\n          lineDash: areaLineDash,\n        },\n      },\n    }\n  }) as ILineChartSpec['markArea']\n\n  return {\n    ...spec,\n    markArea: markArea,\n  }\n}\n"],"names":["annotationAreaBand","spec","context","advancedVSeed","vseed","annotation","config","theme","annotationArea","annotationAreaList","Array","positionMap","defaultTextPosition","isBarLikeChart","markArea","selectorPoint","text","textColor","textFontSize","textFontWeight","textBackgroundVisible","textBackgroundColor","textBackgroundBorderColor","textBackgroundBorderWidth","textBackgroundBorderRadius","textBackgroundPadding","areaColor","areaColorOpacity","areaBorderColor","areaBorderRadius","areaBorderWidth","areaLineDash","outerPadding","textPosition","textAlign","ANNOTATION_AREA_TEXT_STYLE_BY_POSITION","textBaseline","dataset","selectedData","datum","selector","ANNOTATION_Z_INDEX","data","positionData","item","isSubset","xyList","bandPosition","yAxisHelper","xAxisHelper","depth","xBandWidth","regionRect","startX","Math","endX","width","middleX","minX","maxX","minY","maxY","yBandWidth","startY","endY","middleY"],"mappings":"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"}