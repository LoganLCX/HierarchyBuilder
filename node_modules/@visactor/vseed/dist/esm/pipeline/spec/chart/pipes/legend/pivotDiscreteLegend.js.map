{"version":3,"file":"pipeline/spec/chart/pipes/legend/pivotDiscreteLegend.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/legend/pivotDiscreteLegend.ts"],"sourcesContent":["import type { PivotChartConstructorOptions } from '@visactor/vtable'\nimport { unique } from 'remeda'\nimport type { Color, Legend, PivotChartSpecPipe } from 'src/types'\nimport { createSpecifiedForColorMapping } from '../color/color'\n\nexport const pivotDiscreteLegend: PivotChartSpecPipe = (spec, context): Partial<PivotChartConstructorOptions> => {\n  const result = { ...spec } as PivotChartConstructorOptions\n  const { advancedVSeed } = context\n  const { chartType } = advancedVSeed\n  const baseConfig = advancedVSeed.config[chartType] as { legend: Legend; color: Color }\n\n  if (!baseConfig || !baseConfig.legend) {\n    return result\n  }\n\n  const { datasetReshapeInfo } = advancedVSeed\n\n  const colorItems = unique(\n    datasetReshapeInfo.flatMap((d) => {\n      return d.unfoldInfo.colorItems\n    }),\n  )\n\n  const colorIdMap = datasetReshapeInfo.reduce<Record<string, { id: string; alias: string }>>((prev, cur) => {\n    return { ...prev, ...cur.unfoldInfo.colorIdMap }\n  }, {})\n\n  const { legend, color } = baseConfig\n  const { colorScheme, colorMapping } = color\n\n  const colorSpecified = createSpecifiedForColorMapping(colorMapping, colorIdMap, colorItems)\n\n  const {\n    enable,\n    position = 'bottom',\n    labelFontColor,\n    labelColor,\n    labelFontSize = 12,\n    labelFontWeight = 400,\n    maxSize = 1,\n    border,\n    shapeType = 'rectRound',\n  } = legend || {}\n\n  const orient = ['bottom', 'bottomLeft', 'bottomRight', 'bl', 'br'].includes(position)\n    ? 'bottom'\n    : ['top', 'topLeft', 'topRight', 'tl', 'tr'].includes(position)\n      ? 'top'\n      : ['left', 'leftTop', 'leftBottom', 'lt', 'lb'].includes(position)\n        ? 'left'\n        : 'right'\n\n  const legendPosition = ['topLeft', 'bottomLeft', 'leftTop', 'rightTop', 'lt', 'rt', 'tl', 'bl'].includes(position)\n    ? 'start'\n    : ['topRight', 'bottomRight', 'leftBottom', 'rightBottom', 'lb', 'rb', 'rt', 'br'].includes(position)\n      ? 'end'\n      : 'middle'\n\n  const legends = {\n    padding: 0,\n    visible: enable,\n    type: 'discrete',\n    orient,\n    position: legendPosition,\n    maxCol: Math.max(1, maxSize),\n    maxRow: Math.max(1, maxSize),\n    data: colorItems.map((d: string, index: number) => {\n      const color = colorSpecified?.[d] ?? colorScheme?.[index % colorScheme.length]\n      return {\n        label: d,\n        shape: {\n          outerBorder: border\n            ? {\n                stroke: color,\n                distance: 3,\n                lineWidth: 1,\n              }\n            : undefined,\n          fill: color,\n        },\n      }\n    }),\n\n    item: {\n      focus: true,\n      maxWidth: '30%',\n      focusIconStyle: {\n        size: labelFontSize + 2,\n        fill: labelColor || labelFontColor,\n        fontWeight: labelFontWeight,\n      },\n      shape: {\n        space: border ? 6 : 4,\n        style: {\n          symbolType: shapeType,\n          size: border ? 8 : 10,\n        },\n      },\n      label: {\n        formatMethod: (value: string) => {\n          return colorIdMap[value]?.alias ?? value\n        },\n        style: {\n          fontSize: labelFontSize,\n          fill: labelColor || labelFontColor,\n          fontWeight: labelFontWeight,\n        },\n      },\n      background: {\n        state: {\n          selectedHover: {\n            fill: labelColor || labelFontColor,\n            fillOpacity: 0.05,\n          },\n        },\n      },\n    },\n  }\n  return { ...result, legends } as Partial<PivotChartConstructorOptions>\n}\n"],"names":["pivotDiscreteLegend","spec","context","result","advancedVSeed","chartType","baseConfig","datasetReshapeInfo","colorItems","unique","d","colorIdMap","prev","cur","legend","color","colorScheme","colorMapping","colorSpecified","createSpecifiedForColorMapping","enable","position","labelFontColor","labelColor","labelFontSize","labelFontWeight","maxSize","border","shapeType","orient","legendPosition","legends","Math","index","undefined","value"],"mappings":";;AAKO,MAAMA,sBAA0C,CAACC,MAAMC;IAC5D,MAAMC,SAAS;QAAE,GAAGF,IAAI;IAAC;IACzB,MAAM,EAAEG,aAAa,EAAE,GAAGF;IAC1B,MAAM,EAAEG,SAAS,EAAE,GAAGD;IACtB,MAAME,aAAaF,cAAc,MAAM,CAACC,UAAU;IAElD,IAAI,CAACC,cAAc,CAACA,WAAW,MAAM,EACnC,OAAOH;IAGT,MAAM,EAAEI,kBAAkB,EAAE,GAAGH;IAE/B,MAAMI,aAAaC,OACjBF,mBAAmB,OAAO,CAAC,CAACG,IACnBA,EAAE,UAAU,CAAC,UAAU;IAIlC,MAAMC,aAAaJ,mBAAmB,MAAM,CAAgD,CAACK,MAAMC,MAC1F;YAAE,GAAGD,IAAI;YAAE,GAAGC,IAAI,UAAU,CAAC,UAAU;QAAC,IAC9C,CAAC;IAEJ,MAAM,EAAEC,MAAM,EAAEC,KAAK,EAAE,GAAGT;IAC1B,MAAM,EAAEU,WAAW,EAAEC,YAAY,EAAE,GAAGF;IAEtC,MAAMG,iBAAiBC,+BAA+BF,cAAcN,YAAYH;IAEhF,MAAM,EACJY,MAAM,EACNC,WAAW,QAAQ,EACnBC,cAAc,EACdC,UAAU,EACVC,gBAAgB,EAAE,EAClBC,kBAAkB,GAAG,EACrBC,UAAU,CAAC,EACXC,MAAM,EACNC,YAAY,WAAW,EACxB,GAAGd,UAAU,CAAC;IAEf,MAAMe,SAAS;QAAC;QAAU;QAAc;QAAe;QAAM;KAAK,CAAC,QAAQ,CAACR,YACxE,WACA;QAAC;QAAO;QAAW;QAAY;QAAM;KAAK,CAAC,QAAQ,CAACA,YAClD,QACA;QAAC;QAAQ;QAAW;QAAc;QAAM;KAAK,CAAC,QAAQ,CAACA,YACrD,SACA;IAER,MAAMS,iBAAiB;QAAC;QAAW;QAAc;QAAW;QAAY;QAAM;QAAM;QAAM;KAAK,CAAC,QAAQ,CAACT,YACrG,UACA;QAAC;QAAY;QAAe;QAAc;QAAe;QAAM;QAAM;QAAM;KAAK,CAAC,QAAQ,CAACA,YACxF,QACA;IAEN,MAAMU,UAAU;QACd,SAAS;QACT,SAASX;QACT,MAAM;QACNS;QACA,UAAUC;QACV,QAAQE,KAAK,GAAG,CAAC,GAAGN;QACpB,QAAQM,KAAK,GAAG,CAAC,GAAGN;QACpB,MAAMlB,WAAW,GAAG,CAAC,CAACE,GAAWuB;YAC/B,MAAMlB,QAAQG,gBAAgB,CAACR,EAAE,IAAIM,aAAa,CAACiB,QAAQjB,YAAY,MAAM,CAAC;YAC9E,OAAO;gBACL,OAAON;gBACP,OAAO;oBACL,aAAaiB,SACT;wBACE,QAAQZ;wBACR,UAAU;wBACV,WAAW;oBACb,IACAmB;oBACJ,MAAMnB;gBACR;YACF;QACF;QAEA,MAAM;YACJ,OAAO;YACP,UAAU;YACV,gBAAgB;gBACd,MAAMS,gBAAgB;gBACtB,MAAMD,cAAcD;gBACpB,YAAYG;YACd;YACA,OAAO;gBACL,OAAOE,SAAS,IAAI;gBACpB,OAAO;oBACL,YAAYC;oBACZ,MAAMD,SAAS,IAAI;gBACrB;YACF;YACA,OAAO;gBACL,cAAc,CAACQ,QACNxB,UAAU,CAACwB,MAAM,EAAE,SAASA;gBAErC,OAAO;oBACL,UAAUX;oBACV,MAAMD,cAAcD;oBACpB,YAAYG;gBACd;YACF;YACA,YAAY;gBACV,OAAO;oBACL,eAAe;wBACb,MAAMF,cAAcD;wBACpB,aAAa;oBACf;gBACF;YACF;QACF;IACF;IACA,OAAO;QAAE,GAAGnB,MAAM;QAAE4B;IAAQ;AAC9B"}