{"version":3,"file":"pipeline/spec/chart/pipes/annotation/annotationHorizontalLine.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/annotation/annotationHorizontalLine.ts"],"sourcesContent":["import type { ILineChartSpec, IMarkLineSpec } from '@visactor/vchart'\nimport { selector } from '../../../../../dataSelector'\nimport type { VChartSpecPipe } from 'src/types'\nimport { isArray, isNumber, isString } from 'remeda'\nimport { ANNOTATION_Z_INDEX } from '../../../../utils/constant'\n\nexport const annotationHorizontalLine: VChartSpecPipe = (spec, context) => {\n  const { advancedVSeed, vseed } = context\n  const { annotation, datasetReshapeInfo, config } = advancedVSeed\n  const { foldInfo, unfoldInfo } = datasetReshapeInfo[0]\n\n  if (!annotation || !annotation.annotationHorizontalLine) {\n    return spec\n  }\n  const theme = config?.[vseed.chartType as 'column']?.annotation?.annotationHorizontalLine\n  const { annotationHorizontalLine } = annotation\n  const annotationHorizontalLineList = Array.isArray(annotationHorizontalLine)\n    ? annotationHorizontalLine\n    : [annotationHorizontalLine]\n\n  const positionMap = {\n    outsideStart: 'start',\n    outsideEnd: 'end',\n    outsideMiddle: 'middle',\n    insideStart: 'insideStartTop',\n    insideMiddle: 'insideMiddleTop',\n    insideEnd: 'insideEndTop',\n  }\n\n  const markLine = annotationHorizontalLineList.flatMap((annotationHorizontalLine) => {\n    const {\n      selector: selectorPoint,\n      yValue,\n      text = '',\n      textPosition = 'insideEnd',\n      textColor = theme?.textColor ?? '#ffffff',\n      textFontSize = theme?.textFontSize ?? 12,\n      textFontWeight = theme?.textFontWeight ?? 400,\n      textAlign = 'right',\n      textBaseline = 'bottom',\n\n      lineColor = theme?.lineColor ?? '#212121',\n      lineStyle = theme?.lineStyle ?? 'dashed',\n      lineVisible = theme?.lineStyle ?? true,\n      lineWidth = theme?.lineWidth ?? 1,\n\n      textBackgroundVisible = theme?.textBackgroundVisible ?? true,\n      textBackgroundColor = theme?.textBackgroundColor ?? '#212121',\n      textBackgroundBorderColor = theme?.textBackgroundBorderColor ?? '#212121',\n      textBackgroundBorderRadius = theme?.textBackgroundBorderRadius ?? 4,\n      textBackgroundBorderWidth = theme?.textBackgroundBorderWidth ?? 1,\n      textBackgroundPadding = theme?.textBackgroundPadding ?? 2,\n    } = annotationHorizontalLine\n\n    const dataset = advancedVSeed.dataset.flat()\n\n    const generateOneMarkLine = (y: string | number) => {\n      return {\n        y,\n        autoRange: true,\n        zIndex: ANNOTATION_Z_INDEX,\n        line: {\n          style: {\n            visible: lineVisible,\n            stroke: lineColor,\n            lineWidth: lineWidth,\n            lineDash: lineStyle === 'dashed' ? [5, 2] : lineStyle === 'dotted' ? [2, 5] : [0],\n          },\n        },\n        label: {\n          confine: true,\n          text: text,\n          position: (positionMap as any)[textPosition || 'insideEnd'],\n          style: {\n            opacity: 0.95,\n            visible: true,\n            dy: 4,\n            stroke: textBackgroundColor,\n            lineWidth: 1,\n            textAlign: textAlign,\n            textBaseline: textBaseline,\n            fill: textColor,\n            fontSize: textFontSize,\n            fontWeight: textFontWeight,\n          },\n          labelBackground: {\n            visible: textBackgroundVisible,\n            padding: textBackgroundPadding,\n            style: {\n              opacity: 0.95,\n              dy: 4,\n              cornerRadius: textBackgroundBorderRadius,\n              fill: textBackgroundColor,\n              stroke: textBackgroundBorderColor,\n              lineWidth: textBackgroundBorderWidth,\n              fillOpacity: 1,\n            },\n          },\n        },\n        startSymbol: {\n          visible: theme?.startSymbolVisible ?? true,\n          symbolType: theme?.startSymbolType ?? 'triangleDown',\n          size: 5 + (lineWidth || 1),\n          style: {\n            dx: 3,\n            fill: lineColor,\n          },\n        },\n        endSymbol: {\n          visible: theme?.endSymbolVisible ?? false,\n          symbolType: theme?.endSymbolType ?? 'arrow',\n          size: 10 + (lineWidth || 1),\n          style: {\n            dx: -4,\n            fill: lineColor,\n          },\n        },\n      }\n    }\n    if ((!selectorPoint && isArray(yValue)) || isString(yValue) || isNumber(yValue)) {\n      const yValueArr = Array.isArray(yValue) ? yValue : [yValue]\n      return yValueArr.map(generateOneMarkLine)\n    }\n\n    const selectedData = selectorPoint ? dataset.filter((datum) => selector(datum, selectorPoint)) : []\n\n    return selectedData.map((datum) => {\n      if (datum[unfoldInfo.encodingY]) {\n        return generateOneMarkLine(datum[unfoldInfo.encodingY] as string)\n      }\n      if (datum[foldInfo.measureValue]) {\n        return generateOneMarkLine(datum[foldInfo.measureValue] as string)\n      }\n      return {}\n    })\n  }) as IMarkLineSpec[]\n  const specMarkLine = ((spec as ILineChartSpec).markLine as IMarkLineSpec[]) || []\n  const newMarkLine = [...specMarkLine, ...(markLine || [])]\n  return {\n    ...spec,\n    markLine: newMarkLine,\n  }\n}\n"],"names":["annotationHorizontalLine","spec","context","advancedVSeed","vseed","annotation","datasetReshapeInfo","config","foldInfo","unfoldInfo","theme","annotationHorizontalLineList","Array","positionMap","markLine","selectorPoint","yValue","text","textPosition","textColor","textFontSize","textFontWeight","textAlign","textBaseline","lineColor","lineStyle","lineVisible","lineWidth","textBackgroundVisible","textBackgroundColor","textBackgroundBorderColor","textBackgroundBorderRadius","textBackgroundBorderWidth","textBackgroundPadding","dataset","generateOneMarkLine","y","ANNOTATION_Z_INDEX","isArray","isString","isNumber","yValueArr","selectedData","datum","selector","specMarkLine","newMarkLine"],"mappings":";;;AAMO,MAAMA,oDAA2C,CAACC,MAAMC;IAC7D,MAAM,EAAEC,aAAa,EAAEC,KAAK,EAAE,GAAGF;IACjC,MAAM,EAAEG,UAAU,EAAEC,kBAAkB,EAAEC,MAAM,EAAE,GAAGJ;IACnD,MAAM,EAAEK,QAAQ,EAAEC,UAAU,EAAE,GAAGH,kBAAkB,CAAC,EAAE;IAEtD,IAAI,CAACD,cAAc,CAACA,WAAW,wBAAwB,EACrD,OAAOJ;IAET,MAAMS,QAAQH,QAAQ,CAACH,MAAM,SAAS,CAAa,EAAE,YAAY;IACjE,MAAM,EAAEJ,wBAAwB,EAAE,GAAGK;IACrC,MAAMM,+BAA+BC,MAAM,OAAO,CAACZ,4BAC/CA,2BACA;QAACA;KAAyB;IAE9B,MAAMa,cAAc;QAClB,cAAc;QACd,YAAY;QACZ,eAAe;QACf,aAAa;QACb,cAAc;QACd,WAAW;IACb;IAEA,MAAMC,WAAWH,6BAA6B,OAAO,CAAC,CAACX;QACrD,MAAM,EACJ,UAAUe,aAAa,EACvBC,MAAM,EACNC,OAAO,EAAE,EACTC,eAAe,WAAW,EAC1BC,YAAYT,OAAO,aAAa,SAAS,EACzCU,eAAeV,OAAO,gBAAgB,EAAE,EACxCW,iBAAiBX,OAAO,kBAAkB,GAAG,EAC7CY,YAAY,OAAO,EACnBC,eAAe,QAAQ,EAEvBC,YAAYd,OAAO,aAAa,SAAS,EACzCe,YAAYf,OAAO,aAAa,QAAQ,EACxCgB,cAAchB,OAAO,aAAa,IAAI,EACtCiB,YAAYjB,OAAO,aAAa,CAAC,EAEjCkB,wBAAwBlB,OAAO,yBAAyB,IAAI,EAC5DmB,sBAAsBnB,OAAO,uBAAuB,SAAS,EAC7DoB,4BAA4BpB,OAAO,6BAA6B,SAAS,EACzEqB,6BAA6BrB,OAAO,8BAA8B,CAAC,EACnEsB,4BAA4BtB,OAAO,6BAA6B,CAAC,EACjEuB,wBAAwBvB,OAAO,yBAAyB,CAAC,EAC1D,GAAGV;QAEJ,MAAMkC,UAAU/B,cAAc,OAAO,CAAC,IAAI;QAE1C,MAAMgC,sBAAsB,CAACC,IACpB;gBACLA;gBACA,WAAW;gBACX,QAAQC;gBACR,MAAM;oBACJ,OAAO;wBACL,SAASX;wBACT,QAAQF;wBACR,WAAWG;wBACX,UAAUF,AAAc,aAAdA,YAAyB;4BAAC;4BAAG;yBAAE,GAAGA,AAAc,aAAdA,YAAyB;4BAAC;4BAAG;yBAAE,GAAG;4BAAC;yBAAE;oBACnF;gBACF;gBACA,OAAO;oBACL,SAAS;oBACT,MAAMR;oBACN,UAAWJ,WAAmB,CAACK,gBAAgB,YAAY;oBAC3D,OAAO;wBACL,SAAS;wBACT,SAAS;wBACT,IAAI;wBACJ,QAAQW;wBACR,WAAW;wBACX,WAAWP;wBACX,cAAcC;wBACd,MAAMJ;wBACN,UAAUC;wBACV,YAAYC;oBACd;oBACA,iBAAiB;wBACf,SAASO;wBACT,SAASK;wBACT,OAAO;4BACL,SAAS;4BACT,IAAI;4BACJ,cAAcF;4BACd,MAAMF;4BACN,QAAQC;4BACR,WAAWE;4BACX,aAAa;wBACf;oBACF;gBACF;gBACA,aAAa;oBACX,SAAStB,OAAO,sBAAsB;oBACtC,YAAYA,OAAO,mBAAmB;oBACtC,MAAM,IAAKiB,CAAAA,aAAa;oBACxB,OAAO;wBACL,IAAI;wBACJ,MAAMH;oBACR;gBACF;gBACA,WAAW;oBACT,SAASd,OAAO,oBAAoB;oBACpC,YAAYA,OAAO,iBAAiB;oBACpC,MAAM,KAAMiB,CAAAA,aAAa;oBACzB,OAAO;wBACL,IAAI;wBACJ,MAAMH;oBACR;gBACF;YACF;QAEF,IAAK,CAACT,iBAAiBuB,QAAQtB,WAAYuB,SAASvB,WAAWwB,SAASxB,SAAS;YAC/E,MAAMyB,YAAY7B,MAAM,OAAO,CAACI,UAAUA,SAAS;gBAACA;aAAO;YAC3D,OAAOyB,UAAU,GAAG,CAACN;QACvB;QAEA,MAAMO,eAAe3B,gBAAgBmB,QAAQ,MAAM,CAAC,CAACS,QAAUC,SAASD,OAAO5B,kBAAkB,EAAE;QAEnG,OAAO2B,aAAa,GAAG,CAAC,CAACC;YACvB,IAAIA,KAAK,CAAClC,WAAW,SAAS,CAAC,EAC7B,OAAO0B,oBAAoBQ,KAAK,CAAClC,WAAW,SAAS,CAAC;YAExD,IAAIkC,KAAK,CAACnC,SAAS,YAAY,CAAC,EAC9B,OAAO2B,oBAAoBQ,KAAK,CAACnC,SAAS,YAAY,CAAC;YAEzD,OAAO,CAAC;QACV;IACF;IACA,MAAMqC,eAAiB5C,KAAwB,QAAQ,IAAwB,EAAE;IACjF,MAAM6C,cAAc;WAAID;WAAkB/B,YAAY,EAAE;KAAE;IAC1D,OAAO;QACL,GAAGb,IAAI;QACP,UAAU6C;IACZ;AACF"}