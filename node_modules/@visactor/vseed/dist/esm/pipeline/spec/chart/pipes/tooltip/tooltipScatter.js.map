{"version":3,"file":"pipeline/spec/chart/pipes/tooltip/tooltipScatter.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/tooltip/tooltipScatter.ts"],"sourcesContent":["import { uniqueBy } from 'remeda'\nimport { createFormatterByMeasure, findAllMeasures, findMeasureById } from '../../../../utils'\nimport type { Datum, Dimensions, FoldInfo, Locale, Measures, VChartSpecPipe, Tooltip, UnfoldInfo } from 'src/types'\nimport { ORIGINAL_DATA } from 'src/dataReshape'\nimport { getTooltipStyle } from './tooltipStyle'\n\nexport const tooltipScatter: VChartSpecPipe = (spec, context) => {\n  const result = { ...spec }\n  const { advancedVSeed, vseed } = context\n  const { datasetReshapeInfo, chartType, locale, dimensions, encoding } = advancedVSeed\n  const baseConfig = advancedVSeed.config[chartType] as { tooltip: Tooltip }\n  const { tooltip = { enable: true } } = baseConfig\n  const { enable } = tooltip\n  const { foldInfoList } = datasetReshapeInfo[0] as unknown as {\n    foldInfoList: FoldInfo[]\n    unfoldInfo: UnfoldInfo\n  }\n\n  result.tooltip = {\n    style: getTooltipStyle(tooltip),\n    visible: enable,\n\n    mark: {\n      title: {\n        visible: false,\n      },\n      content: createMarkContent(\n        encoding.tooltip || [],\n        dimensions,\n        findAllMeasures(vseed.measures),\n        locale,\n        foldInfoList,\n      ),\n    },\n    dimension: {\n      visible: false,\n    },\n  }\n  return result\n}\n\nexport const createMarkContent = (\n  tooltip: string[],\n  dimensions: Dimensions,\n  measures: Measures,\n  locale: Locale,\n  foldInfoList: FoldInfo[],\n) => {\n  const dims = uniqueBy(\n    dimensions.filter((item) => tooltip.includes(item.id)),\n    (item) => item.id,\n  )\n  const meas = uniqueBy(\n    measures.filter((item) => tooltip.includes(item.id)),\n    (item) => item.id,\n  )\n\n  const dimContent = dims.map((item) => ({\n    visible: true,\n    hasShape: true,\n    shapeType: 'rectRound',\n    key: (v: unknown) => {\n      const datum = v as Datum\n      if (item.alias || item.id) {\n        return item.alias || item.id\n      }\n      return datum && (datum[item.id] as string)\n    },\n    value: (v: unknown) => {\n      const datum = v as Datum\n      return datum && (datum[item.id] as string)\n    },\n  }))\n\n  const meaContent = meas.map((item) => ({\n    visible: true,\n    hasShape: true,\n    shapeType: 'rectRound',\n    key: item.alias || item.id,\n    value: (v: unknown) => {\n      const datum = v as Datum\n      if (!datum) {\n        return ''\n      }\n      const id = item.id\n      if (!datum || !datum[ORIGINAL_DATA] || !datum[ORIGINAL_DATA]) {\n        return ''\n      }\n      const originalData = datum[ORIGINAL_DATA] as Datum\n      const value = originalData[id] as string | number\n      const measure = findMeasureById(measures, id)\n      const formatter = createFormatterByMeasure(measure)\n      return formatter(value)\n    },\n  }))\n\n  const foldMeaContent = foldInfoList.map((foldInfo) => {\n    return {\n      visible: true,\n      hasShape: true,\n      shapeType: 'rectRound',\n      key: Object.values(foldInfo.foldMap)[0],\n      value: (v: unknown) => {\n        const { measureId, measureValue } = foldInfo\n\n        const datum = v as Datum\n        if (!datum) {\n          return ''\n        }\n        const value = datum[measureValue] as string | number\n        const id = datum[measureId] as string\n        const measure = findMeasureById(measures, id)\n        const formatter = createFormatterByMeasure(measure)\n        return formatter(value)\n      },\n    }\n  })\n  return [...dimContent, ...foldMeaContent, ...meaContent]\n}\n"],"names":["tooltipScatter","spec","context","result","advancedVSeed","vseed","datasetReshapeInfo","chartType","locale","dimensions","encoding","baseConfig","tooltip","enable","foldInfoList","getTooltipStyle","createMarkContent","findAllMeasures","measures","dims","uniqueBy","item","meas","dimContent","v","datum","meaContent","id","ORIGINAL_DATA","originalData","value","measure","findMeasureById","formatter","createFormatterByMeasure","foldMeaContent","foldInfo","Object","measureId","measureValue"],"mappings":"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"}