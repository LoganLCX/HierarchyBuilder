{"version":3,"file":"pipeline/spec/chart/pipes/pivotChart/pivotIndicators.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/pivotChart/pivotIndicators.ts"],"sourcesContent":["import type { PivotChartConstructorOptions } from '@visactor/vtable'\nimport { execPipeline } from '../../../../utils'\nimport type {\n  Dataset,\n  Encoding,\n  MeasureGroup,\n  PivotChartSpecPipe,\n  SpecPipelineContext,\n  VChartSpecPipe,\n} from 'src/types'\nimport { unique } from 'remeda'\n\nexport const pivotIndicators =\n  (chartPipeline: VChartSpecPipe[]): PivotChartSpecPipe =>\n  (spec, context): Partial<PivotChartConstructorOptions> => {\n    const result = { ...spec } as PivotChartConstructorOptions\n    const { advancedVSeed } = context\n    const { measures, datasetReshapeInfo, dataset, encoding } = advancedVSeed\n\n    const colorItems = unique(datasetReshapeInfo.flatMap((d) => d.unfoldInfo.colorItems))\n    const allMeasureIds = unique(datasetReshapeInfo.flatMap((d) => Object.keys(d.foldInfo.foldMap || {})))\n\n    const indicators = datasetReshapeInfo.map((reshapeInfo, index) => {\n      const measureGroup = measures?.find((d) => `${d.id}` === reshapeInfo.id) as MeasureGroup\n      const subMeasuresId = (measureGroup?.children || []).map((d) => d.id)\n      const invalideMeasuresIds = allMeasureIds.filter((id) => !subMeasuresId.includes(id))\n\n      const newDataset = dataset[index] as Dataset\n      const newDatasetReshapeInfo = [\n        {\n          ...reshapeInfo,\n          unfoldInfo: { ...reshapeInfo.unfoldInfo, colorItems },\n        },\n      ]\n      const newContext: SpecPipelineContext = {\n        ...context,\n        advancedVSeed: {\n          ...advancedVSeed,\n          pivotAllDatasetReshapeInfo: datasetReshapeInfo,\n          datasetReshapeInfo: newDatasetReshapeInfo,\n          encoding: Object.keys(encoding).reduce((res, key) => {\n            res[key as keyof Encoding] = encoding[key as keyof Encoding]?.filter((e) => {\n              return !invalideMeasuresIds.includes(e)\n            }) as string[]\n\n            return res\n          }, {} as Encoding),\n          dataset: newDataset,\n        },\n      }\n\n      const chartSpec = execPipeline(chartPipeline, newContext, {})\n      return {\n        indicatorKey: `${reshapeInfo.id}`,\n        title: measureGroup?.alias,\n        cellType: 'chart',\n        chartModule: 'vchart',\n        chartSpec: chartSpec,\n        style: {\n          padding: [1, 1, 0, 1],\n        },\n      }\n    })\n\n    return {\n      ...result,\n      indicators: indicators,\n    } as Partial<PivotChartConstructorOptions>\n  }\n\nexport const pivotIndicatorsAsRow: PivotChartSpecPipe = (spec) => {\n  const result = { ...spec } as PivotChartConstructorOptions\n\n  return {\n    ...result,\n    indicatorsAsCol: false,\n  }\n}\n\nexport const pivotIndicatorsAsCol: PivotChartSpecPipe = (spec) => {\n  const result = { ...spec } as PivotChartConstructorOptions\n\n  return {\n    ...result,\n    indicatorsAsCol: true,\n  }\n}\n"],"names":["pivotIndicators","chartPipeline","spec","context","result","advancedVSeed","measures","datasetReshapeInfo","dataset","encoding","colorItems","unique","d","allMeasureIds","Object","indicators","reshapeInfo","index","measureGroup","subMeasuresId","invalideMeasuresIds","id","newDataset","newDatasetReshapeInfo","newContext","res","key","e","chartSpec","execPipeline","pivotIndicatorsAsRow","pivotIndicatorsAsCol"],"mappings":";;AAYO,MAAMA,kBACX,CAACC,gBACD,CAACC,MAAMC;QACL,MAAMC,SAAS;YAAE,GAAGF,IAAI;QAAC;QACzB,MAAM,EAAEG,aAAa,EAAE,GAAGF;QAC1B,MAAM,EAAEG,QAAQ,EAAEC,kBAAkB,EAAEC,OAAO,EAAEC,QAAQ,EAAE,GAAGJ;QAE5D,MAAMK,aAAaC,OAAOJ,mBAAmB,OAAO,CAAC,CAACK,IAAMA,EAAE,UAAU,CAAC,UAAU;QACnF,MAAMC,gBAAgBF,OAAOJ,mBAAmB,OAAO,CAAC,CAACK,IAAME,OAAO,IAAI,CAACF,EAAE,QAAQ,CAAC,OAAO,IAAI,CAAC;QAElG,MAAMG,aAAaR,mBAAmB,GAAG,CAAC,CAACS,aAAaC;YACtD,MAAMC,eAAeZ,UAAU,KAAK,CAACM,IAAM,GAAGA,EAAE,EAAE,EAAE,KAAKI,YAAY,EAAE;YACvE,MAAMG,gBAAiBD,AAAAA,CAAAA,cAAc,YAAY,EAAC,EAAG,GAAG,CAAC,CAACN,IAAMA,EAAE,EAAE;YACpE,MAAMQ,sBAAsBP,cAAc,MAAM,CAAC,CAACQ,KAAO,CAACF,cAAc,QAAQ,CAACE;YAEjF,MAAMC,aAAad,OAAO,CAACS,MAAM;YACjC,MAAMM,wBAAwB;gBAC5B;oBACE,GAAGP,WAAW;oBACd,YAAY;wBAAE,GAAGA,YAAY,UAAU;wBAAEN;oBAAW;gBACtD;aACD;YACD,MAAMc,aAAkC;gBACtC,GAAGrB,OAAO;gBACV,eAAe;oBACb,GAAGE,aAAa;oBAChB,4BAA4BE;oBAC5B,oBAAoBgB;oBACpB,UAAUT,OAAO,IAAI,CAACL,UAAU,MAAM,CAAC,CAACgB,KAAKC;wBAC3CD,GAAG,CAACC,IAAsB,GAAGjB,QAAQ,CAACiB,IAAsB,EAAE,OAAO,CAACC,IAC7D,CAACP,oBAAoB,QAAQ,CAACO;wBAGvC,OAAOF;oBACT,GAAG,CAAC;oBACJ,SAASH;gBACX;YACF;YAEA,MAAMM,YAAYC,aAAa5B,eAAeuB,YAAY,CAAC;YAC3D,OAAO;gBACL,cAAc,GAAGR,YAAY,EAAE,EAAE;gBACjC,OAAOE,cAAc;gBACrB,UAAU;gBACV,aAAa;gBACb,WAAWU;gBACX,OAAO;oBACL,SAAS;wBAAC;wBAAG;wBAAG;wBAAG;qBAAE;gBACvB;YACF;QACF;QAEA,OAAO;YACL,GAAGxB,MAAM;YACT,YAAYW;QACd;IACF;AAEK,MAAMe,uBAA2C,CAAC5B;IACvD,MAAME,SAAS;QAAE,GAAGF,IAAI;IAAC;IAEzB,OAAO;QACL,GAAGE,MAAM;QACT,iBAAiB;IACnB;AACF;AAEO,MAAM2B,uBAA2C,CAAC7B;IACvD,MAAME,SAAS;QAAE,GAAGF,IAAI;IAAC;IAEzB,OAAO;QACL,GAAGE,MAAM;QACT,iBAAiB;IACnB;AACF"}