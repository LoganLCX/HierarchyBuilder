{"version":3,"file":"pipeline/spec/chart/pipes/color/color.js","sources":["../../../../../../../src/pipeline/spec/chart/pipes/color/color.ts"],"sourcesContent":["import type { ILineChartSpec } from '@visactor/vchart'\nimport type { Color, VChartSpecPipe } from 'src/types'\n\nexport const color: VChartSpecPipe = (spec, context) => {\n  const result = { ...spec } as ILineChartSpec\n  const { advancedVSeed } = context\n  const { datasetReshapeInfo, chartType } = advancedVSeed\n  const { unfoldInfo } = datasetReshapeInfo[0]\n  const baseConfig = advancedVSeed.config[chartType] as { color: Color }\n\n  if (!baseConfig || !baseConfig.color) {\n    return result\n  }\n\n  const colorItems = unfoldInfo.colorItems\n  const colorIdMap = unfoldInfo.colorIdMap\n\n  const { color } = baseConfig\n  const { colorScheme, colorMapping } = color\n\n  result.color = {\n    type: 'ordinal',\n    domain: colorItems,\n    range: colorScheme,\n    specified: createSpecifiedForColorMapping(colorMapping, colorIdMap, colorItems),\n  } as ILineChartSpec['color']\n  return result\n}\n\nexport const createSpecifiedForColorMapping = (\n  colorMapping?: Record<string, string>,\n  colorIdMap?: Record<string, { id: string; alias: string }>,\n  colorItems?: string[],\n) => {\n  if (!colorMapping || !colorIdMap || !colorItems) {\n    return undefined\n  }\n\n  const matchedList: string[] = []\n\n  // 名称越长优先级越高: 按名称长度降, 优先匹配名称长的, 避免一个短的名称匹配到了超多个长的\n  const colors = Object.entries(colorMapping).sort((a, b) => b[0].length - a[0].length)\n  // 准确匹配\n  const accurateMap = colors.reduce(\n    (prev, cur) => {\n      const name = cur[0]\n      const colorValue = cur[1]\n\n      const accurateMatchedList = Object.entries(colorIdMap).filter(([colorKey, colorObj]) => {\n        return colorKey === name || colorObj.alias === name || colorObj.id === name\n      })\n      accurateMatchedList.forEach((item) => {\n        prev[item[0]] = colorValue\n        matchedList.push(name)\n      })\n\n      return prev\n    },\n    {} as Record<string, string>,\n  )\n\n  // 模糊匹配\n  const fuzzyMap = colors.reduce(\n    (prev, cur) => {\n      const name = cur[0]\n      const colorValue = cur[1]\n      if (matchedList.includes(name)) {\n        return prev\n      }\n\n      const fuzzyMatchedList = Object.entries(colorIdMap).filter(([colorKey, colorObj]) => {\n        return colorKey.includes(name) || colorObj.alias.includes(name) || colorObj.id.includes(name)\n      })\n      fuzzyMatchedList.forEach((item) => {\n        // 已经匹配有值, 则不重复匹配\n        if (prev[item[0]]) {\n          return\n        }\n        prev[item[0]] = colorValue\n      })\n\n      return prev\n    },\n    {} as Record<string, string>,\n  )\n\n  // 合并, 准确匹配的优先级高\n  return {\n    ...fuzzyMap,\n    ...accurateMap,\n  }\n}\n"],"names":["color","spec","context","result","advancedVSeed","datasetReshapeInfo","chartType","unfoldInfo","baseConfig","colorItems","colorIdMap","colorScheme","colorMapping","createSpecifiedForColorMapping","matchedList","colors","Object","a","b","accurateMap","prev","cur","name","colorValue","accurateMatchedList","colorKey","colorObj","item","fuzzyMap","fuzzyMatchedList"],"mappings":"AAGO,MAAMA,cAAwB,CAACC,MAAMC;IAC1C,MAAMC,SAAS;QAAE,GAAGF,IAAI;IAAC;IACzB,MAAM,EAAEG,aAAa,EAAE,GAAGF;IAC1B,MAAM,EAAEG,kBAAkB,EAAEC,SAAS,EAAE,GAAGF;IAC1C,MAAM,EAAEG,UAAU,EAAE,GAAGF,kBAAkB,CAAC,EAAE;IAC5C,MAAMG,aAAaJ,cAAc,MAAM,CAACE,UAAU;IAElD,IAAI,CAACE,cAAc,CAACA,WAAW,KAAK,EAClC,OAAOL;IAGT,MAAMM,aAAaF,WAAW,UAAU;IACxC,MAAMG,aAAaH,WAAW,UAAU;IAExC,MAAM,EAAEP,KAAK,EAAE,GAAGQ;IAClB,MAAM,EAAEG,WAAW,EAAEC,YAAY,EAAE,GAAGZ;IAEtCG,OAAO,KAAK,GAAG;QACb,MAAM;QACN,QAAQM;QACR,OAAOE;QACP,WAAWE,+BAA+BD,cAAcF,YAAYD;IACtE;IACA,OAAON;AACT;AAEO,MAAMU,iCAAiC,CAC5CD,cACAF,YACAD;IAEA,IAAI,CAACG,gBAAgB,CAACF,cAAc,CAACD,YACnC;IAGF,MAAMK,cAAwB,EAAE;IAGhC,MAAMC,SAASC,OAAO,OAAO,CAACJ,cAAc,IAAI,CAAC,CAACK,GAAGC,IAAMA,CAAC,CAAC,EAAE,CAAC,MAAM,GAAGD,CAAC,CAAC,EAAE,CAAC,MAAM;IAEpF,MAAME,cAAcJ,OAAO,MAAM,CAC/B,CAACK,MAAMC;QACL,MAAMC,OAAOD,GAAG,CAAC,EAAE;QACnB,MAAME,aAAaF,GAAG,CAAC,EAAE;QAEzB,MAAMG,sBAAsBR,OAAO,OAAO,CAACN,YAAY,MAAM,CAAC,CAAC,CAACe,UAAUC,SAAS,GAC1ED,aAAaH,QAAQI,SAAS,KAAK,KAAKJ,QAAQI,SAAS,EAAE,KAAKJ;QAEzEE,oBAAoB,OAAO,CAAC,CAACG;YAC3BP,IAAI,CAACO,IAAI,CAAC,EAAE,CAAC,GAAGJ;YAChBT,YAAY,IAAI,CAACQ;QACnB;QAEA,OAAOF;IACT,GACA,CAAC;IAIH,MAAMQ,WAAWb,OAAO,MAAM,CAC5B,CAACK,MAAMC;QACL,MAAMC,OAAOD,GAAG,CAAC,EAAE;QACnB,MAAME,aAAaF,GAAG,CAAC,EAAE;QACzB,IAAIP,YAAY,QAAQ,CAACQ,OACvB,OAAOF;QAGT,MAAMS,mBAAmBb,OAAO,OAAO,CAACN,YAAY,MAAM,CAAC,CAAC,CAACe,UAAUC,SAAS,GACvED,SAAS,QAAQ,CAACH,SAASI,SAAS,KAAK,CAAC,QAAQ,CAACJ,SAASI,SAAS,EAAE,CAAC,QAAQ,CAACJ;QAE1FO,iBAAiB,OAAO,CAAC,CAACF;YAExB,IAAIP,IAAI,CAACO,IAAI,CAAC,EAAE,CAAC,EACf;YAEFP,IAAI,CAACO,IAAI,CAAC,EAAE,CAAC,GAAGJ;QAClB;QAEA,OAAOH;IACT,GACA,CAAC;IAIH,OAAO;QACL,GAAGQ,QAAQ;QACX,GAAGT,WAAW;IAChB;AACF"}