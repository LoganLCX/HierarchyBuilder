{"version":3,"file":"pipeline/spec/table/pipes/columns/measuresToColumns.js","sources":["../../../../../../../src/pipeline/spec/table/pipes/columns/measuresToColumns.ts"],"sourcesContent":["import type { ColumnsDefine, ListTableConstructorOptions } from '@visactor/vtable'\nimport { createFormatterByMeasure, isMeasure } from 'src/pipeline/utils'\nimport type { MeasureGroup, Measure, MeasureTree, ListTableSpecPipe, Datum } from 'src/types'\n\nexport const measureTreeToColumns: ListTableSpecPipe = (spec, context) => {\n  const { advancedVSeed } = context\n  const measures = (advancedVSeed as unknown as { measures: MeasureTree }).measures\n  const result = { ...spec } as ListTableConstructorOptions\n\n  const eachNode = (node: Measure | MeasureGroup) => {\n    if (isMeasure(node)) {\n      return {\n        width: 'auto',\n        fieldFormat: fieldFormat(node),\n      }\n    }\n\n    return {}\n  }\n  const columns = treeTreeToColumns<Measure, MeasureGroup>(measures, eachNode)\n  return {\n    ...result,\n    columns: [...(result.columns || []), ...columns] as ListTableConstructorOptions['columns'],\n  }\n}\n\nconst fieldFormat = (node: Measure) => {\n  const formatter = createFormatterByMeasure(node)\n\n  return (datum: Datum) => {\n    const { id } = node\n    const value = datum[id] as number | string | undefined\n    return formatter(value)\n  }\n}\nconst treeTreeToColumns = <\n  T extends { id: string; alias?: string },\n  U extends { id: string; alias?: string; children?: (T | U)[] },\n>(\n  tree: (T | U)[],\n  callback?: (node: T | U) => object,\n): ColumnsDefine[] => {\n  const result = tree.map((item) => {\n    if ('children' in item && Array.isArray(item.children)) {\n      const groupNode = item as unknown as U\n      const field = groupNode.id\n      const title = groupNode.alias ?? groupNode.id\n      const props = callback?.(groupNode) || {}\n      // group\n      return {\n        field,\n        title,\n        columns: treeTreeToColumns(item.children, callback),\n        ...props,\n      }\n    } else {\n      const field = item.id\n      const title = item.alias ?? item.id\n      const props = callback?.(item) || {}\n      // leaf\n      return {\n        field,\n        title,\n        ...props,\n      }\n    }\n  }) as unknown as ColumnsDefine[]\n\n  return result || []\n}\n"],"names":["measureTreeToColumns","spec","context","advancedVSeed","measures","result","eachNode","node","isMeasure","fieldFormat","columns","treeTreeToColumns","formatter","createFormatterByMeasure","datum","id","value","tree","callback","item","Array","groupNode","field","title","props"],"mappings":";AAIO,MAAMA,uBAA0C,CAACC,MAAMC;IAC5D,MAAM,EAAEC,aAAa,EAAE,GAAGD;IAC1B,MAAME,WAAYD,cAAuD,QAAQ;IACjF,MAAME,SAAS;QAAE,GAAGJ,IAAI;IAAC;IAEzB,MAAMK,WAAW,CAACC;QAChB,IAAIC,UAAUD,OACZ,OAAO;YACL,OAAO;YACP,aAAaE,YAAYF;QAC3B;QAGF,OAAO,CAAC;IACV;IACA,MAAMG,UAAUC,kBAAyCP,UAAUE;IACnE,OAAO;QACL,GAAGD,MAAM;QACT,SAAS;eAAKA,OAAO,OAAO,IAAI,EAAE;eAAMK;SAAQ;IAClD;AACF;AAEA,MAAMD,cAAc,CAACF;IACnB,MAAMK,YAAYC,yBAAyBN;IAE3C,OAAO,CAACO;QACN,MAAM,EAAEC,EAAE,EAAE,GAAGR;QACf,MAAMS,QAAQF,KAAK,CAACC,GAAG;QACvB,OAAOH,UAAUI;IACnB;AACF;AACA,MAAML,oBAAoB,CAIxBM,MACAC;IAEA,MAAMb,SAASY,KAAK,GAAG,CAAC,CAACE;QACvB,IAAI,cAAcA,QAAQC,MAAM,OAAO,CAACD,KAAK,QAAQ,GAAG;YACtD,MAAME,YAAYF;YAClB,MAAMG,QAAQD,UAAU,EAAE;YAC1B,MAAME,QAAQF,UAAU,KAAK,IAAIA,UAAU,EAAE;YAC7C,MAAMG,QAAQN,WAAWG,cAAc,CAAC;YAExC,OAAO;gBACLC;gBACAC;gBACA,SAASZ,kBAAkBQ,KAAK,QAAQ,EAAED;gBAC1C,GAAGM,KAAK;YACV;QACF;QAAO;YACL,MAAMF,QAAQH,KAAK,EAAE;YACrB,MAAMI,QAAQJ,KAAK,KAAK,IAAIA,KAAK,EAAE;YACnC,MAAMK,QAAQN,WAAWC,SAAS,CAAC;YAEnC,OAAO;gBACLG;gBACAC;gBACA,GAAGC,KAAK;YACV;QACF;IACF;IAEA,OAAOnB,UAAU,EAAE;AACrB"}