{"version":3,"file":"pipeline/spec/table/pipes/indicators/pivotIndicators.js","sources":["../../../../../../../src/pipeline/spec/table/pipes/indicators/pivotIndicators.ts"],"sourcesContent":["import type { PivotChartConstructorOptions, BaseTableAPI } from '@visactor/vtable'\nimport { isNumber } from 'remeda'\nimport { intl } from 'src/i18n'\nimport { createFormatterByMeasure, findMeasureById } from 'src/pipeline/utils'\nimport type { Datum, FoldInfo, MeasureTree, PivotTableSpecPipe } from 'src/types'\n\nexport const pivotIndicators: PivotTableSpecPipe = (spec, context) => {\n  const { advancedVSeed } = context\n  const { measures, datasetReshapeInfo } = advancedVSeed\n  const { foldInfo } = datasetReshapeInfo[0]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unsafe-member-access\n  const hasRow = ((spec as any)?.rows as any[])?.length > 0\n  const foldMapValues = Object.values(foldInfo.foldMap)\n\n  return {\n    ...spec,\n    indicatorTitle: intl.i18n`指标名称`,\n    indicatorsAsCol: hasRow,\n    hideIndicatorName: hasRow,\n    indicators: [\n      {\n        cellType: 'text',\n        indicatorKey: foldInfo.measureValue,\n        title: foldMapValues.length > 1 ? '' : foldMapValues[0],\n        width: 'auto',\n        format: fieldFormat(measures, foldInfo as FoldInfo),\n      },\n    ] as unknown as PivotChartConstructorOptions['indicators'],\n  }\n}\n\nconst fieldFormat = (measures: MeasureTree, foldInfo: FoldInfo) => {\n  return (value: number | string, col?: number, row?: number, table?: BaseTableAPI) => {\n    if (!isNumber(col) || !isNumber(row) || !table) {\n      return value\n    }\n\n    const datum = table.getCellOriginRecord(col, row) as Datum[]\n    if (!datum[0]) {\n      return value\n    }\n    const { measureId: foldMeasureId } = foldInfo\n    const measureId = datum[0][foldMeasureId] as string\n    const measure = findMeasureById(measures, measureId)\n    const formatter = createFormatterByMeasure(measure)\n    return formatter(value)\n  }\n}\n"],"names":["pivotIndicators","spec","context","advancedVSeed","measures","datasetReshapeInfo","foldInfo","hasRow","foldMapValues","Object","intl","fieldFormat","value","col","row","table","isNumber","datum","foldMeasureId","measureId","measure","findMeasureById","formatter","createFormatterByMeasure"],"mappings":";;;AAMO,MAAMA,kBAAsC,CAACC,MAAMC;IACxD,MAAM,EAAEC,aAAa,EAAE,GAAGD;IAC1B,MAAM,EAAEE,QAAQ,EAAEC,kBAAkB,EAAE,GAAGF;IACzC,MAAM,EAAEG,QAAQ,EAAE,GAAGD,kBAAkB,CAAC,EAAE;IAE1C,MAAME,SAAWN,MAAc,MAAgB,SAAS;IACxD,MAAMO,gBAAgBC,OAAO,MAAM,CAACH,SAAS,OAAO;IAEpD,OAAO;QACL,GAAGL,IAAI;QACP,gBAAgBS,KAAK,IAAI,CAAC,IAAI,CAAC;QAC/B,iBAAiBH;QACjB,mBAAmBA;QACnB,YAAY;YACV;gBACE,UAAU;gBACV,cAAcD,SAAS,YAAY;gBACnC,OAAOE,cAAc,MAAM,GAAG,IAAI,KAAKA,aAAa,CAAC,EAAE;gBACvD,OAAO;gBACP,QAAQG,YAAYP,UAAUE;YAChC;SACD;IACH;AACF;AAEA,MAAMK,cAAc,CAACP,UAAuBE,WACnC,CAACM,OAAwBC,KAAcC,KAAcC;QAC1D,IAAI,CAACC,SAASH,QAAQ,CAACG,SAASF,QAAQ,CAACC,OACvC,OAAOH;QAGT,MAAMK,QAAQF,MAAM,mBAAmB,CAACF,KAAKC;QAC7C,IAAI,CAACG,KAAK,CAAC,EAAE,EACX,OAAOL;QAET,MAAM,EAAE,WAAWM,aAAa,EAAE,GAAGZ;QACrC,MAAMa,YAAYF,KAAK,CAAC,EAAE,CAACC,cAAc;QACzC,MAAME,UAAUC,gBAAgBjB,UAAUe;QAC1C,MAAMG,YAAYC,yBAAyBH;QAC3C,OAAOE,UAAUV;IACnB"}