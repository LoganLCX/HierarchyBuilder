{"version":3,"file":"pipeline/spec/table/pipes/cellStyle/pivot.js","sources":["../../../../../../../src/pipeline/spec/table/pipes/cellStyle/pivot.ts"],"sourcesContent":["import type { IIndicator, PivotTableConstructorOptions } from '@visactor/vtable'\nimport { array } from '@visactor/vutils'\nimport { isNullish, isString } from 'remeda'\nimport { selector } from 'src/dataSelector/selector'\nimport type { BodyCellStyle, Datum, PivotTableSpecPipe } from 'src/types'\nimport { pickBodyCellStyle } from './common'\nimport { FoldMeasureValue, MeasureId } from 'src/dataReshape'\n\nexport const pivotTableBodyCell: PivotTableSpecPipe = (spec, context) => {\n  const { advancedVSeed } = context\n  const { cellStyle } = advancedVSeed\n  const bodyCellStyle = cellStyle?.bodyCellStyle\n\n  if (!bodyCellStyle) {\n    return spec as PivotTableConstructorOptions\n  }\n  const bodyCellStyleList = array(bodyCellStyle) as BodyCellStyle[]\n  const indicators = (spec as PivotTableConstructorOptions).indicators || []\n\n  const newIndicators = indicators.map((ind) => {\n    const newInd = isString(ind)\n      ? ({\n          indicatorKey: ind,\n        } as IIndicator)\n      : ind\n\n    const { indicatorKey } = newInd\n\n    newInd.style = (datum: any) => {\n      const { dataValue, cellHeaderPaths } = datum\n      const headerPaths = [...cellHeaderPaths.colHeaderPaths, ...cellHeaderPaths.rowHeaderPaths]\n\n      const originalDatum: Datum = {\n        [indicatorKey]: dataValue,\n      }\n\n      headerPaths.forEach((path: any) => {\n        if (path.dimensionKey) {\n          originalDatum[path.dimensionKey] = path.value\n        }\n      })\n\n      if (!isNullish(originalDatum[MeasureId]) && !isNullish(originalDatum[FoldMeasureValue])) {\n        originalDatum[originalDatum[MeasureId]] = originalDatum[FoldMeasureValue]\n      }\n\n      const mergedStyle = bodyCellStyleList.reduce<Record<string, any>>((result, style) => {\n        if (selector(originalDatum, style.selector)) {\n          return {\n            ...result,\n            ...pickBodyCellStyle(style),\n          }\n        }\n\n        return result\n      }, {})\n\n      return mergedStyle\n    }\n    return newInd\n  })\n  return {\n    ...spec,\n    indicators: newIndicators,\n  } as PivotTableConstructorOptions\n}\n"],"names":["pivotTableBodyCell","spec","context","advancedVSeed","cellStyle","bodyCellStyle","bodyCellStyleList","array","indicators","newIndicators","ind","newInd","isString","indicatorKey","datum","dataValue","cellHeaderPaths","headerPaths","originalDatum","path","isNullish","MeasureId","FoldMeasureValue","mergedStyle","result","style","selector","pickBodyCellStyle"],"mappings":";;;;;AAQO,MAAMA,qBAAyC,CAACC,MAAMC;IAC3D,MAAM,EAAEC,aAAa,EAAE,GAAGD;IAC1B,MAAM,EAAEE,SAAS,EAAE,GAAGD;IACtB,MAAME,gBAAgBD,WAAW;IAEjC,IAAI,CAACC,eACH,OAAOJ;IAET,MAAMK,oBAAoBC,MAAMF;IAChC,MAAMG,aAAcP,KAAsC,UAAU,IAAI,EAAE;IAE1E,MAAMQ,gBAAgBD,WAAW,GAAG,CAAC,CAACE;QACpC,MAAMC,SAASC,SAASF,OACnB;YACC,cAAcA;QAChB,IACAA;QAEJ,MAAM,EAAEG,YAAY,EAAE,GAAGF;QAEzBA,OAAO,KAAK,GAAG,CAACG;YACd,MAAM,EAAEC,SAAS,EAAEC,eAAe,EAAE,GAAGF;YACvC,MAAMG,cAAc;mBAAID,gBAAgB,cAAc;mBAAKA,gBAAgB,cAAc;aAAC;YAE1F,MAAME,gBAAuB;gBAC3B,CAACL,aAAa,EAAEE;YAClB;YAEAE,YAAY,OAAO,CAAC,CAACE;gBACnB,IAAIA,KAAK,YAAY,EACnBD,aAAa,CAACC,KAAK,YAAY,CAAC,GAAGA,KAAK,KAAK;YAEjD;YAEA,IAAI,CAACC,UAAUF,aAAa,CAACG,UAAU,KAAK,CAACD,UAAUF,aAAa,CAACI,iBAAiB,GACpFJ,aAAa,CAACA,aAAa,CAACG,UAAU,CAAC,GAAGH,aAAa,CAACI,iBAAiB;YAG3E,MAAMC,cAAcjB,kBAAkB,MAAM,CAAsB,CAACkB,QAAQC;gBACzE,IAAIC,SAASR,eAAeO,MAAM,QAAQ,GACxC,OAAO;oBACL,GAAGD,MAAM;oBACT,GAAGG,kBAAkBF,MAAM;gBAC7B;gBAGF,OAAOD;YACT,GAAG,CAAC;YAEJ,OAAOD;QACT;QACA,OAAOZ;IACT;IACA,OAAO;QACL,GAAGV,IAAI;QACP,YAAYQ;IACd;AACF"}