{"version":3,"file":"pipeline/advanced/chart/pipes/reshape/reshapeWithHistogramEncoding.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/reshape/reshapeWithHistogramEncoding.ts"],"sourcesContent":["import {\n  BinCountMeasureId,\n  BinEndMeasureId,\n  BinPercentageMeasureId,\n  BinStartMeasureId,\n  dataReshapeByEncoding,\n  FoldMeasureId,\n  FoldMeasureName,\n  FoldMeasureValue,\n  Separator,\n  unfoldDimensions,\n} from 'src/dataReshape'\nimport { findAllMeasures } from 'src/pipeline/utils'\nimport type { AdvancedPipe, AdvancedVSeed, ColumnParallel, Dataset, Dimension, Encoding, FoldInfo } from 'src/types'\nimport { bin } from '@visactor/vdataset'\nimport { uniqueBy } from 'remeda'\nimport { getColorMeasureId } from 'src/pipeline/spec/chart/pipes/color/colorAdapter'\n\nexport const reshapeWithHistogramEncoding: AdvancedPipe = (advancedVSeed, context) => {\n  const result = { ...advancedVSeed }\n  const { vseed } = context\n  const { dataset, chartType } = vseed as ColumnParallel\n  const { encoding = {}, config } = advancedVSeed\n  const measures = advancedVSeed.reshapeMeasures ?? advancedVSeed.measures ?? []\n  const dimensions = advancedVSeed.reshapeDimensions ?? advancedVSeed.dimensions ?? []\n  const uniqDims = uniqueBy(dimensions, (item) => item.id)\n  const chartConfig = config?.[chartType as 'histogram']\n  const binCount = chartConfig?.binCount\n  const binStep = chartConfig?.binStep\n  const binValueType = chartConfig?.binValueType\n\n  let newDatasets: any[] = []\n  let foldInfo: FoldInfo = {\n    foldMap: {},\n    measureId: FoldMeasureId,\n    measureName: FoldMeasureName,\n    measureValue: FoldMeasureValue,\n    statistics: {\n      max: -Infinity,\n      min: Infinity,\n      sum: 0,\n      count: 0,\n      colorMin: Infinity,\n      colorMax: -Infinity,\n    },\n  }\n  let unfoldInfo: any = {}\n\n  const colorMeasureId = getColorMeasureId(advancedVSeed as AdvancedVSeed, vseed)\n  const allMeasures = findAllMeasures(measures)\n\n  if (encoding.value?.length) {\n    const valueField = encoding.value[0]\n    const m = allMeasures.find((m) => m.id === valueField)\n    const binData = bin(dataset, {\n      field: valueField,\n      groupField: [...(encoding.x ?? []), ...(encoding.color ?? [])] as string[],\n      bins: binCount,\n      step: binStep,\n      outputNames: {\n        x0: BinStartMeasureId,\n        x1: BinEndMeasureId,\n        count: BinCountMeasureId,\n        percentage: BinPercentageMeasureId,\n      },\n    }) as Dataset\n\n    binData.forEach((datum) => {\n      datum[FoldMeasureId] = valueField\n      datum[FoldMeasureName] = m?.alias ?? valueField\n      const valueNumber = binValueType === 'percentage' ? +datum[BinPercentageMeasureId] : +datum[BinCountMeasureId]\n      datum[FoldMeasureValue] = valueNumber\n      datum[valueField] = valueNumber\n      foldInfo.statistics.min = Math.min(foldInfo.statistics.min, valueNumber)\n      foldInfo.statistics.max = Math.max(foldInfo.statistics.max, valueNumber)\n      foldInfo.statistics.sum += valueNumber\n      foldInfo.statistics.count++\n    })\n    if (m?.id) {\n      foldInfo.foldMap[m?.id] = m?.alias\n    }\n\n    const res = unfoldDimensions(binData, uniqDims, encoding as Encoding, {\n      foldMeasureId: FoldMeasureId,\n      separator: Separator,\n      colorItemAsId: false,\n    })\n\n    res.dataset.forEach((d) => {\n      newDatasets.push(d)\n    })\n    unfoldInfo = res.unfoldInfo\n  } else if (encoding.x0?.length && encoding.x1?.length && encoding.y?.length) {\n    const res = dataReshapeByEncoding(\n      dataset,\n      uniqueBy(dimensions, (item: Dimension) => item.id),\n      findAllMeasures(measures)\n        .filter((item) => encoding.y?.includes(item.id))\n        .slice(0, 1),\n      encoding as Encoding,\n      {\n        colorItemAsId: false,\n        colorMeasureId,\n      },\n    )\n\n    res.dataset.forEach((datum) => {\n      datum[BinStartMeasureId] = datum[encoding.x0![0]]\n      datum[BinEndMeasureId] = datum[encoding.x1![0]]\n    })\n\n    newDatasets = res.dataset\n    foldInfo = res.foldInfo\n    unfoldInfo = res.unfoldInfo\n  }\n\n  return {\n    ...result,\n    dataset: newDatasets,\n    datasetReshapeInfo: [\n      {\n        id: String(chartType),\n        index: 0,\n        foldInfo,\n        unfoldInfo,\n      },\n    ],\n    dimensions,\n    measures,\n  }\n}\n"],"names":["reshapeWithHistogramEncoding","advancedVSeed","context","result","vseed","dataset","chartType","encoding","config","measures","dimensions","uniqDims","uniqueBy","item","chartConfig","binCount","binStep","binValueType","newDatasets","foldInfo","FoldMeasureId","FoldMeasureName","FoldMeasureValue","Infinity","unfoldInfo","colorMeasureId","getColorMeasureId","allMeasures","findAllMeasures","valueField","m","binData","bin","BinStartMeasureId","BinEndMeasureId","BinCountMeasureId","BinPercentageMeasureId","datum","valueNumber","Math","res","unfoldDimensions","Separator","d","dataReshapeByEncoding","String"],"mappings":"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"}