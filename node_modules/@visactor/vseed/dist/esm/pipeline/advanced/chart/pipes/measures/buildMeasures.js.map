{"version":3,"file":"pipeline/advanced/chart/pipes/measures/buildMeasures.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/measures/buildMeasures.ts"],"sourcesContent":["import type { AdvancedPipe, MeasureGroup, Measures, MeasureTree, VSeed } from 'src/types'\nimport { isMeasureTreeWithChildren, isMeasureTreeWithParentId, normalizeMeasureTree } from './utils'\nimport { isPivotChart } from 'src/pipeline/utils'\nimport { DEFAULT_PARENT_ID } from 'src/pipeline/utils/constant'\nimport { isValid } from '@visactor/vutils'\n\nexport const buildMeasures: AdvancedPipe = (advancedVSeed) => {\n  // 带Children的指标树, 不进行任何处理\n  if (isMeasureTreeWithChildren(advancedVSeed.measures)) {\n    advancedVSeed.measures = normalizeMeasureTree(advancedVSeed.measures as MeasureTree)\n    return advancedVSeed\n  }\n  // 带parentId的指标树, 转换为带children的指标树\n  if (isMeasureTreeWithParentId(advancedVSeed.measures)) {\n    advancedVSeed.measures = generateMeasuresByParentId(advancedVSeed.measures as Measures)\n    return advancedVSeed\n  }\n\n  /**\n   * 透视图表, 自动生成指标树\n   */\n  if (isPivotChart(advancedVSeed as VSeed)) {\n    advancedVSeed.measures = basicMeasuresToMeasureTree(advancedVSeed.measures as Measures)\n  }\n\n  return advancedVSeed\n}\n\nconst generateMeasuresByParentId = (measures: Measures): MeasureTree => {\n  const measureTree: MeasureGroup[] = []\n\n  measures.forEach((measure) => {\n    const parent = measureTree.find((item) => item.id === measure.parentId)\n    if (parent && 'children' in parent) {\n      parent.children = parent.children || []\n\n      if (parent.children.length > 0) {\n        parent.alias += `-${measure.alias ?? measure.id}`\n      }\n\n      parent.children.push(measure)\n    } else if (isValid(measure.parentId)) {\n      measureTree.push({\n        id: measure.parentId,\n        alias: measure.alias ?? measure.id,\n        children: [measure],\n      })\n    } else {\n      measureTree.push({\n        id: DEFAULT_PARENT_ID,\n        alias: measure.alias ?? measure.id, // 当分组只有单个指标的时候，分组alias 设置为该指标的别名或者id\n        children: [measure],\n      })\n    }\n  })\n\n  return measureTree\n}\n\nconst basicMeasuresToMeasureTree = (measures: Measures): MeasureTree => {\n  const id = measures.map((item) => item.id).join('-')\n  const alias = measures.map((item) => item.alias || item.id).join('-')\n  return [\n    {\n      id,\n      alias,\n      children: measures,\n    },\n  ]\n}\n"],"names":["buildMeasures","advancedVSeed","isMeasureTreeWithChildren","normalizeMeasureTree","isMeasureTreeWithParentId","generateMeasuresByParentId","isPivotChart","basicMeasuresToMeasureTree","measures","measureTree","measure","parent","item","isValid","DEFAULT_PARENT_ID","id","alias"],"mappings":";;;;AAMO,MAAMA,gBAA8B,CAACC;IAE1C,IAAIC,0BAA0BD,cAAc,QAAQ,GAAG;QACrDA,cAAc,QAAQ,GAAGE,qBAAqBF,cAAc,QAAQ;QACpE,OAAOA;IACT;IAEA,IAAIG,0BAA0BH,cAAc,QAAQ,GAAG;QACrDA,cAAc,QAAQ,GAAGI,2BAA2BJ,cAAc,QAAQ;QAC1E,OAAOA;IACT;IAKA,IAAIK,aAAaL,gBACfA,cAAc,QAAQ,GAAGM,2BAA2BN,cAAc,QAAQ;IAG5E,OAAOA;AACT;AAEA,MAAMI,6BAA6B,CAACG;IAClC,MAAMC,cAA8B,EAAE;IAEtCD,SAAS,OAAO,CAAC,CAACE;QAChB,MAAMC,SAASF,YAAY,IAAI,CAAC,CAACG,OAASA,KAAK,EAAE,KAAKF,QAAQ,QAAQ;QACtE,IAAIC,UAAU,cAAcA,QAAQ;YAClCA,OAAO,QAAQ,GAAGA,OAAO,QAAQ,IAAI,EAAE;YAEvC,IAAIA,OAAO,QAAQ,CAAC,MAAM,GAAG,GAC3BA,OAAO,KAAK,IAAI,CAAC,CAAC,EAAED,QAAQ,KAAK,IAAIA,QAAQ,EAAE,EAAE;YAGnDC,OAAO,QAAQ,CAAC,IAAI,CAACD;QACvB,OAAO,IAAIG,QAAQH,QAAQ,QAAQ,GACjCD,YAAY,IAAI,CAAC;YACf,IAAIC,QAAQ,QAAQ;YACpB,OAAOA,QAAQ,KAAK,IAAIA,QAAQ,EAAE;YAClC,UAAU;gBAACA;aAAQ;QACrB;aAEAD,YAAY,IAAI,CAAC;YACf,IAAIK;YACJ,OAAOJ,QAAQ,KAAK,IAAIA,QAAQ,EAAE;YAClC,UAAU;gBAACA;aAAQ;QACrB;IAEJ;IAEA,OAAOD;AACT;AAEA,MAAMF,6BAA6B,CAACC;IAClC,MAAMO,KAAKP,SAAS,GAAG,CAAC,CAACI,OAASA,KAAK,EAAE,EAAE,IAAI,CAAC;IAChD,MAAMI,QAAQR,SAAS,GAAG,CAAC,CAACI,OAASA,KAAK,KAAK,IAAIA,KAAK,EAAE,EAAE,IAAI,CAAC;IACjE,OAAO;QACL;YACEG;YACAC;YACA,UAAUR;QACZ;KACD;AACH"}