{"version":3,"file":"pipeline/advanced/chart/pipes/reshape/pivotReshapeWithBoxplotEncoding.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/reshape/pivotReshapeWithBoxplotEncoding.ts"],"sourcesContent":["import { boxplot } from '@visactor/vdataset'\nimport { uniqueBy } from 'remeda'\nimport {\n  FoldMeasureId,\n  FoldMeasureName,\n  LowerWhisker,\n  MedianMeasureId,\n  OutliersMeasureId,\n  Q1MeasureValue,\n  Q3MeasureValue,\n  Separator,\n  unfoldDimensions,\n  UpperWhisker,\n} from 'src/dataReshape'\nimport type {\n  AdvancedPipe,\n  ColumnParallel,\n  Dataset,\n  DatasetReshapeInfo,\n  Dimension,\n  Encoding,\n  MeasureGroup,\n} from 'src/types'\n\nexport const pivotReshapeWithBoxplotEncoding: AdvancedPipe = (advancedVSeed, context) => {\n  const result = { ...advancedVSeed }\n  const { vseed } = context\n  const { dataset, chartType } = vseed as ColumnParallel\n  const { encoding = {}, config } = advancedVSeed\n  const measures = advancedVSeed.reshapeMeasures ?? advancedVSeed.measures ?? []\n  const dimensions = advancedVSeed.reshapeDimensions ?? advancedVSeed.dimensions ?? []\n  const uniqDims = uniqueBy(dimensions, (item: Dimension) => item.id)\n  const chartConfig = config?.[chartType as 'boxPlot']\n  const whiskers = chartConfig?.whiskers\n\n  const measureGroups: MeasureGroup[] = []\n  if (measures) {\n    measures.forEach((measure: MeasureGroup) => {\n      if (measure.children && measure.children.length > 0) {\n        measureGroups.push(measure)\n      }\n    })\n  }\n\n  const rowColumnFields = uniqueBy(\n    dimensions.filter((dim: Dimension) => dim.encoding === 'row' || dim.encoding === 'column'),\n    (item: Dimension) => item.id,\n  )\n  const datasets: Dataset = []\n  const datasetReshapeInfo: DatasetReshapeInfo = []\n\n  measureGroups.forEach((measureGroup, index) => {\n    const subMeasures = measureGroup.children\n    if (!subMeasures) {\n      return\n    }\n    const groupId = measureGroup.id\n    let newDatasets: any[] = []\n    let foldInfo: any = {}\n    let unfoldInfo: any = {}\n    const validEncodingIds = (encoding.value || []).filter((id) => subMeasures.find((field) => field.id === id))\n\n    if (validEncodingIds.length) {\n      const boxPlotDataList: Dataset = []\n      validEncodingIds.forEach((f) => {\n        const m = subMeasures.find((m) => m.id === f)\n        const boxPlotData = boxplot(dataset, {\n          field: f,\n          groupField: [\n            ...(encoding.x ?? []),\n            ...(encoding.color ?? []),\n            ...rowColumnFields.map((item: Dimension) => item.id),\n          ] as string[],\n          whiskers,\n          outputNames: {\n            q1: Q1MeasureValue,\n            q3: Q3MeasureValue,\n            lowerWhisker: LowerWhisker,\n            upperWhisker: UpperWhisker,\n            median: MedianMeasureId,\n            outliers: OutliersMeasureId,\n          },\n        }) as Dataset\n\n        boxPlotData.forEach((datum) => {\n          datum[FoldMeasureId] = f\n          datum[FoldMeasureName] = m?.alias ?? f\n        })\n\n        boxPlotDataList.push(...boxPlotData)\n      })\n      const res = unfoldDimensions(boxPlotDataList, uniqDims, encoding as Encoding, {\n        foldMeasureId: FoldMeasureId,\n        separator: Separator,\n        colorItemAsId: false,\n      })\n\n      res.dataset.forEach((d) => {\n        newDatasets.push(d)\n      })\n      unfoldInfo = res.unfoldInfo\n    } else if (\n      encoding.q1?.length &&\n      encoding.q3?.length &&\n      encoding.min?.length &&\n      encoding.max?.length &&\n      encoding.median?.length\n    ) {\n      const res = unfoldDimensions(dataset, uniqDims, encoding as Encoding, {\n        foldMeasureId: FoldMeasureId,\n        separator: Separator,\n        colorItemAsId: false,\n      })\n\n      res.dataset.forEach((datum) => {\n        datum[UpperWhisker] = datum[encoding.max![0]]\n        datum[LowerWhisker] = datum[encoding.min![0]]\n        datum[Q1MeasureValue] = datum[encoding.q1![0]]\n        datum[Q3MeasureValue] = datum[encoding.q3![0]]\n        datum[MedianMeasureId] = datum[encoding.median![0]]\n      })\n\n      newDatasets = res.dataset\n      foldInfo = {}\n      unfoldInfo = res.unfoldInfo\n    }\n\n    const reshapeInfo = {\n      id: `${groupId}`,\n      index,\n      foldInfo,\n      unfoldInfo,\n    }\n    datasets.push(newDatasets)\n    datasetReshapeInfo.push(reshapeInfo)\n  })\n\n  return {\n    ...result,\n    dataset: datasets,\n    datasetReshapeInfo: datasetReshapeInfo,\n  }\n}\n"],"names":["pivotReshapeWithBoxplotEncoding","advancedVSeed","context","result","vseed","dataset","chartType","encoding","config","measures","dimensions","uniqDims","uniqueBy","item","chartConfig","whiskers","measureGroups","measure","rowColumnFields","dim","datasets","datasetReshapeInfo","measureGroup","index","subMeasures","groupId","newDatasets","foldInfo","unfoldInfo","validEncodingIds","id","field","boxPlotDataList","f","m","boxPlotData","boxplot","Q1MeasureValue","Q3MeasureValue","LowerWhisker","UpperWhisker","MedianMeasureId","OutliersMeasureId","datum","FoldMeasureId","FoldMeasureName","res","unfoldDimensions","Separator","d","reshapeInfo"],"mappings":"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"}