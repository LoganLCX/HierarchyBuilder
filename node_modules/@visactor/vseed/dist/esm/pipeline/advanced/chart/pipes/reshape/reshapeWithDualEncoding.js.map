{"version":3,"file":"pipeline/advanced/chart/pipes/reshape/reshapeWithDualEncoding.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/reshape/reshapeWithDualEncoding.ts"],"sourcesContent":["import { uniqueBy } from 'remeda'\nimport { dataReshapeByEncoding, FoldPrimaryMeasureValue, FoldSecondaryMeasureValue } from 'src/dataReshape'\nimport { getColorMeasureId } from 'src/pipeline/spec/chart/pipes'\nimport type {\n  AdvancedPipe,\n  AdvancedVSeed,\n  ColumnParallel,\n  Dataset,\n  Encoding,\n  FoldInfo,\n  MeasureGroup,\n  UnfoldInfo,\n} from 'src/types'\n\nexport const reshapeWithDualEncoding: AdvancedPipe = (advancedVSeed, context) => {\n  const result = { ...advancedVSeed }\n  const { vseed } = context\n  const { dataset } = vseed as ColumnParallel\n  const { encoding, chartType } = advancedVSeed\n  const measures = advancedVSeed.reshapeMeasures ?? advancedVSeed.measures ?? []\n  const dimensions = advancedVSeed.reshapeDimensions ?? advancedVSeed.dimensions ?? []\n\n  if (measures.length > 2) {\n    throw new Error('measures can not be more than 2 groups in dualAxis')\n  }\n  const foldInfoList: FoldInfo[] = []\n  const unfoldInfoList: UnfoldInfo[] = []\n\n  const datasets: Dataset[] = []\n  const primaryMeasures = measures[0] as MeasureGroup\n  const secondaryMeasures = (measures[1] || []) as MeasureGroup\n\n  if (primaryMeasures && primaryMeasures.children) {\n    const {\n      dataset: newDataset,\n      foldInfo,\n      unfoldInfo,\n    } = dataReshapeByEncoding(\n      dataset,\n      uniqueBy(dimensions, (item) => item.id),\n      uniqueBy(primaryMeasures.children, (item) => item.id),\n      encoding as Encoding,\n      {\n        colorItemAsId: false,\n        foldMeasureValue: FoldPrimaryMeasureValue,\n        colorMeasureId: getColorMeasureId(advancedVSeed as AdvancedVSeed, vseed),\n      },\n    )\n\n    datasets.push(newDataset)\n    foldInfoList.push(foldInfo)\n    unfoldInfoList.push(unfoldInfo)\n  }\n\n  if (secondaryMeasures && secondaryMeasures.children) {\n    const {\n      dataset: newDataset,\n      foldInfo,\n      unfoldInfo,\n    } = dataReshapeByEncoding(\n      dataset,\n      uniqueBy(dimensions, (item) => item.id),\n      uniqueBy(secondaryMeasures.children, (item) => item.id),\n      encoding as Encoding,\n      {\n        colorItemAsId: false,\n        foldMeasureValue: FoldSecondaryMeasureValue,\n        colorMeasureId: getColorMeasureId(advancedVSeed as AdvancedVSeed, vseed),\n      },\n    )\n\n    datasets.push(newDataset)\n    foldInfoList.push(foldInfo)\n    unfoldInfoList.push(unfoldInfo)\n  }\n\n  const unfoldInfo: UnfoldInfo = {\n    ...unfoldInfoList[0],\n    colorItems: unfoldInfoList.flatMap((d) => d.colorItems),\n    colorIdMap: unfoldInfoList.reduce((prev, cur) => ({ ...prev, ...cur.colorIdMap }), {}),\n  }\n\n  return {\n    ...result,\n    dataset: datasets,\n    datasetReshapeInfo: [\n      {\n        id: String(chartType),\n        index: 0,\n        foldInfo: foldInfoList[0],\n        foldInfoList: foldInfoList,\n        unfoldInfo: unfoldInfo,\n      },\n    ],\n  }\n}\n"],"names":["reshapeWithDualEncoding","advancedVSeed","context","result","vseed","dataset","encoding","chartType","measures","dimensions","Error","foldInfoList","unfoldInfoList","datasets","primaryMeasures","secondaryMeasures","newDataset","foldInfo","unfoldInfo","dataReshapeByEncoding","uniqueBy","item","FoldPrimaryMeasureValue","getColorMeasureId","FoldSecondaryMeasureValue","d","prev","cur","String"],"mappings":";;;AAcO,MAAMA,0BAAwC,CAACC,eAAeC;IACnE,MAAMC,SAAS;QAAE,GAAGF,aAAa;IAAC;IAClC,MAAM,EAAEG,KAAK,EAAE,GAAGF;IAClB,MAAM,EAAEG,OAAO,EAAE,GAAGD;IACpB,MAAM,EAAEE,QAAQ,EAAEC,SAAS,EAAE,GAAGN;IAChC,MAAMO,WAAWP,cAAc,eAAe,IAAIA,cAAc,QAAQ,IAAI,EAAE;IAC9E,MAAMQ,aAAaR,cAAc,iBAAiB,IAAIA,cAAc,UAAU,IAAI,EAAE;IAEpF,IAAIO,SAAS,MAAM,GAAG,GACpB,MAAM,IAAIE,MAAM;IAElB,MAAMC,eAA2B,EAAE;IACnC,MAAMC,iBAA+B,EAAE;IAEvC,MAAMC,WAAsB,EAAE;IAC9B,MAAMC,kBAAkBN,QAAQ,CAAC,EAAE;IACnC,MAAMO,oBAAqBP,QAAQ,CAAC,EAAE,IAAI,EAAE;IAE5C,IAAIM,mBAAmBA,gBAAgB,QAAQ,EAAE;QAC/C,MAAM,EACJ,SAASE,UAAU,EACnBC,QAAQ,EACRC,UAAU,EACX,GAAGC,sBACFd,SACAe,SAASX,YAAY,CAACY,OAASA,KAAK,EAAE,GACtCD,SAASN,gBAAgB,QAAQ,EAAE,CAACO,OAASA,KAAK,EAAE,GACpDf,UACA;YACE,eAAe;YACf,kBAAkBgB;YAClB,gBAAgBC,kBAAkBtB,eAAgCG;QACpE;QAGFS,SAAS,IAAI,CAACG;QACdL,aAAa,IAAI,CAACM;QAClBL,eAAe,IAAI,CAACM;IACtB;IAEA,IAAIH,qBAAqBA,kBAAkB,QAAQ,EAAE;QACnD,MAAM,EACJ,SAASC,UAAU,EACnBC,QAAQ,EACRC,UAAU,EACX,GAAGC,sBACFd,SACAe,SAASX,YAAY,CAACY,OAASA,KAAK,EAAE,GACtCD,SAASL,kBAAkB,QAAQ,EAAE,CAACM,OAASA,KAAK,EAAE,GACtDf,UACA;YACE,eAAe;YACf,kBAAkBkB;YAClB,gBAAgBD,kBAAkBtB,eAAgCG;QACpE;QAGFS,SAAS,IAAI,CAACG;QACdL,aAAa,IAAI,CAACM;QAClBL,eAAe,IAAI,CAACM;IACtB;IAEA,MAAMA,aAAyB;QAC7B,GAAGN,cAAc,CAAC,EAAE;QACpB,YAAYA,eAAe,OAAO,CAAC,CAACa,IAAMA,EAAE,UAAU;QACtD,YAAYb,eAAe,MAAM,CAAC,CAACc,MAAMC,MAAS;gBAAE,GAAGD,IAAI;gBAAE,GAAGC,IAAI,UAAU;YAAC,IAAI,CAAC;IACtF;IAEA,OAAO;QACL,GAAGxB,MAAM;QACT,SAASU;QACT,oBAAoB;YAClB;gBACE,IAAIe,OAAOrB;gBACX,OAAO;gBACP,UAAUI,YAAY,CAAC,EAAE;gBACzB,cAAcA;gBACd,YAAYO;YACd;SACD;IACH;AACF"}