{"version":3,"file":"pipeline/advanced/chart/pipes/measures/buildMeasuresForScatter.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/measures/buildMeasuresForScatter.ts"],"sourcesContent":["import type { AdvancedPipe, MeasureGroup, Measures, MeasureTree, Scatter, ScatterMeasures } from 'src/types'\nimport { isMeasureTreeWithParentId, isMeasureTreeWithChildren } from './utils'\nimport { clone } from 'remeda'\nimport { DEFAULT_PARENT_ID } from 'src/pipeline/utils/constant'\n\nexport const buildMeasuresForScatter: AdvancedPipe = (advancedVSeed, context) => {\n  const { vseed } = context as {\n    vseed: Scatter\n  }\n\n  // 带Children的指标树, 不进行任何处理\n  if (isMeasureTreeWithChildren(advancedVSeed.measures)) {\n    return advancedVSeed\n  }\n  // 带parentId的指标树, 转换为带children的指标树\n  if (isMeasureTreeWithParentId(advancedVSeed.measures)) {\n    advancedVSeed.measures = generateMeasuresByParentId(advancedVSeed.measures as Measures)\n    return advancedVSeed\n  }\n\n  /**\n   * 既不是带Children的指标树, 也不是带parentId的指标树, 则自动生成指标\n   */\n\n  const scatterMeasures = vseed.scatterMeasures\n    ? clone(vseed.scatterMeasures)\n    : basicMeasuresToScatterMeasures(advancedVSeed.measures || [])\n  advancedVSeed.measures = scatterMeasuresToMeasureTree(scatterMeasures)\n\n  return advancedVSeed\n}\n\nconst basicMeasuresToScatterMeasures = (basicMeasures: Measures): ScatterMeasures => {\n  const yMeasures: Measures = []\n  const xMeasures: Measures = []\n\n  for (let index = 0; index < basicMeasures.length; index++) {\n    const item = basicMeasures[index]\n    const encoding = Array.isArray(item.encoding) ? item.encoding : [item.encoding]\n    const isYAxis = encoding.includes('yAxis')\n    const isXAxis = encoding.includes('xAxis')\n\n    if (isYAxis) {\n      yMeasures.push(item)\n    } else if (isXAxis) {\n      xMeasures.push(item)\n    } else {\n      if (index !== 0) {\n        yMeasures.push(item)\n      } else {\n        xMeasures.push(item)\n      }\n    }\n  }\n\n  if (yMeasures.length === 0 && xMeasures.length > 0) {\n    yMeasures.push(xMeasures[0])\n  }\n\n  return [{ id: 'scatterMeasures', xMeasures, yMeasures }]\n}\n\nconst scatterMeasuresToMeasureTree = (scatterMeasures: ScatterMeasures): MeasureTree => {\n  const measureTree = scatterMeasures.map((item, index): MeasureGroup => {\n    const { id, xMeasures, yMeasures } = item\n    const groupChildren: MeasureGroup[] = []\n\n    let groupId: string = `${id}-`\n    if (xMeasures) {\n      const arrPrimaryMeasures = Array.isArray(xMeasures) ? xMeasures : [xMeasures]\n      const alias = arrPrimaryMeasures.map((item) => item.alias || item.id).toString()\n      groupId += alias\n      groupChildren.push({\n        id: `${index}-x`,\n        alias: arrPrimaryMeasures.map((item) => item.alias || item.id).toString(),\n        children: arrPrimaryMeasures,\n      })\n    }\n    if (yMeasures) {\n      const arrSecondaryMeasures = Array.isArray(yMeasures) ? yMeasures : [yMeasures]\n      const alias = arrSecondaryMeasures.map((item) => item.alias || item.id).toString()\n      groupId += alias\n      groupChildren.push({\n        id: `${index}-y`,\n        alias: arrSecondaryMeasures.map((item) => item.alias || item.id).toString(),\n        children: arrSecondaryMeasures,\n      })\n    }\n\n    return {\n      id: groupId,\n      alias: groupId,\n      children: groupChildren,\n    }\n  })\n\n  // 只有1个散点图, 仅返回2层, vchart 绘制散点图\n  if (scatterMeasures.length === 1) {\n    return measureTree[0].children || []\n  }\n\n  // 有多个散点图, 返回3层, pivot chart 绘制组合散点图\n  return measureTree\n}\n\nconst generateMeasuresByParentId = (measures: Measures) => {\n  const scatterMeasures: ScatterMeasures = []\n\n  measures.forEach((item) => {\n    const id = item.parentId || DEFAULT_PARENT_ID\n\n    if (!scatterMeasures.find((d) => d.id === id)) {\n      scatterMeasures.push({\n        id,\n        yMeasures: [],\n        xMeasures: [],\n      })\n    }\n    const scatterChart = scatterMeasures.find((d) => d.id === id)\n    if (!scatterChart || !Array.isArray(scatterChart.yMeasures) || !Array.isArray(scatterChart.xMeasures)) {\n      return\n    }\n\n    const encoding = Array.isArray(item.encoding) ? item.encoding : [item.encoding].filter(Boolean)\n    const isX = encoding.includes('xAxis')\n    const isY = encoding.includes('yAxis')\n    const isEmpty = !encoding.length\n    if (isY) {\n      scatterChart.yMeasures.push(item)\n    } else if (isX) {\n      scatterChart.xMeasures.push(item)\n    } else if (isEmpty) {\n      if (scatterChart.yMeasures.length !== 0) {\n        scatterChart.yMeasures.push(item)\n      } else {\n        scatterChart.xMeasures.push(item)\n      }\n    }\n  })\n\n  return scatterMeasuresToMeasureTree(scatterMeasures)\n}\n"],"names":["buildMeasuresForScatter","advancedVSeed","context","vseed","isMeasureTreeWithChildren","isMeasureTreeWithParentId","generateMeasuresByParentId","scatterMeasures","clone","basicMeasuresToScatterMeasures","scatterMeasuresToMeasureTree","basicMeasures","yMeasures","xMeasures","index","item","encoding","Array","isYAxis","isXAxis","measureTree","id","groupChildren","groupId","arrPrimaryMeasures","alias","arrSecondaryMeasures","measures","DEFAULT_PARENT_ID","d","scatterChart","Boolean","isX","isY","isEmpty"],"mappings":"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"}