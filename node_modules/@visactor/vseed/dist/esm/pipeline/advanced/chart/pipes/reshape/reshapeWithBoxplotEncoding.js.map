{"version":3,"file":"pipeline/advanced/chart/pipes/reshape/reshapeWithBoxplotEncoding.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/reshape/reshapeWithBoxplotEncoding.ts"],"sourcesContent":["import {\n  FoldMeasureId,\n  FoldMeasureName,\n  LowerWhisker,\n  MedianMeasureId,\n  OutliersMeasureId,\n  Q1MeasureValue,\n  Q3MeasureValue,\n  Separator,\n  unfoldDimensions,\n  UpperWhisker,\n} from 'src/dataReshape'\nimport { findAllMeasures } from 'src/pipeline/utils'\nimport type { AdvancedPipe, ColumnParallel, Dataset, Encoding } from 'src/types'\nimport { boxplot } from '@visactor/vdataset'\nimport { uniqueBy } from 'remeda'\n\nexport const reshapeWithBoxplotEncoding: AdvancedPipe = (advancedVSeed, context) => {\n  const result = { ...advancedVSeed }\n  const { vseed } = context\n  const { dataset, chartType } = vseed as ColumnParallel\n  const { encoding = {}, config } = advancedVSeed\n  const measures = advancedVSeed.reshapeMeasures ?? advancedVSeed.measures ?? []\n  const dimensions = advancedVSeed.reshapeDimensions ?? advancedVSeed.dimensions ?? []\n  const uniqDims = uniqueBy(dimensions, (item) => item.id)\n\n  const whiskers = config?.[chartType as 'boxPlot']?.whiskers\n\n  let newDatasets: any[] = []\n  let foldInfo: any = {}\n  let unfoldInfo: any = {}\n\n  const allMeasures = findAllMeasures(measures)\n\n  if (encoding.value?.length) {\n    const boxPlotDataList: Dataset = []\n    encoding.value.forEach((f) => {\n      const m = allMeasures.find((m) => m.id === f)\n      const boxPlotData = boxplot(dataset, {\n        field: f,\n        groupField: [...(encoding.x ?? []), ...(encoding.color ?? [])] as string[],\n        whiskers,\n        outputNames: {\n          q1: Q1MeasureValue,\n          q3: Q3MeasureValue,\n          lowerWhisker: LowerWhisker,\n          upperWhisker: UpperWhisker,\n          median: MedianMeasureId,\n          outliers: OutliersMeasureId,\n        },\n      }) as Dataset\n\n      boxPlotData.forEach((datum) => {\n        datum[FoldMeasureId] = f\n        datum[FoldMeasureName] = m?.alias ?? f\n      })\n      boxPlotDataList.push(...boxPlotData)\n    })\n    const res = unfoldDimensions(boxPlotDataList, uniqDims, encoding as Encoding, {\n      foldMeasureId: FoldMeasureId,\n      separator: Separator,\n      colorItemAsId: false,\n    })\n\n    res.dataset.forEach((d) => {\n      newDatasets.push(d)\n    })\n    unfoldInfo = res.unfoldInfo\n  } else if (\n    encoding.q1?.length &&\n    encoding.q3?.length &&\n    encoding.min?.length &&\n    encoding.max?.length &&\n    encoding.median?.length\n  ) {\n    const res = unfoldDimensions(dataset, uniqDims, encoding as Encoding, {\n      foldMeasureId: FoldMeasureId,\n      separator: Separator,\n      colorItemAsId: false,\n    })\n\n    res.dataset.forEach((datum) => {\n      datum[UpperWhisker] = datum[encoding.max![0]]\n      datum[LowerWhisker] = datum[encoding.min![0]]\n      datum[Q1MeasureValue] = datum[encoding.q1![0]]\n      datum[Q3MeasureValue] = datum[encoding.q3![0]]\n      datum[MedianMeasureId] = datum[encoding.median![0]]\n    })\n\n    newDatasets = res.dataset\n    foldInfo = {}\n    unfoldInfo = res.unfoldInfo\n  }\n\n  return {\n    ...result,\n    dataset: newDatasets,\n    datasetReshapeInfo: [\n      {\n        id: String(chartType),\n        index: 0,\n        foldInfo,\n        unfoldInfo,\n      },\n    ],\n    dimensions,\n    measures,\n  }\n}\n"],"names":["reshapeWithBoxplotEncoding","advancedVSeed","context","result","vseed","dataset","chartType","encoding","config","measures","dimensions","uniqDims","uniqueBy","item","whiskers","newDatasets","foldInfo","unfoldInfo","allMeasures","findAllMeasures","boxPlotDataList","f","m","boxPlotData","boxplot","Q1MeasureValue","Q3MeasureValue","LowerWhisker","UpperWhisker","MedianMeasureId","OutliersMeasureId","datum","FoldMeasureId","FoldMeasureName","res","unfoldDimensions","Separator","d","String"],"mappings":";;;;AAiBO,MAAMA,6BAA2C,CAACC,eAAeC;IACtE,MAAMC,SAAS;QAAE,GAAGF,aAAa;IAAC;IAClC,MAAM,EAAEG,KAAK,EAAE,GAAGF;IAClB,MAAM,EAAEG,OAAO,EAAEC,SAAS,EAAE,GAAGF;IAC/B,MAAM,EAAEG,WAAW,CAAC,CAAC,EAAEC,MAAM,EAAE,GAAGP;IAClC,MAAMQ,WAAWR,cAAc,eAAe,IAAIA,cAAc,QAAQ,IAAI,EAAE;IAC9E,MAAMS,aAAaT,cAAc,iBAAiB,IAAIA,cAAc,UAAU,IAAI,EAAE;IACpF,MAAMU,WAAWC,SAASF,YAAY,CAACG,OAASA,KAAK,EAAE;IAEvD,MAAMC,WAAWN,QAAQ,CAACF,UAAuB,EAAE;IAEnD,IAAIS,cAAqB,EAAE;IAC3B,IAAIC,WAAgB,CAAC;IACrB,IAAIC,aAAkB,CAAC;IAEvB,MAAMC,cAAcC,gBAAgBV;IAEpC,IAAIF,SAAS,KAAK,EAAE,QAAQ;QAC1B,MAAMa,kBAA2B,EAAE;QACnCb,SAAS,KAAK,CAAC,OAAO,CAAC,CAACc;YACtB,MAAMC,IAAIJ,YAAY,IAAI,CAAC,CAACI,IAAMA,EAAE,EAAE,KAAKD;YAC3C,MAAME,cAAcC,QAAQnB,SAAS;gBACnC,OAAOgB;gBACP,YAAY;uBAAKd,SAAS,CAAC,IAAI,EAAE;uBAAOA,SAAS,KAAK,IAAI,EAAE;iBAAE;gBAC9DO;gBACA,aAAa;oBACX,IAAIW;oBACJ,IAAIC;oBACJ,cAAcC;oBACd,cAAcC;oBACd,QAAQC;oBACR,UAAUC;gBACZ;YACF;YAEAP,YAAY,OAAO,CAAC,CAACQ;gBACnBA,KAAK,CAACC,cAAc,GAAGX;gBACvBU,KAAK,CAACE,gBAAgB,GAAGX,GAAG,SAASD;YACvC;YACAD,gBAAgB,IAAI,IAAIG;QAC1B;QACA,MAAMW,MAAMC,iBAAiBf,iBAAiBT,UAAUJ,UAAsB;YAC5E,eAAeyB;YACf,WAAWI;YACX,eAAe;QACjB;QAEAF,IAAI,OAAO,CAAC,OAAO,CAAC,CAACG;YACnBtB,YAAY,IAAI,CAACsB;QACnB;QACApB,aAAaiB,IAAI,UAAU;IAC7B,OAAO,IACL3B,SAAS,EAAE,EAAE,UACbA,SAAS,EAAE,EAAE,UACbA,SAAS,GAAG,EAAE,UACdA,SAAS,GAAG,EAAE,UACdA,SAAS,MAAM,EAAE,QACjB;QACA,MAAM2B,MAAMC,iBAAiB9B,SAASM,UAAUJ,UAAsB;YACpE,eAAeyB;YACf,WAAWI;YACX,eAAe;QACjB;QAEAF,IAAI,OAAO,CAAC,OAAO,CAAC,CAACH;YACnBA,KAAK,CAACH,aAAa,GAAGG,KAAK,CAACxB,SAAS,GAAI,CAAC,EAAE,CAAC;YAC7CwB,KAAK,CAACJ,aAAa,GAAGI,KAAK,CAACxB,SAAS,GAAI,CAAC,EAAE,CAAC;YAC7CwB,KAAK,CAACN,eAAe,GAAGM,KAAK,CAACxB,SAAS,EAAG,CAAC,EAAE,CAAC;YAC9CwB,KAAK,CAACL,eAAe,GAAGK,KAAK,CAACxB,SAAS,EAAG,CAAC,EAAE,CAAC;YAC9CwB,KAAK,CAACF,gBAAgB,GAAGE,KAAK,CAACxB,SAAS,MAAO,CAAC,EAAE,CAAC;QACrD;QAEAQ,cAAcmB,IAAI,OAAO;QACzBlB,WAAW,CAAC;QACZC,aAAaiB,IAAI,UAAU;IAC7B;IAEA,OAAO;QACL,GAAG/B,MAAM;QACT,SAASY;QACT,oBAAoB;YAClB;gBACE,IAAIuB,OAAOhC;gBACX,OAAO;gBACPU;gBACAC;YACF;SACD;QACDP;QACAD;IACF;AACF"}