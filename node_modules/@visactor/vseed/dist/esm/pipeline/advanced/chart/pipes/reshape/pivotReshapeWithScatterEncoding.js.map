{"version":3,"file":"pipeline/advanced/chart/pipes/reshape/pivotReshapeWithScatterEncoding.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/reshape/pivotReshapeWithScatterEncoding.ts"],"sourcesContent":["import { dataReshapeByEncoding, FoldXMeasureValue, FoldYMeasureValue } from 'src/dataReshape'\nimport { getColorMeasureId } from 'src/pipeline/spec/chart/pipes'\nimport { findAllMeasures, measureDepth } from 'src/pipeline/utils'\nimport type {\n  AdvancedPipe,\n  AdvancedVSeed,\n  ColumnParallel,\n  Dataset,\n  DatasetReshapeInfo,\n  Encoding,\n  FoldInfo,\n  MeasureGroup,\n  UnfoldInfo,\n} from 'src/types'\n\nexport const pivotReshapeWithScatterEncoding: AdvancedPipe = (advancedVSeed, context) => {\n  const result = { ...advancedVSeed }\n  const { vseed } = context\n  const { dataset } = vseed as ColumnParallel\n  const { encoding, chartType } = advancedVSeed\n  const measures = advancedVSeed.reshapeMeasures ?? advancedVSeed.measures ?? []\n  const dimensions = advancedVSeed.reshapeDimensions ?? advancedVSeed.dimensions ?? []\n  const allMeasures = findAllMeasures(measures)\n\n  const measureGroups: Array<MeasureGroup[]> = []\n\n  const depth = measureDepth(measures)\n  if (depth === 3) {\n    measures.forEach((measure: MeasureGroup) => {\n      measureGroups.push(measure.children as unknown as MeasureGroup[])\n    })\n  } else if (depth === 2) {\n    measureGroups.push(measures)\n  }\n\n  const datasetList: Dataset[] = []\n  const datasetReshapeInfo: DatasetReshapeInfo = []\n\n  measureGroups.forEach((measures: MeasureGroup[], index) => {\n    if (measures.length > 2) {\n      throw new Error('measures can not be more than 2 groups in scatter')\n    }\n\n    const foldInfoList: FoldInfo[] = []\n    const unfoldInfoList: UnfoldInfo[] = []\n\n    const datasets: Dataset[] = []\n    const xMeasures = measures[0]\n    const yMeasures = measures[1] || xMeasures\n\n    if (xMeasures && xMeasures.children) {\n      const {\n        dataset: newDataset,\n        foldInfo,\n        unfoldInfo,\n      } = dataReshapeByEncoding(dataset, dimensions, xMeasures.children, encoding as Encoding, {\n        foldMeasureValue: `${FoldXMeasureValue}${index}`,\n        colorItemAsId: true,\n        colorMeasureId: getColorMeasureId(advancedVSeed as AdvancedVSeed, vseed),\n        omitIds: allMeasures.map((item) => item.id),\n      })\n\n      datasets.push(newDataset)\n      foldInfoList.push(foldInfo)\n      unfoldInfoList.push(unfoldInfo)\n    }\n\n    if (yMeasures && yMeasures.children) {\n      const {\n        dataset: newDataset,\n        foldInfo,\n        unfoldInfo,\n      } = dataReshapeByEncoding(dataset, dimensions, yMeasures.children, encoding as Encoding, {\n        foldMeasureValue: `${FoldYMeasureValue}${index}`,\n        colorItemAsId: true,\n        colorMeasureId: getColorMeasureId(advancedVSeed as AdvancedVSeed, vseed),\n        omitIds: allMeasures.map((item) => item.id),\n      })\n\n      datasets.push(newDataset)\n      foldInfoList.push(foldInfo)\n      unfoldInfoList.push(unfoldInfo)\n    }\n\n    const unfoldInfo: UnfoldInfo = {\n      ...unfoldInfoList[0],\n      colorItems: unfoldInfoList.flatMap((d) => d.colorItems),\n      colorIdMap: unfoldInfoList.reduce((prev, cur) => ({ ...prev, ...cur.colorIdMap }), {}),\n    }\n\n    const reshapeInfo = {\n      id: `${chartType}-${index}`,\n      index,\n      foldInfo: foldInfoList[0],\n      foldInfoList: foldInfoList,\n      unfoldInfo: unfoldInfo,\n    }\n\n    datasetReshapeInfo.push(reshapeInfo)\n    datasetList.push(datasets[0].map((d, index) => ({ ...d, ...(datasets[1]?.[index] || {}) })))\n  })\n\n  return {\n    ...result,\n    dataset: datasetList,\n    datasetReshapeInfo: datasetReshapeInfo,\n  }\n}\n"],"names":["pivotReshapeWithScatterEncoding","advancedVSeed","context","result","vseed","dataset","encoding","chartType","measures","dimensions","allMeasures","findAllMeasures","measureGroups","depth","measureDepth","measure","datasetList","datasetReshapeInfo","index","Error","foldInfoList","unfoldInfoList","datasets","xMeasures","yMeasures","newDataset","foldInfo","unfoldInfo","dataReshapeByEncoding","FoldXMeasureValue","getColorMeasureId","item","FoldYMeasureValue","d","prev","cur","reshapeInfo"],"mappings":"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"}