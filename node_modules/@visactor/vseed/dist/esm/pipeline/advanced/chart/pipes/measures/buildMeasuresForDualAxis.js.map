{"version":3,"file":"pipeline/advanced/chart/pipes/measures/buildMeasuresForDualAxis.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/measures/buildMeasuresForDualAxis.ts"],"sourcesContent":["import type { AdvancedPipe, DualAxis, DualMeasures, MeasureGroup, Measures, MeasureTree } from 'src/types'\nimport { isMeasureTreeWithParentId, isMeasureTreeWithChildren } from './utils'\nimport { clone } from 'remeda'\nimport { DEFAULT_PARENT_ID } from 'src/pipeline/utils/constant'\n\nexport const buildMeasuresForDualAxis: AdvancedPipe = (advancedVSeed, context) => {\n  const { vseed } = context as {\n    vseed: DualAxis\n  }\n\n  // 带Children的指标树, 不进行任何处理\n  if (isMeasureTreeWithChildren(advancedVSeed.measures)) {\n    return advancedVSeed\n  }\n  // 带parentId的指标树, 转换为带children的指标树\n  if (isMeasureTreeWithParentId(advancedVSeed.measures)) {\n    advancedVSeed.measures = generateMeasuresByParentId(advancedVSeed.measures as Measures)\n    return advancedVSeed\n  }\n\n  /**\n   * 既不是带Children的指标树, 也不是带parentId的指标树, 则自动生成指标\n   */\n  const dualMeasures = vseed.dualMeasures\n    ? clone(vseed.dualMeasures)\n    : basicMeasuresToDualMeasures(advancedVSeed.measures || [])\n  advancedVSeed.measures = dualMeasuresToMeasureTree(dualMeasures)\n\n  return advancedVSeed\n}\n\nconst basicMeasuresToDualMeasures = (basicMeasures: Measures): DualMeasures => {\n  const primaryMeasures: Measures = []\n  const secondaryMeasures: Measures = []\n\n  for (let index = 0; index < basicMeasures.length; index++) {\n    const item = basicMeasures[index]\n    const encoding = Array.isArray(item.encoding) ? item.encoding : [item.encoding]\n    const isPrimaryYAxis = encoding.includes('primaryYAxis')\n    const isSecondaryYAxis = encoding.includes('secondaryYAxis')\n\n    if (isPrimaryYAxis) {\n      primaryMeasures.push(item)\n    } else if (isSecondaryYAxis) {\n      secondaryMeasures.push(item)\n    } else {\n      if (index === 0) {\n        primaryMeasures.push(item)\n      } else {\n        secondaryMeasures.push(item)\n      }\n    }\n  }\n\n  return [{ id: 'dualMeasures', primaryMeasures, secondaryMeasures }]\n}\n\nconst dualMeasuresToMeasureTree = (dualMeasures: DualMeasures): MeasureTree => {\n  const measureTree = dualMeasures.map((item, index): MeasureGroup => {\n    const { id, primaryMeasures, secondaryMeasures } = item\n    const groupChildren: MeasureGroup[] = []\n\n    let groupId: string = `${id}-`\n    if (primaryMeasures) {\n      const arrPrimaryMeasures = Array.isArray(primaryMeasures) ? primaryMeasures : [primaryMeasures]\n      const alias = arrPrimaryMeasures.map((item) => item.alias || item.id).toString()\n      groupId += alias\n      groupChildren.push({\n        id: `${index}-primary`,\n        alias: arrPrimaryMeasures.map((item) => item.alias || item.id).toString(),\n        children: arrPrimaryMeasures,\n      })\n    }\n    if (secondaryMeasures) {\n      const arrSecondaryMeasures = Array.isArray(secondaryMeasures) ? secondaryMeasures : [secondaryMeasures]\n      const alias = arrSecondaryMeasures.map((item) => item.alias || item.id).toString()\n      groupId += alias\n      groupChildren.push({\n        id: `${index}-secondary`,\n        alias: arrSecondaryMeasures.map((item) => item.alias || item.id).toString(),\n        children: arrSecondaryMeasures,\n      })\n    }\n\n    return {\n      id: groupId,\n      alias: groupId,\n      children: groupChildren,\n    }\n  })\n\n  // 只有1个双轴图, 仅返回2层, vchart 绘制双轴图\n  if (dualMeasures.length === 1) {\n    return measureTree[0].children || []\n  }\n\n  // 有多个双轴图, 返回3层, pivot chart 绘制组合双轴图\n  return measureTree\n}\n\nconst generateMeasuresByParentId = (measures: Measures) => {\n  const dualMeasures: DualMeasures = []\n\n  measures.forEach((item) => {\n    const id = item.parentId || DEFAULT_PARENT_ID\n    if (!dualMeasures.find((d) => d.id === id)) {\n      dualMeasures.push({\n        id,\n        primaryMeasures: [],\n        secondaryMeasures: [],\n      })\n    }\n\n    const dualChart = dualMeasures.find((d) => d.id === id)\n    if (!dualChart || !Array.isArray(dualChart.primaryMeasures) || !Array.isArray(dualChart.secondaryMeasures)) {\n      return\n    }\n\n    const encoding = Array.isArray(item.encoding) ? item.encoding : [item.encoding].filter(Boolean)\n    const isPrimary = encoding.includes('primaryYAxis')\n    const isSecondary = encoding.includes('secondaryYAxis')\n    const isEmpty = !item.encoding\n\n    if (isPrimary) {\n      dualChart.primaryMeasures.push(item)\n    } else if (isSecondary) {\n      dualChart.secondaryMeasures.push(item)\n    } else if (isEmpty) {\n      if (dualChart.primaryMeasures.length === 0) {\n        dualChart.primaryMeasures.push(item)\n      } else {\n        dualChart.secondaryMeasures.push(item)\n      }\n    }\n  })\n\n  return dualMeasuresToMeasureTree(dualMeasures)\n}\n"],"names":["buildMeasuresForDualAxis","advancedVSeed","context","vseed","isMeasureTreeWithChildren","isMeasureTreeWithParentId","generateMeasuresByParentId","dualMeasures","clone","basicMeasuresToDualMeasures","dualMeasuresToMeasureTree","basicMeasures","primaryMeasures","secondaryMeasures","index","item","encoding","Array","isPrimaryYAxis","isSecondaryYAxis","measureTree","id","groupChildren","groupId","arrPrimaryMeasures","alias","arrSecondaryMeasures","measures","DEFAULT_PARENT_ID","d","dualChart","Boolean","isPrimary","isSecondary","isEmpty"],"mappings":"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"}