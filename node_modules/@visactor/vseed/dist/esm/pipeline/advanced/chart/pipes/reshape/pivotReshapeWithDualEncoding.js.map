{"version":3,"file":"pipeline/advanced/chart/pipes/reshape/pivotReshapeWithDualEncoding.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/reshape/pivotReshapeWithDualEncoding.ts"],"sourcesContent":["import { uniqueBy } from 'remeda'\nimport { dataReshapeByEncoding, FoldPrimaryMeasureValue, FoldSecondaryMeasureValue } from 'src/dataReshape'\nimport { getColorMeasureId } from 'src/pipeline/spec/chart/pipes'\nimport { findAllMeasures, measureDepth } from 'src/pipeline/utils'\nimport type {\n  AdvancedPipe,\n  AdvancedVSeed,\n  ColumnParallel,\n  Dataset,\n  DatasetReshapeInfo,\n  Encoding,\n  FoldInfo,\n  MeasureGroup,\n  UnfoldInfo,\n} from 'src/types'\n\nexport const pivotReshapeWithDualEncoding: AdvancedPipe = (advancedVSeed, context) => {\n  const result = { ...advancedVSeed }\n  const { vseed } = context\n  const { dataset } = vseed as ColumnParallel\n  const { encoding, chartType } = advancedVSeed\n  const measures = advancedVSeed.reshapeMeasures ?? advancedVSeed.measures ?? []\n  const dimensions = advancedVSeed.reshapeDimensions ?? advancedVSeed.dimensions ?? []\n\n  const allMeasures = findAllMeasures(measures)\n  const datasetList: Dataset[] = []\n  const datasetReshapeInfo: DatasetReshapeInfo = []\n\n  const measureGroups: Array<MeasureGroup[]> = []\n\n  const depth = measureDepth(measures)\n  if (depth === 3) {\n    measures.forEach((measure: MeasureGroup) => {\n      measureGroups.push(measure.children as unknown as MeasureGroup[])\n    })\n  } else if (depth === 2) {\n    measureGroups.push(measures as unknown as MeasureGroup[])\n  }\n\n  measureGroups.forEach((measures: MeasureGroup[], index) => {\n    if (measures.length > 2) {\n      throw new Error('measures can not be more than 2 groups in dualAxis')\n    }\n\n    const foldInfoList: FoldInfo[] = []\n    const unfoldInfoList: UnfoldInfo[] = []\n\n    const datasets: Dataset[] = []\n    const primaryMeasures = measures[0]\n    const secondaryMeasures = measures[1] || []\n\n    if (primaryMeasures && primaryMeasures.children) {\n      const {\n        dataset: newDataset,\n        foldInfo,\n        unfoldInfo,\n      } = dataReshapeByEncoding(\n        dataset,\n        uniqueBy(dimensions, (item) => item.id),\n        uniqueBy(primaryMeasures.children, (item) => item.id),\n        encoding as Encoding,\n        {\n          colorItemAsId: false,\n          foldMeasureValue: `${FoldPrimaryMeasureValue}${index}`,\n          colorMeasureId: getColorMeasureId(advancedVSeed as AdvancedVSeed, vseed),\n          omitIds: allMeasures.map((item) => item.id),\n        },\n      )\n\n      datasets.push(newDataset)\n      foldInfoList.push(foldInfo)\n      unfoldInfoList.push(unfoldInfo)\n    }\n\n    if (secondaryMeasures && secondaryMeasures.children) {\n      const {\n        dataset: newDataset,\n        foldInfo,\n        unfoldInfo,\n      } = dataReshapeByEncoding(\n        dataset,\n        uniqueBy(dimensions, (item) => item.id),\n        uniqueBy(secondaryMeasures.children, (item) => item.id),\n        encoding as Encoding,\n        {\n          colorItemAsId: false,\n          foldMeasureValue: `${FoldSecondaryMeasureValue}${index}`,\n          colorMeasureId: getColorMeasureId(advancedVSeed as AdvancedVSeed, vseed),\n          omitIds: allMeasures.map((item) => item.id),\n        },\n      )\n\n      datasets.push(newDataset)\n      foldInfoList.push(foldInfo)\n      unfoldInfoList.push(unfoldInfo)\n    }\n\n    const unfoldInfo: UnfoldInfo = {\n      ...unfoldInfoList[0],\n      colorItems: unfoldInfoList.flatMap((d) => d.colorItems),\n      colorIdMap: unfoldInfoList.reduce((prev, cur) => ({ ...prev, ...cur.colorIdMap }), {}),\n    }\n\n    const reshapeInfo = {\n      id: `${chartType}-${index}`,\n      index,\n      foldInfo: foldInfoList[0],\n      foldInfoList: foldInfoList,\n      unfoldInfo: unfoldInfo,\n    }\n\n    datasetReshapeInfo.push(reshapeInfo)\n    datasetList.push(datasets.flat(2))\n  })\n\n  return {\n    ...result,\n    dataset: datasetList,\n    datasetReshapeInfo: datasetReshapeInfo,\n  }\n}\n"],"names":["pivotReshapeWithDualEncoding","advancedVSeed","context","result","vseed","dataset","encoding","chartType","measures","dimensions","allMeasures","findAllMeasures","datasetList","datasetReshapeInfo","measureGroups","depth","measureDepth","measure","index","Error","foldInfoList","unfoldInfoList","datasets","primaryMeasures","secondaryMeasures","newDataset","foldInfo","unfoldInfo","dataReshapeByEncoding","uniqueBy","item","FoldPrimaryMeasureValue","getColorMeasureId","FoldSecondaryMeasureValue","d","prev","cur","reshapeInfo"],"mappings":"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"}