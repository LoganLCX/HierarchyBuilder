{"version":3,"file":"pipeline/advanced/chart/pipes/reshape/pivotReshapeWithEncoding.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/reshape/pivotReshapeWithEncoding.ts"],"sourcesContent":["import { uniqueBy } from 'remeda'\nimport { dataReshapeByEncoding, FoldMeasureValue } from 'src/dataReshape'\nimport { getColorMeasureId } from 'src/pipeline/spec/chart/pipes'\nimport { findAllMeasures } from 'src/pipeline/utils'\nimport type {\n  AdvancedPipe,\n  AdvancedVSeed,\n  ColumnParallel,\n  Dataset,\n  DatasetReshapeInfo,\n  Encoding,\n  MeasureGroup,\n} from 'src/types'\n\nexport const pivotReshapeWithEncoding: AdvancedPipe = (advancedVSeed, context) => {\n  const result = { ...advancedVSeed }\n  const { vseed } = context\n  const { dataset } = vseed as ColumnParallel\n  const { encoding } = advancedVSeed\n  const measures = advancedVSeed.reshapeMeasures ?? advancedVSeed.measures ?? []\n  const dimensions = advancedVSeed.reshapeDimensions ?? advancedVSeed.dimensions ?? []\n\n  const allMeasures = findAllMeasures(measures)\n  const measureGroups: MeasureGroup[] = []\n  if (measures) {\n    measures.forEach((measure: MeasureGroup) => {\n      if (measure.children && measure.children.length > 0) {\n        measureGroups.push(measure)\n      }\n    })\n  }\n\n  const datasets: Dataset = []\n  const datasetReshapeInfo: DatasetReshapeInfo = []\n\n  measureGroups.forEach((measureGroup, index) => {\n    const measures = measureGroup.children\n    if (!measures) {\n      return\n    }\n    const groupId = measureGroup.id\n    const {\n      dataset: newSubDataset,\n      foldInfo,\n      unfoldInfo,\n    } = dataReshapeByEncoding(\n      dataset,\n      uniqueBy(dimensions, (item) => item.id),\n      uniqueBy(measures, (item) => item.id),\n      encoding as Encoding,\n      {\n        colorItemAsId: false,\n        foldMeasureValue: `${FoldMeasureValue}${groupId}`,\n        colorMeasureId: getColorMeasureId(advancedVSeed as AdvancedVSeed, vseed),\n        omitIds: allMeasures.map((item) => item.id),\n      },\n    )\n\n    const reshapeInfo = {\n      id: `${groupId}`,\n      index,\n      foldInfo,\n      unfoldInfo,\n    }\n    datasets.push(newSubDataset)\n    datasetReshapeInfo.push(reshapeInfo)\n  })\n\n  return {\n    ...result,\n    dataset: datasets,\n    datasetReshapeInfo: datasetReshapeInfo,\n  }\n}\n"],"names":["pivotReshapeWithEncoding","advancedVSeed","context","result","vseed","dataset","encoding","measures","dimensions","allMeasures","findAllMeasures","measureGroups","measure","datasets","datasetReshapeInfo","measureGroup","index","groupId","newSubDataset","foldInfo","unfoldInfo","dataReshapeByEncoding","uniqueBy","item","FoldMeasureValue","getColorMeasureId","reshapeInfo"],"mappings":";;;;AAcO,MAAMA,2BAAyC,CAACC,eAAeC;IACpE,MAAMC,SAAS;QAAE,GAAGF,aAAa;IAAC;IAClC,MAAM,EAAEG,KAAK,EAAE,GAAGF;IAClB,MAAM,EAAEG,OAAO,EAAE,GAAGD;IACpB,MAAM,EAAEE,QAAQ,EAAE,GAAGL;IACrB,MAAMM,WAAWN,cAAc,eAAe,IAAIA,cAAc,QAAQ,IAAI,EAAE;IAC9E,MAAMO,aAAaP,cAAc,iBAAiB,IAAIA,cAAc,UAAU,IAAI,EAAE;IAEpF,MAAMQ,cAAcC,gBAAgBH;IACpC,MAAMI,gBAAgC,EAAE;IACxC,IAAIJ,UACFA,SAAS,OAAO,CAAC,CAACK;QAChB,IAAIA,QAAQ,QAAQ,IAAIA,QAAQ,QAAQ,CAAC,MAAM,GAAG,GAChDD,cAAc,IAAI,CAACC;IAEvB;IAGF,MAAMC,WAAoB,EAAE;IAC5B,MAAMC,qBAAyC,EAAE;IAEjDH,cAAc,OAAO,CAAC,CAACI,cAAcC;QACnC,MAAMT,WAAWQ,aAAa,QAAQ;QACtC,IAAI,CAACR,UACH;QAEF,MAAMU,UAAUF,aAAa,EAAE;QAC/B,MAAM,EACJ,SAASG,aAAa,EACtBC,QAAQ,EACRC,UAAU,EACX,GAAGC,sBACFhB,SACAiB,SAASd,YAAY,CAACe,OAASA,KAAK,EAAE,GACtCD,SAASf,UAAU,CAACgB,OAASA,KAAK,EAAE,GACpCjB,UACA;YACE,eAAe;YACf,kBAAkB,GAAGkB,mBAAmBP,SAAS;YACjD,gBAAgBQ,kBAAkBxB,eAAgCG;YAClE,SAASK,YAAY,GAAG,CAAC,CAACc,OAASA,KAAK,EAAE;QAC5C;QAGF,MAAMG,cAAc;YAClB,IAAI,GAAGT,SAAS;YAChBD;YACAG;YACAC;QACF;QACAP,SAAS,IAAI,CAACK;QACdJ,mBAAmB,IAAI,CAACY;IAC1B;IAEA,OAAO;QACL,GAAGvB,MAAM;QACT,SAASU;QACT,oBAAoBC;IACtB;AACF"}