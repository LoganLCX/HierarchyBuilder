{"version":3,"file":"pipeline/advanced/chart/pipes/reshape/reshapeWithScatterEncoding.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/reshape/reshapeWithScatterEncoding.ts"],"sourcesContent":["import { uniqueBy } from 'remeda'\nimport {\n  dataReshapeByEncoding,\n  FoldXMeasureId,\n  FoldXMeasureValue,\n  FoldYMeasureId,\n  FoldYMeasureValue,\n} from 'src/dataReshape'\nimport { getColorMeasureId } from 'src/pipeline/spec/chart/pipes'\nimport type {\n  AdvancedPipe,\n  AdvancedVSeed,\n  ColumnParallel,\n  Dataset,\n  Encoding,\n  FoldInfo,\n  MeasureGroup,\n  UnfoldInfo,\n} from 'src/types'\n\nexport const reshapeWithScatterEncoding: AdvancedPipe = (advancedVSeed, context) => {\n  const result = { ...advancedVSeed }\n  const { vseed } = context\n  const { dataset } = vseed as ColumnParallel\n  const { encoding, chartType } = advancedVSeed\n  const measures = advancedVSeed.reshapeMeasures ?? advancedVSeed.measures ?? []\n  const dimensions = advancedVSeed.reshapeDimensions ?? advancedVSeed.dimensions ?? []\n\n  if (measures.length > 2) {\n    throw new Error('measures can not be more than 2 groups in scatter')\n  }\n  const foldInfoList: FoldInfo[] = []\n  const unfoldInfoList: UnfoldInfo[] = []\n\n  const datasets: Dataset[] = []\n  const xMeasures = measures[0] as MeasureGroup\n  const yMeasures = (measures[1] || xMeasures) as MeasureGroup\n\n  if (xMeasures && xMeasures.children) {\n    const {\n      dataset: newDataset,\n      foldInfo,\n      unfoldInfo,\n    } = dataReshapeByEncoding(\n      dataset,\n      uniqueBy(dimensions, (d) => d.id),\n      uniqueBy(xMeasures.children, (d) => d.id),\n      encoding as Encoding,\n      {\n        foldMeasureValue: FoldXMeasureValue,\n        foldMeasureId: FoldXMeasureId,\n        colorItemAsId: true,\n        colorMeasureId: getColorMeasureId(advancedVSeed as AdvancedVSeed, vseed),\n      },\n    )\n\n    datasets.push(newDataset)\n    foldInfoList.push(foldInfo)\n    unfoldInfoList.push(unfoldInfo)\n  }\n\n  if (yMeasures && yMeasures.children) {\n    const {\n      dataset: newDataset,\n      foldInfo,\n      unfoldInfo,\n    } = dataReshapeByEncoding(\n      datasets[0],\n      uniqueBy(dimensions, (d) => d.id),\n      uniqueBy(yMeasures.children, (d) => d.id),\n      encoding as Encoding,\n      {\n        foldMeasureValue: FoldYMeasureValue,\n        foldMeasureId: FoldYMeasureId,\n        colorItemAsId: true,\n        colorMeasureId: getColorMeasureId(advancedVSeed as AdvancedVSeed, vseed),\n      },\n    )\n\n    datasets[0] = newDataset\n    foldInfoList.push(foldInfo)\n    unfoldInfoList.push(unfoldInfo)\n  }\n\n  const unfoldInfo: UnfoldInfo = {\n    ...unfoldInfoList[0],\n    colorItems: unfoldInfoList.flatMap((d) => d.colorItems),\n    colorIdMap: unfoldInfoList.reduce((prev, cur) => ({ ...prev, ...cur.colorIdMap }), {}),\n  }\n\n  return {\n    ...result,\n    dataset: datasets[0],\n\n    datasetReshapeInfo: [\n      {\n        id: String(chartType),\n        index: 0,\n        foldInfo: foldInfoList[0],\n        foldInfoList: foldInfoList,\n        unfoldInfo: unfoldInfo,\n      },\n    ],\n  }\n}\n"],"names":["reshapeWithScatterEncoding","advancedVSeed","context","result","vseed","dataset","encoding","chartType","measures","dimensions","Error","foldInfoList","unfoldInfoList","datasets","xMeasures","yMeasures","newDataset","foldInfo","unfoldInfo","dataReshapeByEncoding","uniqueBy","d","FoldXMeasureValue","FoldXMeasureId","getColorMeasureId","FoldYMeasureValue","FoldYMeasureId","prev","cur","String"],"mappings":";;;AAoBO,MAAMA,6BAA2C,CAACC,eAAeC;IACtE,MAAMC,SAAS;QAAE,GAAGF,aAAa;IAAC;IAClC,MAAM,EAAEG,KAAK,EAAE,GAAGF;IAClB,MAAM,EAAEG,OAAO,EAAE,GAAGD;IACpB,MAAM,EAAEE,QAAQ,EAAEC,SAAS,EAAE,GAAGN;IAChC,MAAMO,WAAWP,cAAc,eAAe,IAAIA,cAAc,QAAQ,IAAI,EAAE;IAC9E,MAAMQ,aAAaR,cAAc,iBAAiB,IAAIA,cAAc,UAAU,IAAI,EAAE;IAEpF,IAAIO,SAAS,MAAM,GAAG,GACpB,MAAM,IAAIE,MAAM;IAElB,MAAMC,eAA2B,EAAE;IACnC,MAAMC,iBAA+B,EAAE;IAEvC,MAAMC,WAAsB,EAAE;IAC9B,MAAMC,YAAYN,QAAQ,CAAC,EAAE;IAC7B,MAAMO,YAAaP,QAAQ,CAAC,EAAE,IAAIM;IAElC,IAAIA,aAAaA,UAAU,QAAQ,EAAE;QACnC,MAAM,EACJ,SAASE,UAAU,EACnBC,QAAQ,EACRC,UAAU,EACX,GAAGC,sBACFd,SACAe,SAASX,YAAY,CAACY,IAAMA,EAAE,EAAE,GAChCD,SAASN,UAAU,QAAQ,EAAE,CAACO,IAAMA,EAAE,EAAE,GACxCf,UACA;YACE,kBAAkBgB;YAClB,eAAeC;YACf,eAAe;YACf,gBAAgBC,kBAAkBvB,eAAgCG;QACpE;QAGFS,SAAS,IAAI,CAACG;QACdL,aAAa,IAAI,CAACM;QAClBL,eAAe,IAAI,CAACM;IACtB;IAEA,IAAIH,aAAaA,UAAU,QAAQ,EAAE;QACnC,MAAM,EACJ,SAASC,UAAU,EACnBC,QAAQ,EACRC,UAAU,EACX,GAAGC,sBACFN,QAAQ,CAAC,EAAE,EACXO,SAASX,YAAY,CAACY,IAAMA,EAAE,EAAE,GAChCD,SAASL,UAAU,QAAQ,EAAE,CAACM,IAAMA,EAAE,EAAE,GACxCf,UACA;YACE,kBAAkBmB;YAClB,eAAeC;YACf,eAAe;YACf,gBAAgBF,kBAAkBvB,eAAgCG;QACpE;QAGFS,QAAQ,CAAC,EAAE,GAAGG;QACdL,aAAa,IAAI,CAACM;QAClBL,eAAe,IAAI,CAACM;IACtB;IAEA,MAAMA,aAAyB;QAC7B,GAAGN,cAAc,CAAC,EAAE;QACpB,YAAYA,eAAe,OAAO,CAAC,CAACS,IAAMA,EAAE,UAAU;QACtD,YAAYT,eAAe,MAAM,CAAC,CAACe,MAAMC,MAAS;gBAAE,GAAGD,IAAI;gBAAE,GAAGC,IAAI,UAAU;YAAC,IAAI,CAAC;IACtF;IAEA,OAAO;QACL,GAAGzB,MAAM;QACT,SAASU,QAAQ,CAAC,EAAE;QAEpB,oBAAoB;YAClB;gBACE,IAAIgB,OAAOtB;gBACX,OAAO;gBACP,UAAUI,YAAY,CAAC,EAAE;gBACzB,cAAcA;gBACd,YAAYO;YACd;SACD;IACH;AACF"}