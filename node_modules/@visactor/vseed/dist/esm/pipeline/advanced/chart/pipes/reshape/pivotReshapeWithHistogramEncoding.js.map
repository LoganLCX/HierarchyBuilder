{"version":3,"file":"pipeline/advanced/chart/pipes/reshape/pivotReshapeWithHistogramEncoding.js","sources":["../../../../../../../src/pipeline/advanced/chart/pipes/reshape/pivotReshapeWithHistogramEncoding.ts"],"sourcesContent":["import { bin } from '@visactor/vdataset'\nimport { uniqueBy } from 'remeda'\nimport {\n  BinCountMeasureId,\n  BinEndMeasureId,\n  BinPercentageMeasureId,\n  BinStartMeasureId,\n  dataReshapeByEncoding,\n  FoldMeasureId,\n  FoldMeasureName,\n  FoldMeasureValue,\n  Separator,\n  unfoldDimensions,\n} from 'src/dataReshape'\nimport { getColorMeasureId } from 'src/pipeline/spec/chart/pipes'\nimport type {\n  AdvancedPipe,\n  AdvancedVSeed,\n  ColumnParallel,\n  Dataset,\n  DatasetReshapeInfo,\n  Datum,\n  Dimension,\n  Encoding,\n  FoldInfo,\n  MeasureGroup,\n} from 'src/types'\n\nexport const pivotReshapeWithHistogramEncoding: AdvancedPipe = (advancedVSeed, context) => {\n  const result = { ...advancedVSeed }\n  const { vseed } = context\n  const { dataset, chartType } = vseed as ColumnParallel\n  const { encoding = {}, config } = advancedVSeed\n  const measures = advancedVSeed.reshapeMeasures ?? advancedVSeed.measures ?? []\n  const dimensions = advancedVSeed.reshapeDimensions ?? advancedVSeed.dimensions ?? []\n  const colorMeasureId = getColorMeasureId(advancedVSeed as AdvancedVSeed, vseed)\n  const uniqDims = uniqueBy(dimensions, (item: Dimension) => item.id)\n  const chartConfig = config?.[chartType as 'histogram']\n  const binCount = chartConfig?.binCount\n  const binStep = chartConfig?.binStep\n  const binValueType = chartConfig?.binValueType\n\n  const measureGroups: MeasureGroup[] = []\n  if (measures) {\n    measures.forEach((measure: MeasureGroup) => {\n      if (measure.children && measure.children.length > 0) {\n        measureGroups.push(measure)\n      }\n    })\n  }\n  const rowColumnFields = uniqueBy(\n    dimensions.filter((dim: Dimension) => dim.encoding === 'row' || dim.encoding === 'column'),\n    (item: Dimension) => item.id,\n  )\n\n  const datasets: Dataset = []\n  const datasetReshapeInfo: DatasetReshapeInfo = []\n\n  measureGroups.forEach((measureGroup, index) => {\n    const subMeasures = measureGroup.children\n    if (!subMeasures) {\n      return\n    }\n    const groupId = measureGroup.id\n\n    let newDatasets: any[] = []\n    let foldInfo: FoldInfo = {\n      foldMap: {},\n      measureId: FoldMeasureId,\n      measureName: FoldMeasureName,\n      measureValue: FoldMeasureValue,\n      statistics: {\n        max: -Infinity,\n        min: Infinity,\n        sum: 0,\n        count: 0,\n        colorMin: Infinity,\n        colorMax: -Infinity,\n      },\n    }\n    let unfoldInfo: any = {}\n\n    if (encoding.value?.length) {\n      const valueField = encoding.value[0]\n      const m = subMeasures.find((m) => m.id === valueField)\n      const binData = bin(dataset, {\n        field: valueField,\n        groupField: [...(encoding.x ?? []), ...(encoding.color ?? [])] as string[],\n        facetField: rowColumnFields.map((item: Dimension) => item.id),\n        bins: binCount,\n        step: binStep,\n        outputNames: {\n          x0: BinStartMeasureId,\n          x1: BinEndMeasureId,\n          count: BinCountMeasureId,\n          percentage: BinPercentageMeasureId,\n        },\n      }) as Dataset\n\n      binData.forEach((datum: Datum) => {\n        datum[FoldMeasureId] = valueField\n        datum[FoldMeasureName] = m?.alias ?? valueField\n        const valueNumber = binValueType === 'percentage' ? +datum[BinPercentageMeasureId] : +datum[BinCountMeasureId]\n        datum[FoldMeasureValue] = valueNumber\n        datum[valueField] = valueNumber\n\n        foldInfo.statistics.min = Math.min(foldInfo.statistics.min, valueNumber)\n        foldInfo.statistics.max = Math.max(foldInfo.statistics.max, valueNumber)\n        foldInfo.statistics.sum += valueNumber\n        foldInfo.statistics.count++\n      })\n      if (m?.id) {\n        foldInfo.foldMap[m?.id] = m?.alias\n      }\n\n      const res = unfoldDimensions(binData, uniqDims, encoding as Encoding, {\n        foldMeasureId: FoldMeasureId,\n        separator: Separator,\n        colorItemAsId: false,\n      })\n\n      res.dataset.forEach((d) => {\n        newDatasets.push(d)\n      })\n      unfoldInfo = res.unfoldInfo\n    } else if (encoding.x0?.length && encoding.x1?.length && encoding.y?.length) {\n      const res = dataReshapeByEncoding(\n        dataset,\n        uniqueBy(dimensions, (item: Dimension) => item.id),\n        subMeasures.filter((item) => encoding.y?.includes(item.id)).slice(0, 1),\n        encoding as Encoding,\n        {\n          colorItemAsId: false,\n          colorMeasureId,\n        },\n      )\n\n      res.dataset.forEach((datum) => {\n        datum[BinStartMeasureId] = datum[encoding.x0![0]]\n        datum[BinEndMeasureId] = datum[encoding.x1![0]]\n        datum[FoldMeasureId] = datum[encoding.y![0]]\n      })\n\n      newDatasets = res.dataset\n      foldInfo = res.foldInfo\n      unfoldInfo = res.unfoldInfo\n    }\n\n    const reshapeInfo = {\n      id: `${groupId}`,\n      index,\n      foldInfo,\n      unfoldInfo,\n    }\n    datasets.push(newDatasets)\n    datasetReshapeInfo.push(reshapeInfo)\n  })\n\n  return {\n    ...result,\n    dataset: datasets,\n    datasetReshapeInfo: datasetReshapeInfo,\n  }\n}\n"],"names":["pivotReshapeWithHistogramEncoding","advancedVSeed","context","result","vseed","dataset","chartType","encoding","config","measures","dimensions","colorMeasureId","getColorMeasureId","uniqDims","uniqueBy","item","chartConfig","binCount","binStep","binValueType","measureGroups","measure","rowColumnFields","dim","datasets","datasetReshapeInfo","measureGroup","index","subMeasures","groupId","newDatasets","foldInfo","FoldMeasureId","FoldMeasureName","FoldMeasureValue","Infinity","unfoldInfo","valueField","m","binData","bin","BinStartMeasureId","BinEndMeasureId","BinCountMeasureId","BinPercentageMeasureId","datum","valueNumber","Math","res","unfoldDimensions","Separator","d","dataReshapeByEncoding","reshapeInfo"],"mappings":"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"}