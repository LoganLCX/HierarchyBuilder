{"version":3,"file":"dataReshape/foldMeasures.js","sources":["../../../src/dataReshape/foldMeasures.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport type { Dataset, FoldInfo, Measures } from 'src/types'\nimport { ColorEncoding, ColorIdEncoding, ORIGINAL_DATA } from './constant'\nimport { omit } from 'remeda'\n\n/**\n * 折叠指定的指标\n * @description 合并指定的指标为1个, 无论多少个, 都能转换为1个, 取名为fold, 意为折叠后混合在一起.\n */\nexport const foldMeasures = (\n  dataset: Dataset,\n  measures: Measures,\n  options: {\n    measureId: string\n    measureName: string\n    measureValue: string\n    colorMeasureId?: string\n    allowEmptyFold?: boolean\n    omitIds?: string[]\n  },\n): {\n  dataset: Dataset\n  foldInfo: FoldInfo\n} => {\n  const { measureId, measureName, measureValue, colorMeasureId, allowEmptyFold = true, omitIds = [] } = options || {}\n\n  const foldInfo: FoldInfo = {\n    measureId,\n    measureName,\n    measureValue,\n    statistics: {\n      max: -Infinity,\n      min: Infinity,\n      sum: 0,\n      count: 0,\n      colorMin: Infinity,\n      colorMax: -Infinity,\n    },\n    foldMap: {},\n  }\n\n  if (!allowEmptyFold && measures.length === 0) {\n    return {\n      dataset,\n      foldInfo,\n    }\n  }\n\n  const result: Dataset = new Array(dataset.length * measures.length) as Dataset\n  let index = 0\n  const ids = measures.map((d) => d.id)\n  for (let i = 0; i < dataset.length; i++) {\n    for (let j = 0; j < measures.length; j++) {\n      const datum: Record<string, any> = omit({ ...dataset[i] }, [...ids, ...omitIds])\n\n      datum[ORIGINAL_DATA] = dataset[i]\n\n      const measure = measures[j]\n      const { id, alias } = measure\n\n      datum[id] = dataset[i][id] as unknown\n      datum[measureId] = id\n      datum[measureName] = alias || id\n      datum[measureValue] = dataset[i][id] as unknown\n\n      if (colorMeasureId) {\n        const value = (datum[ORIGINAL_DATA] as Record<string, string | number>)[colorMeasureId]\n        datum[ColorEncoding] = value\n        datum[ColorIdEncoding] = colorMeasureId\n\n        const valueNumber = Number(value)\n        foldInfo.statistics.colorMin = Math.min(foldInfo.statistics.colorMin, valueNumber)\n        foldInfo.statistics.colorMax = Math.max(foldInfo.statistics.colorMax, valueNumber)\n      }\n\n      const valueNumber = Number(datum[id])\n      foldInfo.statistics.min = Math.min(foldInfo.statistics.min, valueNumber)\n      foldInfo.statistics.max = Math.max(foldInfo.statistics.max, valueNumber)\n      foldInfo.statistics.sum += valueNumber\n      foldInfo.statistics.count++\n\n      foldInfo.foldMap[id] = alias\n      result[index++] = datum\n    }\n  }\n\n  return {\n    dataset: result,\n    foldInfo,\n  }\n}\n"],"names":["foldMeasures","dataset","measures","options","measureId","measureName","measureValue","colorMeasureId","allowEmptyFold","omitIds","foldInfo","Infinity","result","Array","index","ids","d","i","j","datum","omit","ORIGINAL_DATA","measure","id","alias","value","ColorEncoding","ColorIdEncoding","valueNumber","Number","Math"],"mappings":";;AASO,MAAMA,eAAe,CAC1BC,SACAC,UACAC;IAYA,MAAM,EAAEC,SAAS,EAAEC,WAAW,EAAEC,YAAY,EAAEC,cAAc,EAAEC,iBAAiB,IAAI,EAAEC,UAAU,EAAE,EAAE,GAAGN,WAAW,CAAC;IAElH,MAAMO,WAAqB;QACzBN;QACAC;QACAC;QACA,YAAY;YACV,KAAK,CAACK;YACN,KAAKA;YACL,KAAK;YACL,OAAO;YACP,UAAUA;YACV,UAAU,CAACA;QACb;QACA,SAAS,CAAC;IACZ;IAEA,IAAI,CAACH,kBAAkBN,AAAoB,MAApBA,SAAS,MAAM,EACpC,OAAO;QACLD;QACAS;IACF;IAGF,MAAME,SAAkB,IAAIC,MAAMZ,QAAQ,MAAM,GAAGC,SAAS,MAAM;IAClE,IAAIY,QAAQ;IACZ,MAAMC,MAAMb,SAAS,GAAG,CAAC,CAACc,IAAMA,EAAE,EAAE;IACpC,IAAK,IAAIC,IAAI,GAAGA,IAAIhB,QAAQ,MAAM,EAAEgB,IAClC,IAAK,IAAIC,IAAI,GAAGA,IAAIhB,SAAS,MAAM,EAAEgB,IAAK;QACxC,MAAMC,QAA6BC,KAAK;YAAE,GAAGnB,OAAO,CAACgB,EAAE;QAAC,GAAG;eAAIF;eAAQN;SAAQ;QAE/EU,KAAK,CAACE,cAAc,GAAGpB,OAAO,CAACgB,EAAE;QAEjC,MAAMK,UAAUpB,QAAQ,CAACgB,EAAE;QAC3B,MAAM,EAAEK,EAAE,EAAEC,KAAK,EAAE,GAAGF;QAEtBH,KAAK,CAACI,GAAG,GAAGtB,OAAO,CAACgB,EAAE,CAACM,GAAG;QAC1BJ,KAAK,CAACf,UAAU,GAAGmB;QACnBJ,KAAK,CAACd,YAAY,GAAGmB,SAASD;QAC9BJ,KAAK,CAACb,aAAa,GAAGL,OAAO,CAACgB,EAAE,CAACM,GAAG;QAEpC,IAAIhB,gBAAgB;YAClB,MAAMkB,QAASN,KAAK,CAACE,cAAkD,CAACd,eAAe;YACvFY,KAAK,CAACO,cAAc,GAAGD;YACvBN,KAAK,CAACQ,gBAAgB,GAAGpB;YAEzB,MAAMqB,cAAcC,OAAOJ;YAC3Bf,SAAS,UAAU,CAAC,QAAQ,GAAGoB,KAAK,GAAG,CAACpB,SAAS,UAAU,CAAC,QAAQ,EAAEkB;YACtElB,SAAS,UAAU,CAAC,QAAQ,GAAGoB,KAAK,GAAG,CAACpB,SAAS,UAAU,CAAC,QAAQ,EAAEkB;QACxE;QAEA,MAAMA,cAAcC,OAAOV,KAAK,CAACI,GAAG;QACpCb,SAAS,UAAU,CAAC,GAAG,GAAGoB,KAAK,GAAG,CAACpB,SAAS,UAAU,CAAC,GAAG,EAAEkB;QAC5DlB,SAAS,UAAU,CAAC,GAAG,GAAGoB,KAAK,GAAG,CAACpB,SAAS,UAAU,CAAC,GAAG,EAAEkB;QAC5DlB,SAAS,UAAU,CAAC,GAAG,IAAIkB;QAC3BlB,SAAS,UAAU,CAAC,KAAK;QAEzBA,SAAS,OAAO,CAACa,GAAG,GAAGC;QACvBZ,MAAM,CAACE,QAAQ,GAAGK;IACpB;IAGF,OAAO;QACL,SAASP;QACTF;IACF;AACF"}