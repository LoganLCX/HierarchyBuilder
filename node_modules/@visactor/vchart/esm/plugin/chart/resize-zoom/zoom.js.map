{"version":3,"sources":["../src/plugin/chart/resize-zoom/zoom.ts"],"names":[],"mappings":"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","file":"zoom.js","sourcesContent":["import type { IChartPlugin, IChartPluginService } from '../interface';\nimport { BasePlugin } from '../../base/base-plugin';\nimport { registerChartPlugin } from '../register';\nimport type { IPoint } from '../../../typings';\nimport { getDefaultTriggerEventByMode } from '../../../component/common/trigger/config';\n\nconst MIN_ZOOM = 0.1;\nconst MAX_ZOOM = 10;\n\nexport class ChartResizeZoomPlugin extends BasePlugin<IChartPluginService> implements IChartPlugin {\n  static readonly pluginType: 'chart';\n  static readonly specKey = 'resizeZoom';\n  static readonly type: string = 'ChartResizeZoomPlugin';\n  readonly type: string = 'ChartResizeZoomPlugin';\n\n  protected _container?: HTMLElement;\n  protected _triggerEvent?: string;\n  protected _minZoom?: number;\n  protected _maxZoom?: number;\n  protected _zoom: number = 1;\n  protected _rate?: number;\n\n  constructor() {\n    super(ChartResizeZoomPlugin.type);\n  }\n\n  onAfterInitChart(service: IChartPluginService, chartSpec: any) {\n    const chart = service.globalInstance;\n    const spec = chart.getSpec()?.[ChartResizeZoomPlugin.specKey] ?? { enabled: false };\n    if (spec.enabled !== true) {\n      return;\n    }\n    this._minZoom = spec.min ?? MIN_ZOOM;\n    this._maxZoom = spec.max ?? MAX_ZOOM;\n    this._rate = spec.rate ?? 0.1;\n    this._container = chart.getContainer();\n    this._triggerEvent = getDefaultTriggerEventByMode(service.globalInstance.getChart().getOption().mode).zoom;\n    if (this._container && this._triggerEvent) {\n      this._container.addEventListener(this._triggerEvent as keyof HTMLElementEventMap, this._onWheel as EventListener);\n    }\n  }\n\n  protected _onWheel = (e: WheelEvent) => {\n    e.preventDefault();\n    e.stopImmediatePropagation();\n\n    const zoom = Math.pow(1.005, -e.deltaY * Math.pow(16, e.deltaMode) * 0.2 * this._rate);\n    const center = { x: e.offsetX, y: e.offsetY };\n    this.zoom(zoom, center);\n  };\n\n  /**\n   * 缩放图表\n   * @param zoom 缩放比例\n   * @param pointerPos 缩放中心，即鼠标位置\n   */\n  zoom(zoom: number, pointerPos?: IPoint) {\n    const vchart = this.service.globalInstance;\n    if (!vchart) {\n      return;\n    }\n    const oldZoom = this._zoom;\n    let tempZoom = this._zoom * zoom;\n    if ((tempZoom <= this._minZoom && zoom < 1) || (tempZoom >= this._maxZoom && zoom > 1)) {\n      if (tempZoom <= this._minZoom && this._zoom > this._minZoom) {\n        tempZoom = this._minZoom;\n      } else if (tempZoom >= this._maxZoom && this._zoom < this._maxZoom) {\n        tempZoom = this._maxZoom;\n      } else {\n        return;\n      }\n    }\n\n    if (tempZoom === oldZoom) {\n      return;\n    }\n\n    const actualZoomRatio = tempZoom / oldZoom;\n    this._zoom = tempZoom;\n\n    vchart.resize(vchart.getCurrentSize().width * this._zoom, vchart.getCurrentSize().height * this._zoom);\n    // 滚动容器滚动， 保持当前鼠标位置在缩放后不变\n    if (pointerPos && this._container) {\n      const { scrollLeft, scrollTop } = this._container;\n      this._container.scrollLeft = scrollLeft + pointerPos.x * (actualZoomRatio - 1);\n      this._container.scrollTop = scrollTop + pointerPos.y * (actualZoomRatio - 1);\n    }\n  }\n\n  release(): void {\n    if (this._container && this._triggerEvent) {\n      this._container.removeEventListener(\n        this._triggerEvent as keyof HTMLElementEventMap,\n        this._onWheel as EventListener\n      );\n    }\n  }\n}\n\nexport const registerChartResizeZoomPlugin = () => {\n  registerChartPlugin(ChartResizeZoomPlugin);\n};\n"]}