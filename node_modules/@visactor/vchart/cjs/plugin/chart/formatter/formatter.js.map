{"version":3,"sources":["../src/plugin/chart/formatter/formatter.ts"],"names":[],"mappings":"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","file":"formatter.js","sourcesContent":["import { isFunction, isArray, TimeUtil, NumberUtil, numberSpecifierReg } from '@visactor/vutils';\nimport { BasePlugin } from '../../base/base-plugin';\nimport type { IChartPlugin, IChartPluginService } from '../interface';\nimport { Factory } from '../../../core/factory';\nimport { registerChartPlugin } from '../register';\n\nconst bracketReg = /\\{([^}]+)\\}/;\nconst bracketGReg = /\\{([^}]+)\\}/g;\nconst semicolonReg = /:/;\n\nexport class FormatterPlugin extends BasePlugin implements IChartPlugin {\n  static readonly pluginType: 'chart' = 'chart';\n  static readonly specKey = 'formatter';\n  static readonly type: string = 'formatterPlugin';\n  readonly type: string = 'formatterPlugin';\n\n  private readonly _timeModeFormat = {\n    utc: TimeUtil.getInstance().timeUTCFormat,\n    local: TimeUtil.getInstance().timeFormat\n  };\n\n  protected _spec: {\n    timeMode: 'utc' | 'local';\n    customFormatter: (specifier: string, text: string | number | string[] | number[], datum: any) => string | string[];\n    numericFormatter: (specifier: string, text: string | number | string[] | number[]) => string;\n    timeFormatter: (specifier: string, text: string | number | string[] | number[]) => string;\n  };\n\n  protected _formatter = this._format;\n  private _timeFormatter = this._timeModeFormat.local;\n  private _numericFormatter = NumberUtil.getInstance().format;\n\n  // used for optimize performance，avoiding repeatedly parsing same format template string,\n  private _numericSpecifier = NumberUtil.getInstance().formatter;\n  private _numericFormatterCache = new Map<string, any>();\n  private _isNumericFormatterCache = new Map<string, boolean>();\n\n  constructor() {\n    super(FormatterPlugin.type);\n  }\n\n  onInit(service: IChartPluginService, chartSpec: any) {\n    const { globalInstance } = service;\n    if (!globalInstance) {\n      return;\n    }\n    this._spec = chartSpec?.[FormatterPlugin.specKey] ?? {};\n    const { timeMode, customFormatter, numericFormatter, timeFormatter } = this._spec;\n\n    if (isFunction(customFormatter)) {\n      this._formatter = customFormatter;\n    } else {\n      this._formatter = this._format.bind(this);\n      if (isFunction(timeFormatter)) {\n        this._timeFormatter = timeFormatter;\n      } else if (timeMode && this._timeModeFormat[timeMode]) {\n        this._timeFormatter = this._timeModeFormat[timeMode];\n      }\n\n      if (numericFormatter) {\n        this._numericFormatter = numericFormatter;\n        this._numericSpecifier = null;\n        this._numericFormatterCache = null;\n      }\n    }\n    Factory.registerFormatter(this._formatter);\n  }\n\n  protected _format(text: string | number | string[] | number[], datum: any, formatter: string | string[]) {\n    if (isArray(text)) {\n      return text.map((t, i) => {\n        const f = isArray(formatter) ? formatter[i] : formatter;\n        return f ? this._formatSingleLine(t, datum, f) : t;\n      });\n    }\n\n    if (isArray(formatter)) {\n      return formatter.map(f => this._formatSingleLine(text, datum, f));\n    }\n    return this._formatSingleLine(text, datum, formatter);\n  }\n\n  protected _formatSingleLine(text: string | number, datum: any, formatter: string) {\n    let isTemplate;\n    if (this._isNumericFormatterCache) {\n      if (this._isNumericFormatterCache.get(formatter)) {\n        isTemplate = this._isNumericFormatterCache.get(formatter);\n      } else {\n        isTemplate = bracketReg.test(formatter);\n        this._isNumericFormatterCache.set(formatter, isTemplate);\n      }\n    }\n    if (isTemplate) {\n      const result = formatter.replace(bracketGReg, (match, key) => {\n        const hasFormatter = semicolonReg.test(key);\n        if (!hasFormatter) {\n          const value = datum[key.trim()];\n          return typeof value !== 'undefined' ? value : match;\n        }\n        const parts = key.split(':');\n        const value = datum[parts.shift()];\n        const valueFormatter = parts.join(':');\n        return this._formatSingleText(value, valueFormatter);\n      });\n      return result;\n    }\n    return this._formatSingleText(text, formatter);\n  }\n\n  protected _formatSingleText(text: string | number, formatter: string): string | number {\n    const isNumeric = numberSpecifierReg.test(formatter);\n    if (isNumeric && this._numericFormatter) {\n      // 内置的 formatter 逻辑，可以进行缓存性能优化\n      let numericFormat;\n      if (this._numericFormatterCache && this._numericSpecifier) {\n        if (this._numericFormatterCache.get(formatter)) {\n          numericFormat = this._numericFormatterCache.get(formatter);\n        } else {\n          numericFormat = this._numericSpecifier(formatter) as any;\n          this._numericFormatterCache.set(formatter, numericFormat);\n        }\n        return numericFormat(Number(text));\n      }\n      return this._numericFormatter(formatter, Number(text));\n    } else if (formatter.includes('%') && this._timeFormatter) {\n      return this._timeFormatter(formatter, text);\n    } else if (formatter.startsWith('calc(')) {\n      return this._calcFormatter(formatter, text);\n    }\n    return text;\n  }\n\n  /**\n   * 安全地计算数学表达式\n   * 支持基本运算：+ - * / ( ) 和变量 v\n   * @param formatter 格式字符串，如 \"calc(v*2+1)\"\n   * @param text 要计算的数值\n   * @returns 计算结果或原始文本（如果计算失败）\n   */\n  private _calcFormatter(formatter: string, text: string | number): string | number {\n    try {\n      // 提取表达式部分，移除 \"calc(\" 和 \")\"\n      const expression = formatter.slice(5, -1).replace(/v/g, String(text));\n\n      // 使用安全的数学表达式计算器\n      return this._calculateMathExpression(expression, text);\n    } catch (e) {\n      return text;\n    }\n  }\n\n  /**\n   * 安全的数学表达式计算器\n   * 支持操作符：+ - * / ( ) 和数字\n   * @param expression 数学表达式字符串\n   * @returns 计算结果\n   */\n  private _calculateMathExpression(expression: string, text: string | number): number | string {\n    // 移除所有空白字符\n    const cleanExpression = expression.replace(/\\s+/g, '');\n\n    // 验证表达式只包含允许的字符\n    if (!this._isValidMathExpression(cleanExpression)) {\n      return text;\n    }\n\n    // 使用 Function 构造函数创建安全的计算函数\n    // 这比 eval 安全，因为它只能访问提供的参数\n    try {\n      // 将表达式转换为安全的函数调用\n      // 例如: \"2+3*4\" -> \"return (2+3*4)\"\n      const safeFunction = new Function('return (' + cleanExpression + ')');\n      const result = safeFunction();\n\n      // 验证结果是否为有效数字\n      if (typeof result !== 'number' || isNaN(result) || !isFinite(result)) {\n        throw new Error('Invalid calculation result');\n      }\n\n      return result;\n    } catch (error) {\n      return text;\n    }\n  }\n\n  /**\n   * 验证数学表达式是否只包含允许的字符\n   * @param expression 要验证的表达式\n   * @returns 是否有效\n   */\n  private _isValidMathExpression(expression: string): boolean {\n    // 只允许数字、小数点、运算符和括号\n    const validPattern = /^[0-9+\\-*/().]+$/;\n    return validPattern.test(expression);\n  }\n\n  release() {\n    super.release();\n    this._format = null;\n    this._timeFormatter = null;\n    this._numericFormatter = null;\n    this._numericSpecifier = null;\n    this._numericFormatterCache = null;\n    this._isNumericFormatterCache = null;\n  }\n}\n\nexport const registerFormatPlugin = () => {\n  registerChartPlugin(FormatterPlugin);\n};\n"]}